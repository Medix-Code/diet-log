(()=>{var Fn="onboardingCompleted";function Vn(){let e=document.getElementById("onboarding-container");if(!e)return;if(!JSON.parse(localStorage.getItem(Fn)||"false"))e.classList.remove("hidden");else return;window.addEventListener("load",()=>{e.classList.add("onboarding-loaded")});let n=document.querySelectorAll(".onboarding-slide"),o=document.querySelectorAll(".nav-dot"),i=document.getElementById("onboarding-finish-btn"),s=document.getElementById("onboarding-skip-btn"),a=0;function r(E){n.forEach((v,b)=>{v.classList.toggle("active",b===E)}),o.forEach((v,b)=>{v.classList.toggle("active",b===E)})}function c(){a<n.length-1&&(a++,r(a),navigator.vibrate&&navigator.vibrate(10))}function d(){e.classList.add("hidden"),localStorage.setItem(Fn,JSON.stringify(!0)),navigator.vibrate&&navigator.vibrate([50,50,50])}e.addEventListener("click",E=>{E.target.closest("button, a, .nav-dot")||c()});let l=0;e.addEventListener("touchstart",E=>{l=E.changedTouches[0].screenX},{passive:!0}),e.addEventListener("touchend",E=>{E.changedTouches[0].screenX<l-50&&c()}),i.addEventListener("click",d),s.addEventListener("click",d)}var Gi="DietasDB";var H="dietas",Gn="dateIndex",P=null;function Hn(){return new Promise((e,t)=>{let n=indexedDB.open(Gi,1);n.onupgradeneeded=o=>{let i=o.target.result,s;i.objectStoreNames.contains(H)?s=o.target.transaction.objectStore(H):s=i.createObjectStore(H,{keyPath:"id"}),s.indexNames.contains(Gn)||s.createIndex(Gn,"date",{unique:!1})},n.onsuccess=o=>{P=o.target.result,P.onclose=()=>P=null,P.onerror=()=>P=null,P.onversionchange=()=>P.close(),e(P)},n.onerror=o=>t(o.target.error),n.onblocked=()=>t(new Error("IndexedDB bloquejat per una altra pestanya"))})}async function Xe(e="readonly"){return(P??(P=await Hn())).transaction(H,e)}function qe(e,t){return new Promise((n,o)=>{e.onsuccess=i=>n(i.target.result),e.onerror=i=>o(new Error(`${t}: ${i.target.error}`))})}function Ut(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onerror=()=>n(e.error),e.onabort=()=>n(e.error)})}async function kt(e){let t=await Xe("readwrite");return qe(t.objectStore(H).add(e),"No s'ha pogut afegir"),await Ut(t),e.id}async function $n(e){let t=await Xe("readwrite");return qe(t.objectStore(H).put(e),"No s'ha pogut actualitzar"),await Ut(t),e.id}async function Q(e){if(!e)return;let t=await Xe();return qe(t.objectStore(H).get(e),"Error obtenint dieta")}async function dt(){let e=await Xe();return qe(e.objectStore(H).getAll(),"Error llistant dietes")}async function jn(e){if(!e)return;let t=await Xe("readwrite");qe(t.objectStore(H).delete(e),"Error eliminant dieta"),await Ut(t)}async function Xn(){return P??(P=await Hn())}var le={DATE_INPUT:"date",DIET_TYPE_SELECT:"diet-type",TOP_BAR:".top-bar",FOOTER:"footer",EASTER_EGG_OVERLAY:".easter-egg-overlay",EASTER_EGG_ICON:".easter-egg-icon"},ut={LUNCH:"lunch",DINNER:"dinner"},qn={[ut.LUNCH]:"comida",[ut.DINNER]:"cena",DEFAULT:"dieta"},ce={TOP_BAR:3,FOOTER:2,TIMEOUT:1e3,ANIMATION_DURATION:1e3};function _e(e){if(!e)return;let t=document.body;if(!t)return;let n=t.dataset?.cspNonce||t.getAttribute("data-csp-nonce")||"";n&&!e.getAttribute("nonce")&&e.setAttribute("nonce",n)}function Wn(){let e=document.getElementById(le.DATE_INPUT);if(!e){console.warn("Utils: Input de data no trobat.");return}try{e.valueAsDate=new Date}catch(t){console.error("Error establint la data d'avui:",t)}}function Yn(e){return typeof e!="string"||!e?"":e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function De(e){return e?e.split(" ").map(t=>t.includes(".")?t.toUpperCase():t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):""}function Ft(){let e=new Date().getHours();return e>=6&&e<18?ut.LUNCH:ut.DINNER}function zn(){let e=document.getElementById(le.DIET_TYPE_SELECT);if(!e){console.warn("Utils: Select de tipus de dieta no trobat.");return}e.value=Ft()}function Vt(e,t){let n="Data inv\xE0lida";if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e))try{let i=e.split("-"),s=i[0].slice(-2);n=`${i[2]}/${i[1]}/${s}`}catch(i){console.error("Error formatant data:",i)}let o=qn[t]||qn.DEFAULT;return{ddmmaa:n,franjaText:o}}var A={topBarTaps:0,footerTaps:0,tapTimeoutId:null};function ve(){A.topBarTaps=0,A.footerTaps=0,A.tapTimeoutId&&(clearTimeout(A.tapTimeoutId),A.tapTimeoutId=null)}function Hi(){if(document.querySelector(le.EASTER_EGG_OVERLAY))return;let e=document.createElement("div");e.className=le.EASTER_EGG_OVERLAY.substring(1);let t=document.createElement("div");t.className=le.EASTER_EGG_ICON.substring(1),t.innerHTML='<img src="assets/icons/egg.svg" alt="Easter Egg">',e.appendChild(t),document.body.appendChild(e);let n=o=>{o.stopPropagation(),t.classList.add("clicked"),setTimeout(()=>e.remove(),ce.ANIMATION_DURATION)};e.addEventListener("click",n)}function Kn(){let e=document.querySelector(le.TOP_BAR),t=document.querySelector(le.FOOTER);if(!e||!t){console.warn("Easter Egg: No s'han trobat top bar o footer.");return}e.addEventListener("touchend",n=>{n.changedTouches.length===1?(A.topBarTaps++,A.tapTimeoutId&&clearTimeout(A.tapTimeoutId),A.tapTimeoutId=setTimeout(ve,ce.TIMEOUT),A.topBarTaps>ce.TOP_BAR&&ve()):ve()}),t.addEventListener("touchend",n=>{A.topBarTaps===ce.TOP_BAR&&n.changedTouches.length===1&&(A.footerTaps++,A.tapTimeoutId&&clearTimeout(A.tapTimeoutId),A.tapTimeoutId=setTimeout(ve,ce.TIMEOUT),A.footerTaps===ce.FOOTER?(Hi(),ve()):A.footerTaps>ce.FOOTER&&ve())})}function Gt(e,t){let n,o=function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)};return o.cancel=()=>clearTimeout(n),o}var L={CONTAINER_ID:"toast-container",TOAST_CLASS:"toast",DEFAULT_DURATION:3e3,DEFAULT_TYPE:"info",ALLOWED_TYPES:["info","success","error","warning"],MAX_QUEUE_SIZE:10,ANIMATION:{ENTER:"toast-enter",EXIT:"toast-exit"},UNDO_BTN_CLASS:"toast-undo-btn",DEFAULT_PRIORITY:1},h={queue:[],isVisible:!1,container:null,currentTimeout:null},$i=e=>e&&typeof e=="string"?e.replace(/[<>&]/g,""):"";function ji(e,t,n){if(!e||typeof e!="string"||!e.trim())throw new Error("El missatge del toast \xE9s obligatori i ha de ser una cadena no buida.");if(!L.ALLOWED_TYPES.includes(t))throw new Error(`Tipus de toast inv\xE0lid: ${t}. Ha de ser un de: ${L.ALLOWED_TYPES.join(", ")}`);if(!Number.isInteger(n)||n<0||n>6e4)throw new Error("La durada ha d'estar entre 0 i 60000\u202Fms.")}function Xi(){return!h.container&&(h.container=document.getElementById(L.CONTAINER_ID),!h.container)?(console.error(`[Toast] Contenidor '#${L.CONTAINER_ID}' no trobat.`),null):h.container}function Ht(e){h.currentTimeout&&(clearTimeout(h.currentTimeout),h.currentTimeout=null),e&&(e.classList.add(L.ANIMATION.EXIT),e.addEventListener("transitionend",()=>e.remove(),{once:!0})),h.isVisible=!1,Jn()}function qi({message:e,type:t,duration:n,options:o}){let i=Xi();if(!i)return;let s=document.createElement("div");s.className=`${L.TOAST_CLASS} ${t}`,s.setAttribute("role","alert"),s.setAttribute("aria-live","polite"),s.setAttribute("aria-atomic","true"),s.textContent=$i(e);let a=!0;if(o?.undoCallback instanceof Function){let r=document.createElement("button");r.type="button",r.className=L.UNDO_BTN_CLASS,r.textContent="Deshacer",r.setAttribute("aria-label","Deshacer la acci\xF3n"),r.addEventListener("click",()=>{a=!1;try{o.undoCallback()}finally{Ht(s)}}),s.appendChild(r)}i.appendChild(s),requestAnimationFrame(()=>{s.classList.add(L.ANIMATION.ENTER)}),h.currentTimeout=setTimeout(()=>{a&&o?.onExpire instanceof Function&&o.onExpire(),Ht(s)},n)}function Jn(){h.isVisible||h.queue.length===0||(h.isVisible=!0,h.queue.sort((e,t)=>t.priority-e.priority),qi(h.queue.shift()))}function u(e,t=L.DEFAULT_TYPE,n=L.DEFAULT_DURATION,o={}){ji(e,t,n);let i=o.priority??L.DEFAULT_PRIORITY,s={message:e,type:t,duration:n,priority:i,options:o};if(!(o.queueable!==!1)&&h.isVisible){if(h.container){let c=h.container.querySelector(`.${L.TOAST_CLASS}:not(.${L.ANIMATION.EXIT})`);c&&c.remove()}Ht()}h.queue.length>=L.MAX_QUEUE_SIZE&&h.queue.sort((c,d)=>c.priority-d.priority).shift();let r=h.queue.findIndex(c=>c.priority<i);r===-1?h.queue.push(s):h.queue.splice(r,0,s),Wi(),Jn()}function Wi(){let e="toast-undo-style";if(document.getElementById(e))return;let t=document.body.getAttribute("data-csp-nonce"),n=document.createElement("style");n.id=e,t&&n.setAttribute("nonce",t),n.textContent=`
    .${L.UNDO_BTN_CLASS} {
      margin-left: auto; 
      padding: 8px 12px; 
      background: none;
      border: none;
      border-radius: 4px; 
      cursor: pointer;     
      font-weight: 600;
      font-size: 0.875rem; 
      text-transform: uppercase; 
      letter-spacing: 0.08em; 
      color: inherit; 
      transition: background-color 0.2s ease;
    }
    .${L.UNDO_BTN_CLASS}:hover {
      background-color: rgba(255, 255, 255, 0.15); 
    }
  `,document.head.appendChild(n)}var $={DATE_INPUT:"date",DIET_TYPE_SELECT:"diet-type",SERVICE_NUMBER_PREFIX:"service-number-",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2"},no={INPUT_ERROR:"input-error"},Z={SERVICE_NUMBER_LENGTH:9,VEHICLE_MAX_LENGTH:6,PERSON_NAME_MAX_LENGTH:28,LOCATION_MAX_LENGTH:35,PERSON_NAME_ALLOWED_CHARS:/^[a-zA-Z\s'’áéíóúàèìòùäëïöüñçÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÑÇ]+$/u},Qn={PERSON_INPUT_GROUP:".input-with-icon"};function de(e){e?.classList.add(no.INPUT_ERROR)}function ye(e){e?.classList.remove(no.INPUT_ERROR)}function Zn(e){if(!e||e.length===0)return"";let t=e.map(n=>`S${n}`);return t.length===1?t[0]:t.length===2?t.join(" y "):`${t.slice(0,-1).join(", ")} y ${t[t.length-1]}`}function We(e){!e||e.dataset.errorListenerAttached||(e.addEventListener("input",()=>ye(e),{once:!0}),e.dataset.errorListenerAttached="true")}function eo(e,t,n,o){if(!e)return!0;ye(e);let i=e.value.trim(),s=!1;return i?/^\d+$/.test(i)?i.length!==Z.SERVICE_NUMBER_LENGTH&&(o.digitLength.push(t),s=!0):(o.nonNumeric.push(t),s=!0):n&&(o.emptyRequiredS1=!0,s=!0),s?(de(e),We(e),!1):!0}function Yi(e){let t=[];return e.nonNumeric.length>0&&t.push(`El n\xFAmero de servicio ${Zn(e.nonNumeric)} debe contener solo d\xEDgitos.`),e.digitLength.length>0&&t.push(`El n\xFAmero de servicio ${Zn(e.digitLength)} debe tener ${Z.SERVICE_NUMBER_LENGTH} d\xEDgitos.`),t}function mt(){let e=!0;return[document.getElementById($.DATE_INPUT),document.getElementById($.DIET_TYPE_SELECT)].filter(Boolean).forEach(n=>{ye(n),n.value.trim()||(de(n),We(n),e=!1)}),e}function Et(){let e={emptyRequiredS1:!1,nonNumeric:[],digitLength:[]},t=!0,n=document.getElementById(`${$.SERVICE_NUMBER_PREFIX}1`);if(!n)return console.error("Validation: No se ha encontrado el input para el servicio S1."),!1;t=eo(n,1,!0,e)&&t;for(let i=2;i<=4;i++){let s=document.getElementById(`${$.SERVICE_NUMBER_PREFIX}${i}`);s&&(t=eo(s,i,!1,e)&&t)}if(t)return!0;let o=Yi(e);return o.length>0&&u(o.join(`
`),"error"),!1}function _(e){return typeof e!="string"?"":e.trim().replace(/[<>&"'`]/g,"").trim()}function ft(e){return e?/^(?:2[0-3]|[01]?[0-9]):[0-5][0-9]$/.test(e):!0}function to(e,t,n,o){let i=e?.value.trim()||"";return i&&!Z.PERSON_NAME_ALLOWED_CHARS.test(i)?(de(t),!1):i.length>Z.PERSON_NAME_MAX_LENGTH?(de(t),o.push(`El nombre del ${n} no puede superar los ${Z.PERSON_NAME_MAX_LENGTH} caracteres.`),!1):!0}function oo(){let e=document.getElementById($.VEHICLE_INPUT),t=document.getElementById($.PERSON1_INPUT),n=document.getElementById($.PERSON2_INPUT),o=t?.closest(Qn.PERSON_INPUT_GROUP),i=n?.closest(Qn.PERSON_INPUT_GROUP);ye(e),ye(o),ye(i);let s=e?.value.trim()||"",a=t?.value.trim()||"",r=n?.value.trim()||"",c=!0,d=[];return s||(de(e),d.push("El campo Veh\xEDculo es obligatorio."),c=!1),c=to(t,o,"Conductor",d)&&c,c=to(n,i,"Ayudante",d)&&c,!a&&!r&&(de(o),de(i),d.push("Debe indicar al menos un Conductor o Ayudante."),c=!1),c||(We(e),We(t),We(n),u(d.join(`
`),"error")),c}function io(){let e=Z.PERSON_NAME_ALLOWED_CHARS,t=/^[^\x00-\x1F\x7F<>&"'`]*$/u;function n(l){let E=l.target.value;e.test(E)||(l.target.value=E.replace(/[^a-zA-Z\s'’áéíóúàèìòùäëïöüñçÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÑÇ.]/g,""))}function o(l){let E=l.target.value;t.test(E)||(l.target.value=E.replace(/[<>&"'`]/g,"").trim())}function i(l){l.key==="Enter"||l.key==="Tab"||l.ctrlKey||l.metaKey||l.altKey||l.key.length>1||e.test(l.key)||l.preventDefault()}function s(l){l.key==="Enter"||l.key==="Tab"||l.ctrlKey||l.metaKey||l.altKey||l.key.length>1||t.test(l.key)||l.preventDefault()}function a(l){}[document.getElementById($.PERSON1_INPUT),document.getElementById($.PERSON2_INPUT)].filter(Boolean).forEach(l=>{l.addEventListener("input",n),l.addEventListener("keypress",i)}),document.querySelectorAll(".service .origin, .service .destination").forEach(l=>{l.addEventListener("input",o),l.addEventListener("keypress",s)});function d(l){l.target.value.length>Z.VEHICLE_MAX_LENGTH&&(l.target.value=l.target.value.slice(0,Z.VEHICLE_MAX_LENGTH))}}var N={DADES:"dades",SERVEIS:"serveis"},ue={TAB_DADES:`tab-${N.DADES}`,TAB_SERVEIS:`tab-${N.SERVEIS}`,CONTENT_DADES:`${N.DADES}-tab-content`,CONTENT_SERVEIS:`${N.SERVEIS}-tab-content`,MAIN_CONTENT_AREA:"main-content"},Ae={ACTIVE_TAB:"active",ERROR_TAB:"error-tab"},so={MIN_DISTANCE:60,MAX_VERTICAL_RATIO:.5},Le=N.DADES,gt=0,$t=0,Xt=!0;function ro(){let e=document.getElementById(ue.TAB_DADES),t=document.getElementById(ue.TAB_SERVEIS);!e||!t||(e.addEventListener("click",()=>Ye(N.DADES)),t.addEventListener("click",()=>Ye(N.SERVEIS)),zi(),Ye(Le))}function qt(e){Xt=!!e}function Ye(e){if(Le===e&&document.scrollingElement.scrollTop!==0){window.scrollTo({top:0,behavior:"smooth"});return}if(Le===e||e!==N.DADES&&e!==N.SERVEIS)return;window.scrollTo({top:0,behavior:"auto"}),Le=e;let t=document.getElementById(ue.TAB_DADES),n=document.getElementById(ue.TAB_SERVEIS),o=document.getElementById(ue.CONTENT_DADES),i=document.getElementById(ue.CONTENT_SERVEIS);if(!t||!n||!o||!i)return;t.classList.remove(Ae.ERROR_TAB),n.classList.remove(Ae.ERROR_TAB);let s=e===N.DADES;t.classList.toggle(Ae.ACTIVE_TAB,s),n.classList.toggle(Ae.ACTIVE_TAB,!s),o.classList.toggle(Ae.ACTIVE_TAB,s),i.classList.toggle(Ae.ACTIVE_TAB,!s),t.setAttribute("aria-selected",s?"true":"false"),n.setAttribute("aria-selected",s?"false":"true"),e===N.SERVEIS&&typeof jt=="function"&&jt()}function zi(){let e=document.getElementById(ue.MAIN_CONTENT_AREA);e&&(e.addEventListener("touchstart",Ki,{passive:!0}),e.addEventListener("touchend",Ji,{passive:!0}))}function Ki(e){if(!Xt)return;let t=e.touches[0];gt=t.clientX,$t=t.clientY}function Ji(e){if(!Xt||gt===0||!e.changedTouches||e.changedTouches.length===0)return;let t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY,o=t-gt,i=n-$t;gt=0,$t=0,!(Math.abs(i)>Math.abs(o)*so.MAX_VERTICAL_RATIO)&&Math.abs(o)>so.MIN_DISTANCE&&(o>0?Le===N.SERVEIS&&Ye(N.DADES):Le===N.DADES&&Ye(N.SERVEIS))}var ee={MODAL:"signature-modal",CANVAS:"signature-canvas",CANCEL_BTN:"signature-cancel",ACCEPT_BTN:"signature-accept",SIGN_PERSON1_BTN:"sign-person1",SIGN_PERSON2_BTN:"sign-person2",TITLE:"signature-title"},Wt={MODAL_OPEN:"modal-open",SIGNED:"signed"},te={LINE_WIDTH:2,LINE_CAP:"round",STROKE_STYLE:"#000000",IMAGE_FORMAT:"image/png",DOUBLE_CLICK_TIMEOUT:300,DOUBLE_TAP_TIMEOUT:300,DOUBLE_TAP_MAX_DIST:20},ao={SIGNATURE_PENDING:"assets/icons/signature.svg",SIGNATURE_OK:"assets/icons/signature_ok.svg"},co={PERSON1:"Firma del conductor",PERSON2:"Firma del ayudante"},Yt=class{constructor(){this.signatureConductor="",this.signatureAjudant="",this.currentSignatureTarget=null,this.isDrawing=!1,this.canvasContext=null,this.signatureCanvasElement=null,this.signatureModalElement=null,this.signPerson1Button=null,this.signPerson2Button=null,this.hasUserDrawn=!1,this.lastTouchTime=0,this.lastTouchX=0,this.lastTouchY=0,this.clickCount=0,this.clickTimer=null}init(){this.signatureModalElement=document.getElementById(ee.MODAL),this.signatureCanvasElement=document.getElementById(ee.CANVAS);let t=document.getElementById(ee.CANCEL_BTN),n=document.getElementById(ee.ACCEPT_BTN);this.signPerson1Button=document.getElementById(ee.SIGN_PERSON1_BTN),this.signPerson2Button=document.getElementById(ee.SIGN_PERSON2_BTN),!(!this.signatureModalElement||!this.signatureCanvasElement||!t||!n||!this.signPerson1Button||!this.signPerson2Button)&&(this.resizeCanvas(),this.initCanvasEvents(),t.addEventListener("click",this.closeSignatureModal.bind(this)),n.addEventListener("click",this.acceptSignature.bind(this)),this.signPerson1Button.addEventListener("click",()=>this.openSignatureModal("person1")),this.signPerson2Button.addEventListener("click",()=>this.openSignatureModal("person2")),this.signatureModalElement.addEventListener("click",o=>{o.target===this.signatureModalElement&&this.closeSignatureModal()}),window.addEventListener("resize",this.debounce(this.resizeCanvas.bind(this),150)),document.addEventListener("keydown",o=>{o.key==="Escape"&&this.signatureModalElement.style.display==="block"&&this.closeSignatureModal()}),this.updateSignatureIcons())}debounce(t,n){let o;return(...i)=>{clearTimeout(o),o=setTimeout(()=>t.apply(this,i),n)}}resizeCanvas(){if(!this.signatureCanvasElement||!this.signatureCanvasElement.parentElement)return;let t=this.signatureCanvasElement.parentElement;this.canvasContext||(this.canvasContext=this.signatureCanvasElement.getContext("2d",{willReadFrequently:!0})),this.canvasContext&&(this.signatureCanvasElement.width=t.offsetWidth,this.signatureCanvasElement.height=t.offsetHeight,this.canvasContext.lineWidth=te.LINE_WIDTH,this.canvasContext.lineCap=te.LINE_CAP,this.canvasContext.strokeStyle=te.STROKE_STYLE)}clearCanvas(){!this.canvasContext||!this.signatureCanvasElement||(this.canvasContext.clearRect(0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height),this.hasUserDrawn=!1)}getEventCoordinates(t){if(!this.signatureCanvasElement)return{x:0,y:0};let n=this.signatureCanvasElement.getBoundingClientRect(),o,i;return t.touches&&t.touches.length>0?(o=t.touches[0].clientX,i=t.touches[0].clientY):(o=t.clientX,i=t.clientY),{x:o-n.left,y:i-n.top}}startDrawing(t){if(!this.canvasContext)return;this.isDrawing=!0,this.hasUserDrawn=!0,this.canvasContext.beginPath();let{x:n,y:o}=this.getEventCoordinates(t);this.canvasContext.moveTo(n,o)}draw(t){if(!this.isDrawing||!this.canvasContext)return;t.preventDefault();let{x:n,y:o}=this.getEventCoordinates(t);this.canvasContext.lineTo(n,o),this.canvasContext.stroke()}stopDrawing(){!this.isDrawing||!this.canvasContext||(this.isDrawing=!1)}handleCanvasClick(t){this.clickCount++,this.clickCount===1?this.clickTimer=setTimeout(()=>this.clickCount=0,te.DOUBLE_CLICK_TIMEOUT):this.clickCount===2&&(clearTimeout(this.clickTimer),this.clickCount=0,t.preventDefault(),this.clearCanvas())}handleCanvasTouchEnd(t){if(t.touches.length>0)return;let n=Date.now(),o=t.changedTouches[0];if(!o)return;let{x:i,y:s}=this.getEventCoordinates({clientX:o.clientX,clientY:o.clientY}),a=n-this.lastTouchTime,r=Math.abs(i-this.lastTouchX),c=Math.abs(s-this.lastTouchY);a<te.DOUBLE_TAP_TIMEOUT&&r<te.DOUBLE_TAP_MAX_DIST&&c<te.DOUBLE_TAP_MAX_DIST?(t.preventDefault(),this.clearCanvas(),this.lastTouchTime=0):(this.lastTouchTime=n,this.lastTouchX=i,this.lastTouchY=s)}initCanvasEvents(){this.signatureCanvasElement&&(this.signatureCanvasElement.addEventListener("mousedown",this.startDrawing.bind(this)),this.signatureCanvasElement.addEventListener("mousemove",this.draw.bind(this)),this.signatureCanvasElement.addEventListener("mouseup",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("mouseout",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("click",this.handleCanvasClick.bind(this)),this.signatureCanvasElement.addEventListener("touchstart",this.startDrawing.bind(this),{passive:!1}),this.signatureCanvasElement.addEventListener("touchmove",this.draw.bind(this),{passive:!1}),this.signatureCanvasElement.addEventListener("touchend",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("touchcancel",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("touchend",this.handleCanvasTouchEnd.bind(this),{passive:!1}))}openSignatureModal(t){if(!this.signatureModalElement||!this.canvasContext)return;qt(!1),this.currentSignatureTarget=t;let n=document.getElementById(ee.TITLE);n&&(n.textContent=t==="person1"?co.PERSON1:co.PERSON2),this.signatureModalElement.style.display="block",document.body.classList.add(Wt.MODAL_OPEN),this.resizeCanvas(),this.clearCanvas();let o=t==="person1"?this.signatureConductor:this.signatureAjudant;o&&this.drawSignatureFromDataUrl(o),document.getElementById(ee.ACCEPT_BTN)?.focus()}closeSignatureModal(){this.signatureModalElement&&(qt(!0),this.signatureModalElement.style.display="none",document.body.classList.remove(Wt.MODAL_OPEN),this.currentSignatureTarget=null,(this.currentSignatureTarget==="person1"?this.signPerson1Button:this.signPerson2Button)?.focus())}isCanvasEmpty(){if(!this.canvasContext||!this.signatureCanvasElement)return!0;try{return!new Uint32Array(this.canvasContext.getImageData(0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height).data.buffer).some(n=>n!==0)}catch{return!1}}acceptSignature(){if(!this.canvasContext||!this.signatureCanvasElement||!this.currentSignatureTarget)return;let t=this.isCanvasEmpty(),n=t?"":this.signatureCanvasElement.toDataURL(te.IMAGE_FORMAT),o=null;this.currentSignatureTarget==="person1"?(this.signatureConductor=n,o=this.signPerson1Button):this.currentSignatureTarget==="person2"&&(this.signatureAjudant=n,o=this.signPerson2Button),this.updateSignatureUI(o,!t),this.closeSignatureModal(),j()}drawSignatureFromDataUrl(t){if(!this.canvasContext||!t)return;let n=new Image;n.onload=()=>this.canvasContext.drawImage(n,0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height),n.onerror=()=>{},n.src=t}updateSignatureUI(t,n){if(!t)return;let o=t.querySelector(".icon");o&&(t.classList.toggle(Wt.SIGNED,n),o.src=n?ao.SIGNATURE_OK:ao.SIGNATURE_PENDING)}updateSignatureIcons(){this.updateSignatureUI(this.signPerson1Button,!!this.signatureConductor),this.updateSignatureUI(this.signPerson2Button,!!this.signatureAjudant)}getSignatureConductor(){return this.signatureConductor}getSignatureAjudant(){return this.signatureAjudant}setSignatureConductor(t){this.signatureConductor=t||"",this.updateSignatureUI(this.signPerson1Button,!!this.signatureConductor)}setSignatureAjudant(t){this.signatureAjudant=t||"",this.updateSignatureUI(this.signPerson2Button,!!this.signatureAjudant)}},ze=new Yt,lo=()=>ze.init(),pt=()=>ze.getSignatureConductor(),Tt=()=>ze.getSignatureAjudant(),ht=e=>ze.setSignatureConductor(e),St=e=>ze.setSignatureAjudant(e);function Qi(){let e="dietSalt",t=(o=16)=>Array.from({length:o},()=>Math.floor(Math.random()*256).toString(16).padStart(2,"0")).join(""),n=localStorage.getItem(e);if(!n){if(window.crypto?.getRandomValues){let o=crypto.getRandomValues(new Uint8Array(16));n=Array.from(o).map(i=>i.toString(16).padStart(2,"0")).join("")}else console.warn("[pseudoId] crypto.getRandomValues no disponible; usant Math.random() (menys segur, nom\xE9s mode desenvolupament)."),n=t(16);localStorage.setItem(e,n)}return n}async function Ne(e){if(!window.crypto?.subtle)return console.warn("[pseudoId] WebCrypto no disponible (context no segur). S\u2019usar\xE0 l\u2019ID en clar nom\xE9s en aquesta sessi\xF3."),e;let n=new TextEncoder().encode(Qi()+e),o=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(o)).map(i=>i.toString(16).padStart(2,"0")).join("")}var zt=new Intl.RelativeTimeFormat("es",{numeric:"auto"});function uo(e){if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("La data proporcionada no \xE9s v\xE0lida.");let t=Date.now()-e.getTime();if(t<0)return"en el futuro";let n=Math.round(t/1e3);if(n<45)return"hace unos segundos";if(n<90)return"hace un minuto";let o=Math.round(n/60);if(o<60)return zt.format(-o,"minute");let i=Math.round(o/60);if(i<24)return zt.format(-i,"hour");let s=Math.round(i/24);return zt.format(-s,"day")}var B={IS_INSTALLED:"pwa_isInstalled",PROMPT_DISMISSED_COUNT:"pwa_promptDismissedCount",NEVER_SHOW_AGAIN:"pwa_neverShowAgain",ACTION_TRIGGER_COUNT:"pwa_actionTriggerCount"},fo=2,mo=10,me=null,Kt=null,Jt=null,Ee=null,Eo=!1,Qt=(e,t=0)=>parseInt(localStorage.getItem(e)||String(t),10),Zt=e=>localStorage.getItem(e)==="true",fe=(e,t)=>localStorage.setItem(e,String(t));function go(){let e=window.matchMedia("(display-mode: standalone)").matches,t=window.navigator.standalone===!0;return e||t||Zt(B.IS_INSTALLED)}function Zi(e=!1){if(console.log("[PWA] Intentant mostrar el b\xE0ner d'instal\xB7laci\xF3..."),go()){console.log("[PWA] Bloquejat: L'app ja est\xE0 instal\xB7lada.");return}if(Zt(B.NEVER_SHOW_AGAIN)){console.log("[PWA] Bloquejat: L'usuari ha demanat no tornar a mostrar.");return}if(!me){console.log("[PWA] Bloquejat: No hi ha cap event d'instal\xB7laci\xF3 guardat.");return}if(!Ee){console.log("[PWA] Bloquejat: L'element HTML del b\xE0ner no s'ha trobat.");return}console.log("%c[PWA] Mostrant el b\xE0ner!","color: green; font-weight: bold;"),Ee.classList.add("visible"),Ee.classList.remove("hidden")}function po(){console.log("[PWA] Amagant el b\xE0ner."),Ee?.classList.remove("visible"),Ee?.classList.add("hidden")}function es(){console.log("[PWA] L'usuari ha descartat el b\xE0ner."),po();let e=Qt(B.PROMPT_DISMISSED_COUNT);e++,fe(B.PROMPT_DISMISSED_COUNT,e),console.log(`[PWA] Comptador de descartats actualitzat a: ${e}`),e>=fo&&(fe(B.NEVER_SHOW_AGAIN,!0),console.log("%c[PWA] S'ha assolit el l\xEDmit de descartats. No es tornar\xE0 a mostrar.","color: orange;"))}async function ts(){if(console.log("[PWA] L'usuari ha fet clic a 'Instal\xB7lar'."),!me){console.warn("[PWA] El bot\xF3 d'instal\xB7lar s'ha premut, per\xF2 no hi havia cap event guardat.");return}po();try{me.prompt();let{outcome:e}=await me.userChoice;console.log(`[PWA] Resultat de la decisi\xF3 de l'usuari: ${e}`),e==="accepted"?(fe(B.IS_INSTALLED,!0),fe(B.NEVER_SHOW_AGAIN,!0),console.log("%c[PWA] L'usuari ha acceptat la instal\xB7laci\xF3! :)","color: green; font-weight: bold;")):console.log("[PWA] L'usuari ha rebutjat la instal\xB7laci\xF3 des del di\xE0leg del navegador.")}catch(e){console.error("[PWA] Error durant el proc\xE9s de prompt d'instal\xB7laci\xF3:",e)}finally{me=null}}function ns(e){e.preventDefault(),me=e,console.log("%c[PWA] Event 'beforeinstallprompt' capturat i guardat.","color: blue;")}function To(){Eo||(console.log("[PWA] Inicialitzant el gestor d'instal\xB7laci\xF3..."),Ee=document.getElementById("install-prompt"),Kt=document.getElementById("install-button"),Jt=document.getElementById("dismiss-button"),Ee&&Kt&&Jt?(Kt.addEventListener("click",ts),Jt.addEventListener("click",es),console.log("[PWA] Botons del b\xE0ner d'instal\xB7laci\xF3 configurats.")):console.warn("[PWA] No s'han trobat tots els elements del b\xE0ner d'instal\xB7laci\xF3."),window.addEventListener("beforeinstallprompt",ns),window.matchMedia("(display-mode: standalone)").addEventListener("change",e=>{e.matches&&(console.log("[PWA] Detectat canvi a mode 'standalone'. Marcat com instal\xB7lat."),fe(B.IS_INSTALLED,!0),fe(B.NEVER_SHOW_AGAIN,!0))}),Eo=!0,console.log("[PWA] Gestor d'instal\xB7laci\xF3 inicialitzat correctament."))}function ho(){if(console.log("------------------------------------------"),console.log("[PWA] Comprovant si s'ha de mostrar el b\xE0ner despr\xE9s d'una acci\xF3..."),go()){console.log("[PWA Check] No es mostra: L'app ja est\xE0 instal\xB7lada.");return}if(Zt(B.NEVER_SHOW_AGAIN)){console.log("[PWA Check] No es mostra: L'usuari ha demanat no tornar a veure'l.");return}if(!me){console.log("[PWA Check] No es mostra: El navegador no ha ofert la possibilitat d'instal\xB7lar (deferredPrompt \xE9s nul).");return}let e=Qt(B.ACTION_TRIGGER_COUNT);e++,fe(B.ACTION_TRIGGER_COUNT,e),console.log(`[PWA] Comptador d'accions incrementat a: ${e}`);let t=Qt(B.PROMPT_DISMISSED_COUNT);console.log(`[PWA] Vegades que s'ha descartat el b\xE0ner: ${t}`);let n=e===1&&t===0||e>=mo&&t<fo;console.log(`[PWA] Es compleixen les condicions per mostrar? ${n}`),n?(setTimeout(()=>Zi(),1500),e>=mo):console.log("[PWA] No es mostra el b\xE0ner aquesta vegada."),console.log("------------------------------------------")}var So=!1;async function Io(){if(So)return;let e=document.createElement("script");return _e(e),e.src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js",new Promise((t,n)=>{e.onload=()=>{So=!0,t()},e.onerror=n,document.head.appendChild(e)})}var Ce={OUTER_MARGIN:55,INNER_PADDING:10},It={DADES_TAB:"tab-dades",SERVEIS_TAB:"tab-serveis"},ne={ERROR_TAB:"error-tab"},X={TEMPLATE_URLS:{DEFAULT:"./dieta.pdf"},SERVICE_Y_OFFSET:82,SIGNATURE_WIDTH:100,SIGNATURE_HEIGHT:50,WATERMARK_TEXT:"misdietas.com",DEFAULT_FILENAME:"dieta.pdf",SERVICE_NUMBER_COLOR:"#004aad",MODE_PREFIX_TEXT_COLOR:"#8B0000",MAX_SIGNATURE_NAME_LENGTH:31},m={general:{date:{x:155,y:732,size:16,color:"#000000"},vehicleNumber:{x:441,y:732,size:16,color:"#000000"},person1:{x:65,y:368,size:16,color:"#000000"},person2:{x:310,y:368,size:16,color:"#000000"}},service:{serviceNumber:{x:130,y:715,size:16,color:"#000000"},origin:{x:232,y:698,size:16,color:"#000000"},originTime:{x:441,y:698,size:16,color:"#000000"},destination:{x:232,y:683,size:16,color:"#000000"},destinationTime:{x:441,y:681,size:16,color:"#000000"},endTimeNormal:{x:441,y:665,size:16,color:"#000000"},endTimeModeText:{x:390,y:665,size:16,color:X.MODE_PREFIX_TEXT_COLOR},endTimeValueWhenPrefixed:{x:441,y:665,size:16,color:"#000000"}},signature:{conductor:{x:125,y:295,width:100,height:50},ayudante:{x:380,y:295,width:100,height:50}},notesSection:{title:{x:65,y:250,size:16,color:"#000000"},lineHeight:18,maxWidth:465,start:{x:65,y:230,size:16,color:"#333333"}},fixedText:{website:{x:250,y:20,size:6,color:"#EEEEEE"}}};function os(e){return!e||typeof e!="string"||e.trim()===""?"":e.split(/\s+/).filter(Boolean).map(t=>t.includes("-")?t.split("-").map(n=>n?n.charAt(0).toUpperCase()+n.slice(1).toLowerCase():"").join("-"):t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")}function is(e){if(!e||typeof e!="string")return{r:0,g:0,b:0};let t=e.replace("#","");if(t.length!==6)return{r:0,g:0,b:0};let n=parseInt(t,16);return isNaN(n)?{r:0,g:0,b:0}:{r:n>>16&255,g:n>>8&255,b:n&255}}function en(e){if(!e||!/^\d{4}-\d{2}-\d{2}$/.test(e))return"";let[t,n,o]=e.split("-");return`${o}/${n}/${t}`}function ss(){return X.TEMPLATE_URLS.DEFAULT}function rs(e,t){let n=document.getElementById(It.DADES_TAB),o=document.getElementById(It.SERVEIS_TAB);n?.classList.remove(ne.ERROR_TAB),o?.classList.remove(ne.ERROR_TAB);let i="";!e&&!t?(i="Completa els camps obligatoris a Dades i Serveis.",n?.classList.add(ne.ERROR_TAB),o?.classList.add(ne.ERROR_TAB)):e?(i="Completa els camps obligatoris a Serveis.",o?.classList.add(ne.ERROR_TAB)):(i="Completa els camps obligatoris a Dades.",n?.classList.add(ne.ERROR_TAB)),i&&u(i,"error")}function vo(e,t){let n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(n),500)}async function _o(e,t){if(!e||!Array.isArray(t))throw new Error("Dades inv\xE0lides.");if(!window.PDFLib)throw new Error("PDFLib no carregada.");let{PDFDocument:n,StandardFonts:o,rgb:i}=window.PDFLib,s=ss(),a=await fetch(s).then(f=>f.arrayBuffer()),r=await n.load(a),c=await r.embedFont(o.Helvetica),d=r.getPages()[0],l=f=>{let{r:G,g,b:O}=is(f);return i(G/255,g/255,O/255)};Object.entries(m.general).forEach(([f,G])=>{let g=e[f]||"";f==="date"&&(g=en(g)),f==="vehicleNumber"&&(g=g.toUpperCase()),(f==="person1"||f==="person2")&&(g=os(g),g.length>X.MAX_SIGNATURE_NAME_LENGTH&&(g=g.slice(0,X.MAX_SIGNATURE_NAME_LENGTH-3)+"...")),d.drawText(g,{...G,font:c,color:l(G.color)})}),t.forEach((f,G)=>{let g=G*X.SERVICE_Y_OFFSET,O=f.mode||"3.6";d.drawText(f.serviceNumber||"",{...m.service.serviceNumber,y:m.service.serviceNumber.y-g,font:c,color:l(X.SERVICE_NUMBER_COLOR)}),d.drawText(f.origin||"",{...m.service.origin,y:m.service.origin.y-g,font:c,color:l(m.service.origin.color)}),d.drawText(f.originTime||"",{...m.service.originTime,y:m.service.originTime.y-g,font:c,color:l(m.service.originTime.color)}),O==="3.6"&&(d.drawText(f.destination||"",{...m.service.destination,y:m.service.destination.y-g,font:c,color:l(m.service.destination.color)}),d.drawText(f.destinationTime||"",{...m.service.destinationTime,y:m.service.destinationTime.y-g,font:c,color:l(m.service.destinationTime.color)}));let Ie=(f.endTime||"").trim();O!=="3.6"&&Ie?(d.drawText(O,{...m.service.endTimeModeText,y:m.service.endTimeModeText.y-g,font:c,color:l(m.service.endTimeModeText.color)}),d.drawText(Ie,{...m.service.endTimeValueWhenPrefixed,y:m.service.endTimeValueWhenPrefixed.y-g,font:c,color:l(m.service.endTimeValueWhenPrefixed.color)})):d.drawText(Ie,{...m.service.endTimeNormal,y:m.service.endTimeNormal.y-g,font:c,color:l(m.service.endTimeNormal.color)})});let E=async(f,G)=>{if(typeof f=="string"&&f.startsWith("data:image/png;base64,")&&f.length>22)try{let O=await r.embedPng(f);d.drawImage(O,{...G})}catch(O){console.warn(`No s'ha pogut incrustar una signatura. Error: ${O.message}`)}};await Promise.all([E(e.signatureConductor,m.signature.conductor),E(e.signatureAjudant,m.signature.ayudante)]);let v=d.getWidth(),b=Ce.OUTER_MARGIN+Ce.INNER_PADDING,wi=v-(Ce.OUTER_MARGIN+Ce.INNER_PADDING),Pt=t.map(f=>({num:f.serviceNumber||"",text:(f.notes||"").trim()})).filter(f=>f.num&&f.text);if(Pt.length){d.drawLine({start:{x:Ce.OUTER_MARGIN,y:275},end:{x:v-Ce.OUTER_MARGIN,y:275},thickness:.5,color:i(.8,.8,.8)});let G=Pt.length===1?"Observaci\xF3":"Observacions";d.drawText(G,{...m.notesSection.title,font:c,color:l(m.notesSection.title.color)});let g=m.notesSection.start.y,O=m.notesSection.start.size,Ie=m.notesSection.lineHeight,Ui=l(m.notesSection.start.color);Pt.forEach(({num:ki,text:Fi})=>{if(g<40)return;let Un=`Servei ${ki}: `;d.drawText(Un,{x:b,y:g,font:c,size:O,color:l(X.SERVICE_NUMBER_COLOR)});let Vi=c.widthOfTextAtSize(Un,O),lt=b+Vi;Fi.split(" ").forEach(xt=>{if(!xt)return;let kn=c.widthOfTextAtSize(xt+" ",O);lt+kn>wi&&(g-=Ie,lt=b),d.drawText(xt+" ",{x:lt,y:g,font:c,size:O,color:Ui}),lt+=kn}),g-=Ie*1.5})}let Mn=X.WATERMARK_TEXT,xn=m.fixedText.website.size,Pi=c.widthOfTextAtSize(Mn,xn);d.drawText(Mn,{x:(d.getWidth()-Pi)/2,y:m.fixedText.website.y,size:xn,font:c,color:l(m.fixedText.website.color)});let Mi=en(e.date)||"Dieta",xi=`Dieta ${e.dietType==="lunch"?"Comida":e.dietType==="dinner"?"Cena":""} ${Mi}`.trim().replace(/ +/g," ");r.setTitle(xi),r.setAuthor("misdietas.com"),r.setSubject("Justificante de dieta de transporte sanitario"),r.setCreator("MisDietas"),r.setKeywords(["dieta","justificante","transporte sanitario","tsu","tsnu"]);let Mt=new Date(e.date);return isNaN(Mt.getTime())||(r.setCreationDate(Mt),r.setModificationDate(Mt)),await r.save({permissions:{modifying:!1,copying:!1}})}function Do(e,t){let n=en(e).replace(/\//g,"_")||"";return n?`${t==="lunch"?"dieta_comida":t==="dinner"?"dieta_cena":"dieta"}_${n}.pdf`:X.DEFAULT_FILENAME}async function yo(){let e=mt(),t=Et();if(!e||!t){rs(e,t);return}document.getElementById(It.DADES_TAB)?.classList.remove(ne.ERROR_TAB),document.getElementById(It.SERVEIS_TAB)?.classList.remove(ne.ERROR_TAB);try{let{generalData:n,servicesData:o}=vt();if(!n||!o)throw new Error("Dades no recollides.");await Io();let i=await _o(n,o),s=Do(n.date,n.dietType);vo(new Blob([i],{type:"application/pdf"}),s),typeof gtag=="function"&&gtag("event","download_pdf",{event_category:"PDF Generation",event_label:"Download from main form"}),u("Desc\xE0rrega iniciada correctament.","success"),ho()}catch(n){u(`Error en la generaci\xF3 del PDF: ${n.message||"Desconegut"}`,"error")}}async function Ao(e){if(!e){u("ID de dieta inv\xE1lido.","error");return}try{let t=e.length===64?e:await Ne(e),n=await Q(t);if(!n)throw new Error("Dieta no encontrada.");let o={date:n.date||"",dietType:n.dietType||"",vehicleNumber:n.vehicleNumber||"",person1:n.person1||"",person2:n.person2||"",serviceType:n.serviceType||"TSU",signatureConductor:n.signatureConductor||"",signatureAjudant:n.signatureAjudant||""},i=n.services.map(r=>({serviceNumber:r.serviceNumber||"",origin:r.origin||"",originTime:r.originTime||"",destination:r.destination||"",destinationTime:r.destinationTime||"",endTime:r.endTime||"",mode:r.mode||"3.6",notes:r.notes||""}));await Io();let s=await _o(o,i),a=Do(o.date,o.dietType);vo(new Blob([s],{type:"application/pdf"}),a),typeof gtag=="function"&&gtag("event","download_pdf",{event_category:"PDF Generation",event_label:"Download from saved list"}),u("Descarga iniciada correctamente.","success")}catch(t){console.error("Error en downloadDietPDF:",t),u(`Error en la generaci\xF3n del PDF: ${t.message||"Desconocido"}`,"error")}}var Lo="dotacions_v2",D={MODAL:"dotacio-modal",OPTIONS_CONTAINER:"dotacio-options",TEMPLATE:"dotacio-template",NO_DOTACIO_TEXT:"no-dotacio-text",ADD_BTN:"add-dotacio",OPEN_MODAL_BTN:"open-dotacio-modal",CLOSE_MODAL_BTN:"close-dotacio-modal",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2"},U={MODAL_OPEN:"modal-open",INPUT_ERROR:"input-error",HIDDEN:"hidden"},Oe={PERSON_INPUT_GROUP:".input-with-icon",DOTACIO_INFO:".dotacio-info",LOAD_BTN:".dotacio-load",DELETE_BTN:".dotacio-delete"},No={INDEX:"data-index"},as=180,tn=class{constructor(){this.savedDotacions=[],this.dotacioModalElement=null,this.optionsContainerElement=null,this.dotacioTemplateElement=null,this.noDotacioTextElement=null,this.isInitialized=!1}init(){if(this.isInitialized)return;this.dotacioModalElement=document.getElementById(D.MODAL),this.optionsContainerElement=document.getElementById(D.OPTIONS_CONTAINER),this.dotacioTemplateElement=document.getElementById(D.TEMPLATE),this.noDotacioTextElement=document.getElementById(D.NO_DOTACIO_TEXT);let t=document.getElementById(D.ADD_BTN),n=document.getElementById(D.OPEN_MODAL_BTN),o=document.getElementById(D.CLOSE_MODAL_BTN);if(!this.dotacioModalElement||!this.optionsContainerElement||!this.dotacioTemplateElement||!t||!n||!o)return;this.loadDotacionsFromStorage(),t.addEventListener("click",this.addDotacioFromMainForm.bind(this)),n.addEventListener("click",this.openDotacioModal.bind(this)),o.addEventListener("click",this.closeDotacioModal.bind(this)),this.dotacioModalElement.addEventListener("click",s=>{s.target===this.dotacioModalElement&&this.closeDotacioModal()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.dotacioModalElement.style.display==="block"&&this.closeDotacioModal()}),this.optionsContainerElement.addEventListener("click",this.handleOptionsClick.bind(this)),[D.VEHICLE_INPUT,D.PERSON1_INPUT,D.PERSON2_INPUT].forEach(s=>{let a=document.getElementById(s);a?.addEventListener("input",()=>{let r=a.closest(Oe.PERSON_INPUT_GROUP);r?r.classList.remove(U.INPUT_ERROR):a.classList.remove(U.INPUT_ERROR)})}),this.isInitialized=!0}loadDotacionsFromStorage(){try{let t=localStorage.getItem(Lo);this.savedDotacions=t?JSON.parse(t):[],Array.isArray(this.savedDotacions)||(this.savedDotacions=[])}catch{this.savedDotacions=[]}}saveDotacionsToStorage(){try{localStorage.setItem(Lo,JSON.stringify(this.savedDotacions))}catch{u("No se han podido guardar las dotaciones.","error")}}openDotacioModal(){this.dotacioModalElement&&(this.dotacioModalElement.style.display="block",document.body.classList.add(U.MODAL_OPEN),this.displayDotacioOptions())}closeDotacioModal(){this.dotacioModalElement&&(this.dotacioModalElement.style.display="none",document.body.classList.remove(U.MODAL_OPEN),document.getElementById(D.OPEN_MODAL_BTN)?.focus())}displayDotacioOptions(){!this.optionsContainerElement||!this.dotacioTemplateElement||(this.optionsContainerElement.innerHTML="",this.savedDotacions.length===0?(this.noDotacioTextElement?.classList.remove(U.HIDDEN),this.optionsContainerElement.classList.add(U.HIDDEN)):(this.noDotacioTextElement?.classList.add(U.HIDDEN),this.optionsContainerElement.classList.remove(U.HIDDEN),this.savedDotacions.forEach((t,n)=>{let o=this.dotacioTemplateElement.content.cloneNode(!0),i=o.querySelector(Oe.DOTACIO_INFO),s=o.querySelector(Oe.LOAD_BTN),a=o.firstElementChild,r=`${t.numero}-${t.conductor}-${t.ajudant}`.replace(/\s/g,"");a.setAttribute("data-dotacio-id",r),i&&(i.textContent=this.formatDotacioListText(t)),s&&s.setAttribute(No.INDEX,n),this.optionsContainerElement.appendChild(o),on(a,r),nn(a,r)})))}formatDotacioListText(t){let n=t.numero||"S/N",o=De(t.conductor||""),i=De(t.ajudant||""),s=`${o} / ${i}`;o||i?s=` - ${s}`:s="";let a=`${n}${s}`;if(this.measureTextWidth(a)>as){let c=t.conductor?this.shortenPersonName(t.conductor):"",d=t.ajudant?this.shortenPersonName(t.ajudant):"",l=`${c} / ${d}`;c||d?l=` - ${l}`:l="",a=`${n}${l}`}return a}shortenPersonName(t){if(!t||typeof t!="string")return"";let n=t.trim().split(/\s+/).filter(r=>r.length>0);if(n.length===0)return"";if(n.length===1)return De(n[0]);let o=new Set(["de","la","del","el","los","las","von","van","d'","es","da","dels","i","y"]),i=n.filter(r=>!o.has(r.toLowerCase()));if(i.length===0)return De(n[0]);let s=De(i[0]),a=i.slice(1).map(r=>r.charAt(0).toUpperCase()+".").join(" ");return`${s} ${a}`}measureTextWidth(t){let n=document.createElement("span");n.style.visibility="hidden",n.style.whiteSpace="nowrap",n.style.fontSize=getComputedStyle(document.body).fontSize,n.style.fontFamily=getComputedStyle(document.body).fontFamily,n.textContent=t,document.body.appendChild(n);let o=n.offsetWidth;return document.body.removeChild(n),o}loadDotacionByIndex(t){if(t<0||t>=this.savedDotacions.length)return;let n=this.savedDotacions[t];this.clearDotacionInputErrors(),document.getElementById(D.VEHICLE_INPUT).value=n.numero||"",document.getElementById(D.PERSON1_INPUT).value=n.conductor||"",document.getElementById(D.PERSON2_INPUT).value=n.ajudant||"",ht(n.firmaConductor||""),St(n.firmaAjudant||""),u(`Dotaci\xF3n ${n.numero} cargada.`,"success"),this.closeDotacioModal()}async handleDeleteById(t){let n=this.savedDotacions.findIndex(s=>`${s.numero}-${s.conductor}-${s.ajudant}`.replace(/\s/g,"")===t);if(n===-1){console.warn("Se intent\xF3 eliminar una dotaci\xF3n que ya no existe:",t);return}let i={...this.savedDotacions[n],originalIndex:n};this.savedDotacions.splice(n,1),this.saveDotacionsToStorage(),Ke(),u("Dotaci\xF3n eliminada.","success",5e3,{undoCallback:()=>{this.savedDotacions.splice(i.originalIndex,0,i),this.saveDotacionsToStorage(),Co(i),u("Dotaci\xF3n restaurada.","success")}})}handleOptionsClick(t){let o=t.target.closest(Oe.LOAD_BTN);if(o){t.stopPropagation();let i=parseInt(o.getAttribute(No.INDEX),10);isNaN(i)||this.loadDotacionByIndex(i)}}getDotacionInputValues(){let t=document.getElementById(D.VEHICLE_INPUT),n=document.getElementById(D.PERSON1_INPUT),o=document.getElementById(D.PERSON2_INPUT);return{vehiculo:t?.value.trim()||"",conductor:n?.value.trim()||"",ayudante:o?.value.trim()||""}}findExistingDotacionIndex(t,n,o){let i=t.toLowerCase(),s=n.toLowerCase(),a=o.toLowerCase();return this.savedDotacions.findIndex(r=>r.numero.toLowerCase()===i&&r.conductor.toLowerCase()===s&&r.ajudant.toLowerCase()===a)}addDotacioFromMainForm(){if(!oo())return;let{vehiculo:t,conductor:n,ayudante:o}=this.getDotacionInputValues(),i=pt(),s=Tt(),a=this.findExistingDotacionIndex(t,n,o),r={numero:t,conductor:n,ajudant:o,firmaConductor:i,firmaAjudant:s};a!==-1?(this.savedDotacions[a]=r,u(`Dotaci\xF3n ${t} actualizada.`,"success")):(this.savedDotacions.push(r),u(`Dotaci\xF3n ${t} creada.`,"success")),this.saveDotacionsToStorage()}clearDotacionInputErrors(){let t=document.getElementById(D.VEHICLE_INPUT),n=document.getElementById(D.PERSON1_INPUT),o=document.getElementById(D.PERSON2_INPUT),i=n?.closest(Oe.PERSON_INPUT_GROUP),s=o?.closest(Oe.PERSON_INPUT_GROUP);t?.classList.remove(U.INPUT_ERROR),i?.classList.remove(U.INPUT_ERROR),s?.classList.remove(U.INPUT_ERROR)}},Re=new tn;var p={MODAL_VISIBLE:"visible",MODAL_OPEN_BODY:"modal-open",HIDDEN:"hidden",DIET_ITEM:"diet-item",DIET_DATE:"diet-date",DIET_ICONS:"diet-icons",DIET_DELETE_BTN:"diet-delete",DIET_LOAD_BTN:"diet-load",LIST_ITEM_BTN:"list-item-btn",LIST_ITEM_BTN_LOAD:"list-item-btn--load",LIST_ITEM_BTN_DELETE:"list-item-btn--delete",DIET_ITEM_SWIPING:"swiping",DIET_DELETE_REVEAL:"delete-reveal"},w={DIET_MODAL:"diet-modal",DIET_OPTIONS_LIST:"diet-options",NO_DIETS_TEXT:"no-diets-text",CONFIRM_MODAL:"confirm-modal",CONFIRM_MESSAGE:"confirm-message",CONFIRM_TITLE:".modal-title",CONFIRM_YES_BTN:"confirm-yes",CONFIRM_NO_BTN:"confirm-no",ABOUT_MODAL:"about-modal",SIGNATURE_MODAL:"signature-modal",DOTACIO_MODAL:"dotacio-modal",CAMERA_GALLERY_MODAL:"camera-gallery-modal"},_t={MODAL:".modal",MODAL_CLOSE_BTN:".close-modal, .close-modal-btn",MODAL_TRIGGER:'a[href^="#"]',FOCUSABLE_ELEMENTS:'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'},oe={DIET_ID:"data-diet-id",DIET_DATE:"data-diet-date",DIET_TYPE:"data-diet-type"},Be=null,T=null,M=null,sn=null,cs=null,ls=null,ds=null,us=null;var R=null,be=null,we=null,Pe=null;function Oo(e){if(!e||R&&R.id!==e.id&&e.id!==w.CONFIRM_MODAL)return;R||(be=document.activeElement),R=e,e.style.display="block",document.body.classList.add(p.MODAL_OPEN_BODY),we||(we=n=>{n.target===R&&(R.id===w.CONFIRM_MODAL?_handleConfirmNo():Dt())},document.addEventListener("click",we,!0)),Pe||(Pe=n=>{n.key==="Escape"&&R&&(R.id===w.CONFIRM_MODAL?_handleConfirmNo():Dt())},document.addEventListener("keydown",Pe,!0)),e.querySelector(_t.FOCUSABLE_ELEMENTS)?.focus()}function Dt(){if(!R)return;we&&(document.removeEventListener("click",we,!0),we=null),Pe&&(document.removeEventListener("keydown",Pe,!0),Pe=null),R.style.display="none";let e=R.id===w.CONFIRM_MODAL;R=null;let t=document.querySelector('.modal[style*="display: block"]');t||document.body.classList.remove(p.MODAL_OPEN_BODY),!e&&be?(be.focus(),be=null):t||(be?.focus(),be=null)}function ms(e){if(!e)return"";let t=new Date(e);if(isNaN(t.getTime()))return"";let n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}:${o}`}function Ro(e){let t=e.services&&e.services.length>0?e.services[0].serviceNumber:"?????????",{ddmmaa:n,franjaText:o}=Vt(e.date,e.dietType),i=ms(e.timeStampDiet),s=document.createElement("div");s.className=p.DIET_ITEM;let a=document.createElement("div");a.className="diet-item-content";let r=document.createElement("span");r.className=p.DIET_DATE;let c=n;i&&(c+=` [${i}]`),c+=` - ${Yn(o)}`,r.textContent=c;let d=document.createElement("div");d.className=p.DIET_ICONS;let l=document.createElement("div");l.className="delete-reveal",l.innerHTML='<img src="assets/icons/delete.svg" alt="Eliminar" class="icon">';let E=document.createElement("button");E.className=`${p.LIST_ITEM_BTN} ${p.LIST_ITEM_BTN_LOAD} ${p.DIET_LOAD_BTN}`,E.setAttribute("aria-label",`Editar dieta ${n}`),E.innerHTML='<img src="assets/icons/ic_edit.svg" alt="" class="icon"><span class="btn-text visually-hidden">Editar</span>',E.setAttribute(oe.DIET_ID,t),E.setAttribute(oe.DIET_DATE,e.date),E.setAttribute(oe.DIET_TYPE,e.dietType);let v=document.createElement("button");return v.className=`${p.LIST_ITEM_BTN} diet-download`,v.setAttribute("aria-label",`Descarregar PDF de la dieta ${n}`),v.innerHTML='<img src="assets/icons/download_blue.svg" alt="" class="icon"><span class="btn-text visually-hidden">PDF</span>',v.setAttribute(oe.DIET_ID,t),d.appendChild(E),d.appendChild(v),a.appendChild(r),a.appendChild(d),s.appendChild(a),s.appendChild(l),s}async function Es(e){let t=e.target,n=t.closest(`.${p.DIET_LOAD_BTN}`),o=t.closest(".diet-download");if(n){e.stopPropagation();let i=n.getAttribute(oe.DIET_ID),s=n.getAttribute(oe.DIET_DATE),a=n.getAttribute(oe.DIET_TYPE);if(!i||!s||!a)return;let{ddmmaa:r,franjaText:c}=Vt(s,a);try{await Mo(i)}catch(d){console.error("Error en carregar la dieta:",d)}}else if(o){e.stopPropagation();let i=o.getAttribute(oe.DIET_ID);i&&Ao(i)}}function bo(e){if(!T)return;let t=T.querySelector(`[data-diet-id="${e}"]`)?.closest(".diet-item");if(!t)return;let n=T.scrollHeight+"px";T.style.height=n,t.remove(),requestAnimationFrame(()=>{T.style.height=T.scrollHeight+"px"}),At()}function Bo(){sn=document.getElementById(w.CONFIRM_MODAL),sn&&(cs=document.getElementById(w.CONFIRM_MESSAGE),ls=sn.querySelector(w.CONFIRM_TITLE),ds=document.getElementById(w.CONFIRM_YES_BTN),us=document.getElementById(w.CONFIRM_NO_BTN)),document.querySelectorAll(_t.MODAL_TRIGGER).forEach(t=>{let n=t.getAttribute("href")?.substring(1);if(!n)return;let o=document.getElementById(n);o&&o.matches(_t.MODAL)&&(t.addEventListener("click",s=>{s.preventDefault(),Oo(o)}),o.querySelectorAll(_t.MODAL_CLOSE_BTN).forEach(s=>{s.addEventListener("click",()=>Dt())}))})}function rn(){if(!Be){Be=document.getElementById(w.DIET_MODAL),T=document.getElementById(w.DIET_OPTIONS_LIST),M=document.getElementById(w.NO_DIETS_TEXT);let e=document.getElementById("close-diet-modal");e&&e.addEventListener("click",an),T&&T.addEventListener("click",Es)}Be&&(Oo(Be),yt())}function an(){R&&R.id===w.DIET_MODAL&&Dt()}async function yt(){if(!(!T||!M)){T.innerHTML="";try{let e=await dt();e.length===0?(T.classList.add(p.HIDDEN),M.classList.remove(p.HIDDEN),M.textContent="No hay dietas guardadas."):(T.classList.remove(p.HIDDEN),M.classList.add(p.HIDDEN),e.sort((t,n)=>new Date(n.timeStampDiet)-new Date(t.timeStampDiet)),e.forEach((t,n)=>{let o=Ro(t);o.setAttribute("data-index",n),T.appendChild(o),wo(o,t.id,t.date,t.dietType)}))}catch{T.classList.add(p.HIDDEN),M.classList.remove(p.HIDDEN),M.textContent="Error al cargar las dietas."}}}function At(){console.log("Actualitzant visibilitat: children.length =",T.children.length),T.children.length===0?(T.classList.add(p.HIDDEN),M.classList.remove(p.HIDDEN),M.textContent="No hay dietas guardadas."):(T.classList.remove(p.HIDDEN),M.classList.add(p.HIDDEN))}function fs(e,t,n,o){let i=0,s=0,a=!1;e.addEventListener("mousedown",r=>{r.target.closest("button")||r.target.closest(".diet-icons")||(i=r.clientX,s=i,a=!1)}),document.addEventListener("mousemove",r=>{s=r.clientX;let c=i-s;c>10&&!a&&(a=!0,e.classList.add(p.DIET_ITEM_SWIPING)),a&&c>10&&(e.style.transform=`translateX(-${Math.min(c,80)}px)`,r.preventDefault())}),document.addEventListener("mouseup",async r=>{if(!a)return;a=!1;let c=i-s;e.classList.remove(p.DIET_ITEM_SWIPING),e.style.transition="transform 0.3s ease, opacity 0.3s ease",c>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{e.remove(),At(),await cn(t,n,o)},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300)})}function wo(e,t,n,o){let i=0,s=0,a=!1;e.addEventListener("touchstart",r=>{r.target.closest("button")||r.target.closest(".diet-icons")||(i=r.touches[0].clientX,s=i,a=!1,r.stopPropagation())},{passive:!1}),e.addEventListener("touchmove",r=>{s=r.touches[0].clientX;let c=i-s;c>10&&!a&&(a=!0,e.classList.add(p.DIET_ITEM_SWIPING),Be.style.overflow="hidden"),a&&c>10&&(e.style.transform=`translateX(-${Math.min(c,80)}px)`,r.preventDefault(),r.stopPropagation())},{passive:!1}),e.addEventListener("touchend",async r=>{if(!a)return;a=!1;let c=i-s;e.classList.remove(p.DIET_ITEM_SWIPING),e.style.transition="transform 0.3s ease, opacity 0.3s ease",c>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{e.remove(),At(),await cn(t,n,o)},300)):(e.style.transform="translateX(0)",e.style.opacity="1",Be.style.overflow=""),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300),r.stopPropagation()}),fs(e,t,n,o)}function nn(e,t){let n=0,o=0,i=!1;e.addEventListener("mousedown",s=>{s.target.closest("button")||s.target.closest(".button-container")||(n=s.clientX,o=n,i=!1)}),document.addEventListener("mousemove",s=>{o=s.clientX;let a=n-o;a>10&&!i&&(i=!0,e.classList.add("swiping")),i&&a>10&&(e.style.transform=`translateX(-${Math.min(a,80)}px)`,s.preventDefault())}),document.addEventListener("mouseup",async s=>{if(!i)return;i=!1;let a=n-o;e.classList.remove("swiping"),e.style.transition="transform 0.3s ease, opacity 0.3s ease",a>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{await Re.handleDeleteById(t),e.remove(),Ke()},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300)})}function on(e,t){let n=0,o=0,i=!1;e.addEventListener("touchstart",s=>{s.target.closest("button")||(n=s.touches[0].clientX,o=n,i=!1,s.stopPropagation())},{passive:!1}),e.addEventListener("touchmove",s=>{o=s.touches[0].clientX;let a=n-o;a>10&&!i&&(i=!0,e.classList.add("swiping")),i&&a>10&&(e.style.transform=`translateX(-${Math.min(a,80)}px)`,s.preventDefault(),s.stopPropagation())},{passive:!1}),e.addEventListener("touchend",async s=>{if(!i)return;i=!1;let a=n-o;e.classList.remove("swiping"),e.style.transition="transform 0.3s ease, opacity 0.3s ease",a>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{await Re.handleDeleteById(t),e.remove(),Ke()},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300),s.stopPropagation()})}function Po(e){if(!T||!M){yt();return}let t=e.index||0,n=Ro(e);n.style.opacity="0",n.style.transform="translateX(-100%)";let o=T.children[t];o?T.insertBefore(n,o):T.appendChild(n),requestAnimationFrame(()=>{n.style.transition="opacity 0.5s ease, transform 0.5s ease",n.style.opacity="1",n.style.transform="translateX(0)",wo(n,e.id,e.date,e.dietType)}),At(),T.classList.remove(p.HIDDEN),M.classList.add(p.HIDDEN)}function Ke(){let e=document.getElementById("dotacio-options"),t=document.getElementById("no-dotacio-text");e.children.length===0?(e.classList.add("hidden"),t.classList.remove("hidden"),t.innerHTML='No hay dotaciones, guarde antes: <img src="assets/icons/save_green.svg" alt="Guardar" class="save-icon" />'):(e.classList.remove("hidden"),t.classList.add("hidden"))}function gs(e,t){let n=document.getElementById("dotacio-template");if(!n)return null;let o=n.content.cloneNode(!0),i=o.firstElementChild,s=`${e.numero}-${e.conductor}-${e.ajudant}`.replace(/\s/g,"");i.setAttribute("data-dotacio-id",s);let a=o.querySelector(".dotacio-info"),r=o.querySelector(".dotacio-load");if(a){let c=[e.conductor,e.ajudant].filter(Boolean).join(" / ");a.textContent=c?`${e.numero} - ${c}`:e.numero}return r&&r.setAttribute("data-index",String(t)),i}function Co(e){let t=document.getElementById("dotacio-options");if(!t){Re.displayDotacioOptions();return}let n=e.originalIndex,o=gs(e,n);if(!o)return;o.style.opacity="0",o.style.transform="translateX(-100%)";let i=t.children[n];i?t.insertBefore(o,i):t.appendChild(o),requestAnimationFrame(()=>{o.style.transition="opacity 0.5s ease, transform 0.5s ease",o.style.opacity="1",o.style.transform="translateX(0)";let s=`${e.numero}-${e.conductor}-${e.ajudant}`.replace(/\s/g,"");on(o,s),nn(o,s)}),Ke()}var ps="save-pill",Ts=".pill-text",q={VISIBLE:"visible",HAS_CHANGES:"has-changes",SAVING:"saving",HAS_SAVED:"has-saved",ERROR:"error"},xo=2e3;var ie=null,ln=null,ge=null,Je=null,hs=0,dn=!1;function Uo(){if(!ie){if(ie=document.getElementById(ps),ln=ie?.querySelector(Ts),!ie||!ln)throw new Error("Elements de la p\xEDndola no trobats al DOM.");ie.setAttribute("role","status"),ie.setAttribute("aria-live","polite")}return{pillEl:ie,textEl:ln}}function un(e,t){try{let{pillEl:n,textEl:o}=Uo();n.classList.add(q.VISIBLE),n.classList.remove(q.HAS_CHANGES,q.SAVING,q.HAS_SAVED,q.ERROR),t&&n.classList.add(t),o.textContent=e.replace(/[<>&]/g,"")}catch(n){console.warn("[saveIndicator] Error mostrant p\xEDndola:",n)}}function Lt(e="Guardando\u2026"){clearTimeout(Je),un(e,q.SAVING)}function Nt(){clearTimeout(Je),dn=!1,hs=Date.now(),un("Guardado",q.HAS_SAVED),clearTimeout(ge),ge=setTimeout(mn,xo)}function Qe(e="No se pudo guardar"){clearTimeout(Je),un(e,q.ERROR),clearTimeout(ge),ge=setTimeout(mn,xo*2)}function mn(e=!1){try{if(Uo(),clearTimeout(ge),dn&&!e)return;ie?.classList.remove(q.VISIBLE),ge=null}catch(t){console.warn("[saveIndicator] Error amagant p\xEDndola:",t)}}function Me(){dn=!1,clearTimeout(Je),mn(!0)}window.addEventListener("pagehide",()=>{clearTimeout(ge),clearTimeout(Je)});var se={DADES_TAB:"tab-dades",SERVEIS_TAB:"tab-serveis",DATE_INPUT:"date",DIET_TYPE_SELECT:"diet-type",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2",SERVICE_TYPE_SELECT:"service-type"},En=Promise.resolve(),ko=!1;var xe={ERROR_TAB:"error-tab"},Ss=".service",Fo={serviceNumber:".service-number",origin:".origin",originTime:".origin-time",destination:".destination",destinationTime:".destination-time",endTime:".end-time"},fn=class{constructor({id:t="",date:n="",dietType:o="",vehicleNumber:i="",person1:s="",person2:a="",signatureConductor:r="",signatureAjudant:c="",services:d=[],serviceType:l="TSU",timeStampDiet:E=new Date().toISOString()}={}){this.id=String(t),this.date=String(n),this.dietType=String(o),this.vehicleNumber=String(i),this.person1=String(s),this.person2=String(a),this.signatureConductor=String(r),this.signatureAjudant=String(c),this.services=Array.isArray(d)?d:[],this.serviceType=String(l),this.timeStampDiet=String(E)}};async function Is(e,t,n){if(!e||!Array.isArray(t)||!n)throw new Error("Datos incompletos para construir la dieta.");if(!/^\d{9}$/.test(n))throw new Error("ID de dieta inv\xE1lido. Debe contener 9 d\xEDgitos.");for(let r of t)if(!ft(r.originTime)||!ft(r.destinationTime)||!ft(r.endTime))throw new Error("Formato de hora inv\xE1lido detectado. Use HH:mm.");let o=await Ne(n),i=await Q(o),s=i?i.timeStampDiet:new Date().toISOString(),a={id:o,date:_(e.date),dietType:_(e.dietType),vehicleNumber:_(e.vehicleNumber),person1:_(e.person1),person2:_(e.person2),signatureConductor:e.signatureConductor,signatureAjudant:e.signatureAjudant,services:t.map(r=>({serviceNumber:_(r.serviceNumber),origin:_(r.origin),destination:_(r.destination),originTime:r.originTime,destinationTime:r.destinationTime,endTime:r.endTime,mode:_(r.mode),notes:_(r.notes)||""})),serviceType:_(e.serviceType),timeStampDiet:s};return new fn(a)}function vs(){let e=document.getElementById(se.DADES_TAB),t=document.getElementById(se.SERVEIS_TAB);e?.classList.remove(xe.ERROR_TAB),t?.classList.remove(xe.ERROR_TAB);let n=mt(),o=Et();if(n&&o)return!0;let i="";return!n&&!o?(i="Completa los campos obligatorios en Datos y Servicios.",e?.classList.add(xe.ERROR_TAB),t?.classList.add(xe.ERROR_TAB)):n?(i="Completa los campos obligatorios en la pesta\xF1a Servicios.",t?.classList.add(xe.ERROR_TAB)):(i="Completa los campos obligatorios en la pesta\xF1a Datos.",e?.classList.add(xe.ERROR_TAB)),u(i,"error"),!1}function _s(e){if(!e)return;let t=i=>document.getElementById(i);t(se.DATE_INPUT).value=e.date||"",t(se.DIET_TYPE_SELECT).value=e.dietType||"",t(se.VEHICLE_INPUT).value=e.vehicleNumber||"",t(se.PERSON1_INPUT).value=e.person1||"",t(se.PERSON2_INPUT).value=e.person2||"";let n=t(se.SERVICE_TYPE_SELECT);n&&(n.value=e.serviceType||"TSU",Ue(n.value)),ht(e.signatureConductor||""),St(e.signatureAjudant||"");let o=document.querySelectorAll(Ss);e.services.forEach((i,s)=>{let a=o[s];a&&(Object.entries(Fo).forEach(([r,c])=>{let d=a.querySelector(c);d&&(d.value=i[r]||"")}),$o(s,i.mode||"3.6"),et(a),W[s]=i.notes||"")});for(let i=e.services.length;i<o.length;i++){let s=o[i];s&&(Object.values(Fo).forEach(a=>{let r=s.querySelector(a);r&&(r.value="")}),et(s),W[i]="")}}async function Vo(e){return En=En.then(async()=>{let{generalData:t,servicesData:n}=vt(),o=n[0]?.serviceNumber?.slice(0,9)||"";if(!o||!/^\d{9}$/.test(o)){e&&u("El primer servicio debe tener un N.\xBA de servicio v\xE1lido.","error");return}let i=await Ne(o),s=await Q(i);e&&Lt(!s?"Guardando nueva dieta\u2026":"Guardando\u2026"),gn(!1);try{if(await new Promise(d=>setTimeout(d,500)),!vs()){e&&Qe("Validaci\xF3n fallida");return}let c=await Is(t,n,o);s?await $n(c):(await kt(c),pe(),Me()),e&&u("Dieta guardada correctament.","success"),Ze=new Date,pn(),pe(),Nt(),e&&await yt()}catch(c){console.error("Error en performSave:",c),Qe(c.message||"No se pudo guardar"),e&&u(`Error al guardar: ${c.message}`,"error")}finally{gn(!0),ko&&(ko=!1,setTimeout(()=>Ct(),100))}}),En}async function Go(){Ho(),await Vo(!0)}async function Ct(){await Vo(!1)}async function Mo(e){if(!e||typeof e!="string")throw new Error("ID inv\xE0lid");let t=e.length===64?await Q(e):await Q(await Ne(e));if(!t)throw new Error(`Dieta no trobada: ${e}`);_s(t),pe(),t.timeStampDiet&&(Ze=new Date(t.timeStampDiet),pn()),u("Dieta cargada correctamente.","success"),an()}async function cn(e,t,n){if(e)try{let o=await Q(e);if(!o){u("Error: Dieta no trobada","error");return}let s=(await dt()).sort((a,r)=>new Date(r.timeStampDiet)-new Date(a.timeStampDiet));o.index=s.findIndex(a=>a.id===e),await jn(e),u("Dieta eliminada","success",5e3,{priority:2,undoCallback:async()=>{await kt(o),Po(o),u("Dieta restaurada","success",3e3,{priority:0})},onExpire:()=>{bo(e)}}),pe(),Me()}catch(o){console.error("Error en deleteDietHandler:",o),u("Error al eliminar la dieta","error")}}var Ze=null;function pn(){let e=document.getElementById("last-saved");e&&(e.textContent=Ze?uo(Ze):"")}setInterval(()=>{Ze&&pn()},6e4);var Ds=".service",jo="main-content",k={DATE:"date",DIET_TYPE:"diet-type",VEHICLE:"vehicle-number",P1:"person1",P2:"person2",SERVICE_TYPE:"service-type",SAVE_BTN:"save-diet"},ys="userSelectedServiceType",As={serviceNumber:".service-number",origin:".origin",originTime:".origin-time",destination:".destination",destinationTime:".destination-time",endTime:".end-time"},Ls="chip-active",Ns=800,Cs=1e3,Os=300,Tn=class{constructor(){this.initialFormDataStr="",this.saveStart=0,this.debouncedAutoSave=Gt(this.triggerAutoSave.bind(this),Cs),this.debouncedHandler=Gt(this.handleInputChange.bind(this),Ns)}isFormReadyForSave(){try{let t=!!document.getElementById(k.DATE)?.value.trim(),n=!!document.getElementById(k.DIET_TYPE)?.value.trim(),o=document.getElementById("service-number-1")?.value.trim(),i=/^\d{9}$/.test(o);return t&&n&&i}catch(t){return console.warn("[FormService] Error validant formulari:",t),!1}}hasPendingChanges(){return JSON.stringify(this.getFormDataObject()||{})!==this.initialFormDataStr}getFormDataObject(){try{let t={date:_(document.getElementById(k.DATE)?.value),dietType:_(document.getElementById(k.DIET_TYPE)?.value||Ft()),vehicleNumber:_(document.getElementById(k.VEHICLE)?.value),person1:_(document.getElementById(k.P1)?.value),person2:_(document.getElementById(k.P2)?.value),serviceType:_(document.getElementById(k.SERVICE_TYPE)?.value||"TSU"),signatureConductor:pt(),signatureAjudant:Tt()},n=Array.from(document.querySelectorAll(Ds)).map((o,i)=>{let s={};for(let[r,c]of Object.entries(As))s[r]=_(o.querySelector(c)?.value);let a=o.querySelector(`.chip.${Ls}`);return s.mode=a?.dataset.mode||"3.6",s.notes=W[i]||"",s});return{generalData:t,servicesData:n}}catch(t){return console.error("[FormService] Error recollint dades:",t),null}}async triggerAutoSave(){if(!(!this.isFormReadyForSave()||!this.hasPendingChanges()))try{this.saveStart=Date.now(),Lt(),await Ct();let t=Date.now()-this.saveStart;setTimeout(Nt,Math.max(0,Os-t)),this.initialFormDataStr=JSON.stringify(this.getFormDataObject()||{})}catch(t){console.warn("[Autosave skipped]",t?.message||"Error desconegut"),Qe("Revisa dades de Serveis")}}captureInitialFormState(){this.initialFormDataStr=JSON.stringify(this.getFormDataObject()||{}),this.handleFormChange()}setSaveButtonState(t){let n=document.getElementById(k.SAVE_BTN);n&&(n.disabled=!t,n.setAttribute("aria-disabled",t?"false":"true"),n.classList.toggle("is-disabled",!t))}handleFormChange(){if(this.debouncedAutoSave.cancel(),!this.hasPendingChanges()){this.setSaveButtonState(!1),Me();return}this.isFormReadyForSave()?(this.setSaveButtonState(!0),this.debouncedAutoSave()):(this.setSaveButtonState(!1),Me())}handleInputChange(){this.handleFormChange()}addInputListeners(){let t=document.getElementById(jo);if(!t)return;t.addEventListener("input",this.debouncedHandler),t.addEventListener("change",this.debouncedHandler),t.addEventListener("blur",o=>{o.target.matches("input, select, textarea")&&(this.handleFormChange(),this.isFormReadyForSave()&&this.hasPendingChanges()&&(this.debouncedAutoSave.cancel(),this.triggerAutoSave()))},!0);let n=document.getElementById(k.DATE);n?.addEventListener("change",()=>{n.blur(),this.debouncedHandler()}),window.addEventListener("beforeunload",()=>{this.debouncedAutoSave.cancel(),this.isFormReadyForSave()&&Ct()})}addServiceTypeListener(){let t=document.getElementById(k.SERVICE_TYPE);t&&t.addEventListener("change",n=>{let o=n.target.value.trim();Ue(o);try{localStorage.setItem(ys,o)}catch(i){console.error("No s\u2019ha pogut desar tipus servei",i)}})}cancelPendingAutoSave(){this.debouncedAutoSave.cancel()}addDoneBehavior(){document.getElementById(jo)?.addEventListener("keydown",n=>{n.key==="Enter"&&n.target.matches('input[enterkeyhint="done"]')&&(n.preventDefault(),n.target.blur())})}gatherAllData(){return this.getFormDataObject()}getInitialFormDataStr(){return this.initialFormDataStr}},re=new Tn,pe=()=>re.captureInitialFormState(),gn=e=>re.setSaveButtonState(e),j=()=>re.handleFormChange(),Xo=()=>re.addInputListeners(),qo=()=>re.addServiceTypeListener(),Ho=()=>re.cancelPendingAutoSave(),Wo=()=>re.addDoneBehavior(),vt=()=>re.gatherAllData();var bs=["3.6","3.51","3.22","3.11"],ke={CONTAINER:"services-container",BUTTONS_CONTAINER:"service-buttons-container",OPTIONS_MENU:"options-menu",OPTIONS_TOGGLE_BTN:"options-toggle",CLEAR_BTN:"clear-selected-service",CAMERA_BTN:"camera-in-dropdown",CHIP_GROUP:"service-mode-chips"},ot={SERVICE_PANEL:".service",SERVICE_BUTTON:".service-button",CHIP:".chip",FORM_GROUP:".form-group"},S={SERVICE_HIDDEN:"hidden",BUTTON_ACTIVE:"active-square",SERVICE_COLORS:["service-1","service-2","service-3","service-4"],OPTIONS_MENU_HIDDEN:"hidden",CHIP_ACTIVE:"chip-active"},Bs=[".chip-group-title",".chip-group",".btn-ocr-inline",".section-divider"],ws=[".destination",".destination-time"],Yo=!1,Fe=0,y=[],it=[],zo=[],hn=null,tt=null,Y=null,nt=null,Ps=null,Ms=[],ae=[],W=["","","",""];function xs(){tt&&(tt.innerHTML="",it=y.map((e,t)=>{let n=document.createElement("button");return n.className=`service-button ${S.SERVICE_COLORS[t]}`,n.textContent=`S${t+1}`,n.type="button",n.setAttribute("aria-label",`Mostrar servei ${t+1}`),n.addEventListener("click",()=>Gs(t)),tt.appendChild(n),n}))}function Us(){!Y||!nt||(nt.addEventListener("click",e=>{e.stopPropagation(),Y.classList.toggle(S.OPTIONS_MENU_HIDDEN)}),document.addEventListener("click",e=>{!nt?.contains(e.target)&&!Y?.contains(e.target)&&Y.classList.add(S.OPTIONS_MENU_HIDDEN)}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Y&&Y.classList.add(S.OPTIONS_MENU_HIDDEN)}),Y.addEventListener("click",e=>{e.target.closest("button")&&Y.classList.add(S.OPTIONS_MENU_HIDDEN)}))}function ks(e,t){let n=e.querySelector(t);return n?n.closest(ot.FORM_GROUP):null}function Ot(e,t){if(!e)return;let n=t!=="3.6";ws.forEach(i=>{ks(e,i)?.classList.toggle(S.SERVICE_HIDDEN,n)});let o=e.querySelector(".origin");o&&(n?o.setAttribute("enterkeyhint","done"):o.removeAttribute("enterkeyhint"))}function Fs(e){Ps&&Ms.forEach(t=>t.classList.toggle(S.CHIP_ACTIVE,t.dataset.mode===e))}function Rt(e,t){e.querySelectorAll(ot.CHIP).forEach(o=>o.classList.toggle(S.CHIP_ACTIVE,o.dataset.mode===t))}function Vs(){y.forEach((e,t)=>{e.querySelectorAll(ot.CHIP).forEach(o=>{o.addEventListener("click",()=>{let i=o.dataset.mode;if(!bs.includes(i)){console.error(`Intent de canviar a un mode inv\xE0lid: "${i}". Acci\xF3 bloquejada.`);return}if(ae[t]===i)return;ae[t]=i,Rt(e,i),Ot(e,i);let s=e.querySelector(".chip-group");s&&(S.SERVICE_COLORS.forEach(a=>s.classList.remove(a)),s.classList.add(S.SERVICE_COLORS[t])),j()})})})}function Sn(e){let t=S.SERVICE_COLORS[e],n=(o,i)=>{o&&(o.classList.remove(...S.SERVICE_COLORS),o.classList.add(i,t))};n(document.getElementById(ke.CLEAR_BTN),"clear-selected-btn"),n(document.getElementById(ke.CAMERA_BTN),"camera-btn"),n(document.getElementById("notes-selected-service"),"notes-btn"),n(nt,"options-btn")}function Ko(){if(!Yo&&(zo=document.querySelectorAll(ot.SERVICE_PANEL),hn=document.getElementById(ke.CONTAINER),tt=document.getElementById(ke.BUTTONS_CONTAINER),Y=document.getElementById(ke.OPTIONS_MENU),nt=document.getElementById(ke.OPTIONS_TOGGLE_BTN),!(!hn||!tt)&&(y=Array.from(hn.querySelectorAll(ot.SERVICE_PANEL)),!!y.length))){if(ae=y.map(()=>"3.6"),xs(),Us(),Vs(),y.length>0&&it.length>0){y.forEach((n,o)=>n.classList.toggle(S.SERVICE_HIDDEN,o!==0)),it[0].classList.add(S.BUTTON_ACTIVE);let e=ae[0];Ot(y[0],e),Rt(y[0],e);let t=y[0].querySelector(".chip-group");t&&t.classList.add(S.SERVICE_COLORS[0]),Fs(e),Sn(0)}Yo=!0}}function Gs(e){if(e<0||e>=y.length||e===Fe)return;y[Fe].classList.add(S.SERVICE_HIDDEN),y[e].classList.remove(S.SERVICE_HIDDEN),it[Fe].classList.remove(S.BUTTON_ACTIVE),it[e].classList.add(S.BUTTON_ACTIVE),Fe=e;let t=ae[e];Ot(y[e],t),Rt(y[e],t);let n=y[e].querySelector(".chip-group");n&&(S.SERVICE_COLORS.forEach(o=>n.classList.remove(o)),n.classList.add(S.SERVICE_COLORS[e])),Sn(e)}var Te=()=>Fe,Jo=e=>{if(e>=0&&e<ae.length)return ae[e]};function Qo(e){e&&e.querySelectorAll("input, select, textarea").forEach(t=>{t.type==="checkbox"||t.type==="radio"?t.checked=!1:t.type!=="button"&&t.type!=="submit"&&t.type!=="reset"&&(t.value=""),t.tagName==="SELECT"&&(t.selectedIndex=0)})}function jt(){Sn(Fe)}function $o(e,t){if(e<0||e>=y.length)return;ae[e]=t;let n=y[e];n&&(Rt(n,t),Ot(n,t),j())}function Ue(e){let t=e==="TSNU";zo.forEach(n=>{Bs.forEach(o=>{n.querySelector(o)?.classList.toggle(S.SERVICE_HIDDEN,t)})})}function et(e){e&&e.querySelectorAll(".input-error").forEach(t=>t.classList.remove("input-error"))}var In={TOGGLE_BTN:"theme-toggle-btn",THEME_ICON:"theme-icon",THEME_TEXT:"theme-btn-text"},Zo={DARK_THEME:"theme-dark"},vn="themePreference",x={LIGHT:"light",DARK:"dark"},ei={LIGHT:"assets/icons/moon.svg",DARK:"assets/icons/sun.svg"},ti={LIGHT:"#004aad",DARK:"#343a40"},_n=class{constructor(){this.themeToggleButton=null,this.themeIconElement=null,this.themeTextElement=null,this.bodyElement=null,this.systemDarkMatcher=null}init(){if(this.themeToggleButton=document.getElementById(In.TOGGLE_BTN),this.themeIconElement=document.getElementById(In.THEME_ICON),this.themeTextElement=document.getElementById(In.THEME_TEXT),this.bodyElement=document.body,!this.themeToggleButton||!this.themeIconElement||!this.themeTextElement||!this.bodyElement){console.warn("Faltan elementos del DOM para el gestor de temas.");return}let t,n=localStorage.getItem(vn);n&&(n===x.LIGHT||n===x.DARK)?t=n:(this.systemDarkMatcher=window.matchMedia("(prefers-color-scheme: dark)"),t=this.systemDarkMatcher.matches?x.DARK:x.LIGHT,this.systemDarkMatcher.addEventListener("change",this._handleSystemThemeChange.bind(this))),this._applyTheme(t,!1),this.themeToggleButton.addEventListener("click",this._handleThemeToggle.bind(this))}_updateThemeColorMeta(t){let n=document.querySelector('meta[name="theme-color"]');n&&(n.content=t)}_applyTheme(t,n=!1){let o=t===x.DARK;this.bodyElement.classList.toggle(Zo.DARK_THEME,o),this.themeIconElement.src=o?ei.DARK:ei.LIGHT,this.themeTextElement.textContent=o?"Claro":"Oscuro",this.themeIconElement.alt=o?"Cambiar a tema claro":"Cambiar a tema oscuro",this._updateThemeColorMeta(o?ti.DARK:ti.LIGHT),n&&localStorage.setItem(vn,t)}_handleThemeToggle(){let n=(this.bodyElement.classList.contains(Zo.DARK_THEME)?x.DARK:x.LIGHT)===x.DARK?x.LIGHT:x.DARK;this._applyTheme(n,!0)}_handleSystemThemeChange(t){if(!localStorage.getItem(vn)){let n=t.matches?x.DARK:x.LIGHT;this._applyTheme(n,!1)}}},Hs=new _n,ni=()=>Hs.init();var Dn={GENERATE_PDF:".generate-pdf",SAVE_DIET:"#save-diet",MANAGE_DIETS:"#manage-diets"};function oi(){let e=document.querySelector(Dn.GENERATE_PDF);e&&e.addEventListener("click",yo);let t=document.getElementById(Dn.SAVE_DIET.substring(1));t&&t.addEventListener("click",Go);let n=document.getElementById(Dn.MANAGE_DIETS.substring(1));n&&typeof rn=="function"&&n.addEventListener("click",rn)}var ii="clear-selected-service",$s=".service";function si(){let e=document.getElementById(ii);if(!e){console.warn(`Clear Service: Bot\xF3 amb ID '${ii}' no trobat.`);return}e.addEventListener("click",()=>{let t=Te(),n=document.querySelectorAll($s);if(t>=0&&t<n.length){let o=n[t],i=o.querySelectorAll('input:not([type="button"]):not([type="submit"]), select, textarea');i.forEach(s=>{s.value!==""&&s.classList.add("field-clearing")}),setTimeout(()=>{Qo(o),et(o),j(),i.forEach(s=>{s.classList.remove("field-clearing")}),console.log(`Servei ${t+1} netejat amb efecte visual.`)},600)}else console.warn(`Clear Service: \xCDndex de servei inv\xE0lid (${t}) o element no trobat.`)}),console.log("Funcionalitat 'Netejar Servei Seleccionat' configurada.")}function ri(){document.querySelectorAll('input[type="date"]').forEach(t=>{t.dataset.pickerSetup!=="true"&&(t.dataset.pickerSetup="true",typeof t.showPicker=="function"&&t.addEventListener("click",()=>{try{t.showPicker()}catch{}}))})}function ai(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.dataset.pickerSetup!=="true"&&(t.dataset.pickerSetup="true",typeof t.showPicker=="function"&&t.addEventListener("click",()=>{try{t.showPicker()}catch{}}))})}var js={SERVICE_NUMBER_INPUT:".service-number"},ci={DIGITS_ONLY:"Solo se permiten d\xEDgitos (0-9) en el n\xFAmero de servicio."};function Xs(e,t){let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e(...o),t)}}var li=Xs(u,300);function qs(e){return/^\d*$/.test(e)}function di(){let e=document.querySelectorAll(js.SERVICE_NUMBER_INPUT);if(!e.length){console.warn("Restrictions: No se han encontrado inputs '.service-number'.");return}e.forEach(t=>{t.dataset.restrictionsSetup!=="true"&&(t.dataset.restrictionsSetup="true",t.addEventListener("keypress",n=>{n.key==="Enter"||n.key==="Tab"||n.ctrlKey||n.metaKey||n.altKey||n.key.length>1||/\d/.test(n.key)||(n.preventDefault(),li(ci.DIGITS_ONLY,"warning"))}),t.addEventListener("paste",n=>{try{let o=(n.clipboardData||window.clipboardData)?.getData("text")||"";qs(o)||(n.preventDefault(),li(ci.DIGITS_ONLY,"warning"))}catch(o){console.error("Error procesando 'paste':",o),n.preventDefault()}}))})}var ui={SETTINGS_BTN:"settings",SETTINGS_PANEL:"settings-panel"},Ve={PANEL_VISIBLE:"visible",BUTTON_OPEN:"open"},z=null,K=null,mi=!1;function Ws(e){e.stopPropagation();let t=K.classList.toggle(Ve.PANEL_VISIBLE);z.classList.toggle(Ve.BUTTON_OPEN,t),z.setAttribute("aria-expanded",t),t&&K.querySelector("button")?.focus()}function Ys(e){K.classList.contains(Ve.PANEL_VISIBLE)&&!K.contains(e.target)&&!z.contains(e.target)&&yn()}function zs(e){e.key==="Escape"&&K.classList.contains(Ve.PANEL_VISIBLE)&&(yn(),z.focus())}function yn(){K.classList.remove(Ve.PANEL_VISIBLE),z.classList.remove(Ve.BUTTON_OPEN),z.setAttribute("aria-expanded","false")}function Ei(){mi||(z=document.getElementById(ui.SETTINGS_BTN),K=document.getElementById(ui.SETTINGS_PANEL),!(!z||!K)&&(z.addEventListener("click",Ws),document.addEventListener("click",Ys),document.addEventListener("keydown",zs),K.querySelectorAll("button").forEach(e=>{e.addEventListener("click",yn)}),mi=!0))}var Ks={SERVICE_BUTTONS:".service-button:not(.active-square)",OPTIONS_BTN:"#options-toggle",TABS:".tab:not(.active)"},Js="disabled-control";function An(e=!0){document.querySelectorAll(Object.values(Ks).join(", ")).forEach(n=>{n&&(n.classList.toggle(Js,e),n.setAttribute("aria-disabled",e?"true":"false"),n.disabled=e)})}var Qs="spa",Zs=1,er="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ:/-\xC0\xC9\xCD\xD3\xDA\xC8\xD2\xC0\xDC\xCF\xC7\xD1",Ln=1500,tr=.95,Si="image/png",fi=10,nr=300,or=1e3;var ir={tessedit_char_whitelist:er,tessedit_pageseg_mode:6,load_system_dawg:!1,load_freq_dawg:!1},J={CAMERA_BTN:"camera-in-dropdown",CAMERA_MODAL:"camera-gallery-modal",MODAL_CONTENT:".modal-bottom-content",OPTION_CAMERA:"option-camera",OPTION_GALLERY:"option-gallery",CAMERA_INPUT:"camera-input",OCR_PROGRESS_CONTAINER:".ocr-progress-container",OCR_PROGRESS_TEXT:".ocr-progress-text",OCR_SCAN_BTN:".btn-ocr-inline"},F={VISIBLE:"visible",HIDDEN:"hidden",SERVICE_COLORS:["service-1","service-2","service-3","service-4"]},sr={ORIGIN_TIME:{id:"originTime",label:"Hora movilizaci\xF3n",fieldIdSuffix:"origin-time",lineKeywordRegex:/movilizaci|ltat|desplaza/i},DESTINATION_TIME:{id:"destinationTime",label:"Hora de llegada hospital",fieldIdSuffix:"destination-time",lineKeywordRegex:/arribada|hospital|aaah/i},END_TIME:{id:"endTime",label:"Hora Final",fieldIdSuffix:"end-time",valueRegex:/\d{2}\s*\/?\s*\d{2}\s*\/?\s*\d{2}\s+(\d{1,2}:\d{2}(?::\d{2})?)/i}},V=null,st=null,bt=null,Nn=null,C=null,Cn=!1,gi=!1,pi=!1,Ti=0;function rr(e){if(!e)return"";let t=e.replace(/[^\d:\-]/g,"");t=t.replace(/-/g,":");let n=t.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);if(n){let o=parseInt(n[1],10),i=parseInt(n[2],10);if(o>=0&&o<=23&&i>=0&&i<=59)return`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`}return""}function ar(){if(Date.now()-Ti<500||(Ti=Date.now(),!V||!st))return;document.body.classList.add("modal-open");let e=Te(),t=F.SERVICE_COLORS[e]||"";st.classList.remove(...F.SERVICE_COLORS),t&&st.classList.add(t),V.classList.remove(F.HIDDEN),requestAnimationFrame(()=>V.classList.add(F.VISIBLE)),bt?.focus()}function Bt(){V&&(document.body.classList.remove("modal-open"),V.classList.remove(F.VISIBLE),setTimeout(()=>V.classList.add(F.HIDDEN),nr))}function cr(e){V?.classList.contains(F.VISIBLE)&&!st?.contains(e.target)&&Bt()}function lr(){C&&(C.setAttribute("capture","environment"),C.click(),Bt())}function dr(){C&&(C.removeAttribute("capture"),C.click(),Bt())}function Ii(){return document.querySelector(".service:not(.hidden)")}function he(e,t){let o=Ii()?.querySelector(J.OCR_PROGRESS_CONTAINER);if(!o)return;o.classList.contains(F.HIDDEN)&&o.classList.remove(F.HIDDEN);let i=o.querySelector(J.OCR_PROGRESS_TEXT);i&&(i.textContent=t)}function ur(){let t=Ii()?.querySelector(J.OCR_PROGRESS_CONTAINER);t&&setTimeout(()=>t.classList.add(F.HIDDEN),or)}async function mr(e){try{let t=await createImageBitmap(e),{width:n,height:o}=t;if(Math.max(n,o)<=Ln)return t.close(),e;let i=Math.min(Ln/n,Ln/o),s=Math.round(n*i),a=Math.round(o*i),r=document.createElement("canvas");r.width=s,r.height=a;let c=r.getContext("2d");if(!c)throw new Error("No contexto 2D.");return c.drawImage(t,0,0,s,a),t.close(),new Promise(d=>r.toBlob(d,Si,tr))}catch(t){throw u("Error al procesar la imagen.","error"),t}}async function Er(e){try{let t=await createImageBitmap(e),n=document.createElement("canvas");n.width=t.width,n.height=t.height;let o=n.getContext("2d");if(!o)throw new Error("No contexto 2D.");return o.drawImage(t,0,0),t.close(),o.filter="grayscale(100%) contrast(180%) brightness(110%)",o.drawImage(t,0,0),new Promise(i=>n.toBlob(i,Si,1))}catch(t){throw u("Error al mejorar la imagen.","error"),t}}function hi(e,t,n){let o=document.getElementById(e);if(o){o.value=t;let i=new Event("input",{bubbles:!0,cancelable:!0});o.dispatchEvent(i)}}function fr(e){if(!e||!e.trim()){u("No se reconoci\xF3 texto.","warning");return}let t=Te(),n=Jo(t)||"3.6",o=`-${t+1}`,i={},s=e.split(`
`),a=e.toLowerCase().replace(/ +/g," ");if(Object.values(sr).forEach(c=>{if((n==="3.11"||n==="3.22")&&c.id==="destinationTime")return;let d=null;if(c.lineKeywordRegex){for(let l of s)if(c.lineKeywordRegex.test(l.toLowerCase())){let E=l.replace(/\D/g,"");if(E.length>=6){let v=E.slice(-6);d=[null,`${v.slice(0,2)}:${v.slice(2,4)}:${v.slice(4,6)}`];break}}}else c.valueRegex&&(d=a.match(c.valueRegex));if(d&&d[1]){let l=rr(d[1].trim());if(l&&!i[c.id]){let E=`${c.fieldIdSuffix}${o}`;hi(E,l,c.label),i[c.id]=c}}}),!i.endTime&&(i.originTime||i.destinationTime)){let c=new Date,d=String(c.getHours()).padStart(2,"0"),l=String(c.getMinutes()).padStart(2,"0"),E=`${d}:${l}`,v=`end-time${o}`;hi(v,E,"Hora Final (Actual)");let b=document.getElementById(v);b&&(b.classList.add("input-warning"),b.addEventListener("focus",()=>b.classList.remove("input-warning"),{once:!0}))}if(Object.keys(i).length>0){let c=Object.values(i).map(d=>d.label);u(`Campos actualizados: ${c.join(", ")}.`,"success")}else u("No se encontraron horas relevantes.","info")}function vi(){if(gi||(V=document.getElementById(J.CAMERA_MODAL),st=V?.querySelector(J.MODAL_CONTENT),bt=document.getElementById(J.OPTION_CAMERA),Nn=document.getElementById(J.OPTION_GALLERY),C=document.getElementById(J.CAMERA_INPUT),!V||!bt||!Nn||!C))return;document.querySelectorAll(J.OCR_SCAN_BTN).forEach(t=>t.addEventListener("click",ar)),bt.addEventListener("click",lr),Nn.addEventListener("click",dr),C.addEventListener("change",pr),document.addEventListener("click",cr),document.addEventListener("keydown",t=>{t.key==="Escape"&&V?.classList.contains(F.VISIBLE)&&Bt()}),gi=!0}function gr(){window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}async function pr(e){if(Cn){u("Proceso OCR ya en marcha.","warning");return}let t=e.target.files?.[0];if(!t)return;if(!t.type.startsWith("image/")){u("Selecciona una imagen.","error"),C&&(C.value="");return}let n=fi*1024*1024;if(t.size>n){u(`La imagen es demasiado grande (m\xE1x. ${fi} MB).`,"error"),C&&(C.value="");return}Cn=!0,An(!0),he(0,"Preparando imagen..."),gr();let o=null;try{let i=await mr(t);i=await Er(i),he(5,"Cargando motor OCR..."),pi||await new Promise((a,r)=>{let c=document.createElement("script");_e(c),c.src="https://cdn.jsdelivr.net/npm/tesseract.js@6/dist/tesseract.min.js",c.onload=()=>{pi=!0,a()},c.onerror=r,document.head.appendChild(c)}),o=await Tesseract.createWorker(Qs,Zs,{logger:a=>{if(a.status==="recognizing text"){let r=Math.max(10,Math.floor(a.progress*100));he(r,`Reconociendo texto ${r}%...`)}else a.status==="loading language model"&&he(5,"Cargando modelo de idioma...")}}),await o.setParameters(ir),he(10,"Reconociendo texto 10%...");let{data:{text:s}}=await o.recognize(i);he(100,"An\xE1lisis completado."),fr(s)}catch(i){u(`Error de escaneo: ${i.message||"Desconocido"}`,"error"),he(0,"Error en el escaneo.")}finally{o&&await o.terminate(),C&&(C.value=""),ur(),An(!1),Cn=!1}}var _i="anonymousUserId";function Di(){try{let e=localStorage.getItem(_i);return e||(e=`user-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,localStorage.setItem(_i,e)),e}catch{return`temp-user-${Date.now()}`}}var yi=document.getElementById("save-pill"),He=document.querySelector(".tab-content-container"),Ge=0,Ai=!1,Tr=10,hr=150,Sr=He&&parseInt(window.getComputedStyle(He).paddingBottom,10)||60;function On(e=Ge){Ai=e>hr,Ai?(yi.style.bottom=`calc(${e}px + ${Tr}px + env(safe-area-inset-bottom, 0px))`,He&&(He.style.paddingBottom=`${e+50}px`)):(yi.style.bottom="calc(20px + env(safe-area-inset-bottom, 0px))",He&&(He.style.paddingBottom=`${Sr}px`))}if("virtualKeyboard"in navigator)navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",e=>{Ge=e.target.boundingRect.height,On(Ge)});else{let e=window.innerHeight;window.addEventListener("resize",()=>{window.innerHeight<e?(Ge=e-window.innerHeight,On(Ge)):(Ge=0,On(0))})}var Ir=document.querySelectorAll('input:not([type="checkbox"]), select, textarea');function vr(e){let t=e.target;t.closest(".modal")||setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"center"})},250)}Ir.forEach(e=>{e.addEventListener("focus",vr)});var Li="notes-selected-service",_r="notes-modal",Dr="notes-title",yr="notes-textarea",Ar="notes-save",Lr="notes-cancel",Nr="notes-char-counter",$e,bn,I,wt,Rn,Se,rt=null,at=null,ct=null;function Ni(){let e=document.getElementById(Li);if(!e){console.warn(`Notes Service: Bot\xF3 amb ID '${Li}' no trobat.`);return}if($e=document.getElementById(_r),bn=document.getElementById(Dr),I=document.getElementById(yr),wt=document.getElementById(Ar),Rn=document.getElementById(Lr),Se=document.getElementById(Nr),!$e||!bn||!I||!wt||!Rn||!Se){console.error("Notes Service: Un o m\xE9s elements del modal de notes no s'han trobat.");return}e.addEventListener("click",()=>{let t=Te();Cr(t)}),Rn.addEventListener("click",Bn),console.log("Funcionalitat 'Afegir Notes' configurada.")}function Cr(e){if(!$e)return;bn.textContent=`S${e+1}: Observaciones`,I.value=W[e]||"";let t=I.maxLength,n=()=>{let o=I.value.length;Se.textContent=`${o} / ${t}`,Se.classList.remove("warning","limit"),I.classList.remove("input-warning","input-error"),o>=t?(Se.classList.add("limit"),I.classList.add("input-error")):o>t*.8&&(Se.classList.add("warning"),I.classList.add("input-warning"))};n(),at=()=>{I.value.length>t&&(I.value=I.value.slice(0,t)),n()},I.addEventListener("input",at),ct=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),I.blur())},I.addEventListener("keydown",ct),rt=()=>{let o=I.value.trim(),i=W[e]||"";if(o===i){Bn();return}W[e]=o,o?u("Observaci\xF3n guardada.","success"):u("Observaci\xF3n eliminada.","info"),Bn(),j()},wt.addEventListener("click",rt),$e.style.display="block",document.body.classList.add("modal-open"),setTimeout(()=>{I.focus({preventScroll:!0}),I.setSelectionRange(I.value.length,I.value.length)},0)}function Bn(){$e&&(rt&&(wt.removeEventListener("click",rt),rt=null),at&&(I.removeEventListener("input",at),at=null),ct&&(I.removeEventListener("keydown",ct),ct=null),Se.classList.remove("warning","limit"),I.classList.remove("input-warning","input-error"),$e.style.display="none",document.body.classList.remove("modal-open"))}var Or=e=>{let n=`; ${document.cookie}`.split(`; ${e}=`);if(n.length===2)return n.pop()?.split(";").shift()},Ci=(e,t,n)=>{let o=new Date;o.setTime(o.getTime()+n*24*60*60*1e3);let i=`expires=${o.toUTCString()}`;document.cookie=`${e}=${t};${i};path=/;SameSite=Lax;Secure`},je,wn,Pn;function Rr(){let e=document.createElement("script");_e(e),e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-23SXKMLR75",document.head.appendChild(e),e.onload=()=>{window.gtag("js",new Date),window.gtag("config","G-23SXKMLR75")}}function br(){Rr(),Ci("cookie_consent","granted",365),Oi()}function Br(){typeof window.gtag=="function"&&window.gtag("consent","update",{analytics_storage:"denied"}),Ci("cookie_consent","denied",365),Oi()}function wr(){je&&je.classList.remove("hidden")}function Oi(){je&&je.classList.add("hidden")}function Ri(){if(je=document.getElementById("cookie-consent-banner"),wn=document.getElementById("accept-cookies"),Pn=document.getElementById("decline-cookies"),!je||!wn||!Pn){console.warn("Elements del b\xE0ner de cookies no trobats.");return}Or("cookie_consent")||(wr(),wn.addEventListener("click",br),Pn.addEventListener("click",Br))}var Pr="openDonation",Mr="userSelectedServiceType";function xr(){let e=document.getElementById(Pr);if(!e)return console.warn("No s'ha trobat l'enlla\xE7 de donaci\xF3.");let t=Di();try{let n=new URL(e.href);n.searchParams.set("custom",t),e.href=n.toString(),console.log("Enlla\xE7 de donaci\xF3 actualitzat amb ID an\xF2nim.")}catch(n){console.error("Error modificant l'URL de donaci\xF3:",n)}}function Ur(){let e=document.getElementById("offline-indicator");if(!e)return;function t(){navigator.onLine?e.hidden=!0:e.hidden=!1}t(),window.addEventListener("online",t),window.addEventListener("offline",t)}async function bi(){try{console.log("initializeApp() iniciant..."),Wn(),zn(),await Xn(),Ko(),lo(),Re.init(),vi(),Vn(),ro(),oi(),si(),Ni(),Bo(),ri(),ai(),Ei(),ni(),xr(),di(),io(),Xo(),qo(),Wo();let e=document.getElementById("service-type");if(e){let t=localStorage.getItem(Mr);(t==="TSU"||t==="TSNU")&&(e.value=t,console.log(`[LocalStorage] Carregat tipus de servei: ${t}`)),Ue(e.value)}pe(),Kn(),Ri(),Ur(),console.log("initializeApp() completada.")}catch(e){console.error("Error en la inicialitzaci\xF3 de l'app:",e)}}async function Bi(){try{document.body.classList.add("app-ready"),document.body.classList.remove("no-js"),await bi(),To()}catch(e){console.error("Error cr\xEDtic en startApp:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Bi):Bi();console.log("App.js carregat, esperant DOMContentLoaded per inicialitzar...");})();
