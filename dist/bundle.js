(()=>{var Fn="onboardingCompleted";function Vn(){let e=document.getElementById("onboarding-container");if(!e)return;if(!JSON.parse(localStorage.getItem(Fn)||"false"))e.classList.remove("hidden");else return;window.addEventListener("load",()=>{e.classList.add("onboarding-loaded")});let n=document.querySelectorAll(".onboarding-slide"),o=document.querySelectorAll(".nav-dot"),i=document.getElementById("onboarding-finish-btn"),s=document.getElementById("onboarding-skip-btn"),a=0;function r(f){n.forEach((_,B)=>{_.classList.toggle("active",B===f)}),o.forEach((_,B)=>{_.classList.toggle("active",B===f)})}function c(){a<n.length-1&&(a++,r(a),navigator.vibrate&&navigator.vibrate(10))}function d(){e.classList.add("hidden"),localStorage.setItem(Fn,JSON.stringify(!0)),navigator.vibrate&&navigator.vibrate([50,50,50])}e.addEventListener("click",f=>{f.target.closest("button, a, .nav-dot")||c()});let l=0;e.addEventListener("touchstart",f=>{l=f.changedTouches[0].screenX},{passive:!0}),e.addEventListener("touchend",f=>{f.changedTouches[0].screenX<l-50&&c()}),i.addEventListener("click",d),s.addEventListener("click",d)}var Fi="DietasDB";var $="dietas",Gn="dateIndex",M=null;function Hn(){return new Promise((e,t)=>{let n=indexedDB.open(Fi,1);n.onupgradeneeded=o=>{let i=o.target.result,s;i.objectStoreNames.contains($)?s=o.target.transaction.objectStore($):s=i.createObjectStore($,{keyPath:"id"}),s.indexNames.contains(Gn)||s.createIndex(Gn,"date",{unique:!1})},n.onsuccess=o=>{M=o.target.result,M.onclose=()=>M=null,M.onerror=()=>M=null,M.onversionchange=()=>M.close(),e(M)},n.onerror=o=>t(o.target.error),n.onblocked=()=>t(new Error("IndexedDB bloquejat per una altra pestanya"))})}async function je(e="readonly"){return(M??(M=await Hn())).transaction($,e)}function qe(e,t){return new Promise((n,o)=>{e.onsuccess=i=>n(i.target.result),e.onerror=i=>o(new Error(`${t}: ${i.target.error}`))})}function Ut(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onerror=()=>n(e.error),e.onabort=()=>n(e.error)})}async function kt(e){let t=await je("readwrite");return qe(t.objectStore($).add(e),"No s'ha pogut afegir"),await Ut(t),e.id}async function $n(e){let t=await je("readwrite");return qe(t.objectStore($).put(e),"No s'ha pogut actualitzar"),await Ut(t),e.id}async function Z(e){if(!e)return;let t=await je();return qe(t.objectStore($).get(e),"Error obtenint dieta")}async function dt(){let e=await je();return qe(e.objectStore($).getAll(),"Error llistant dietes")}async function Xn(e){if(!e)return;let t=await je("readwrite");qe(t.objectStore($).delete(e),"Error eliminant dieta"),await Ut(t)}async function jn(){return M??(M=await Hn())}var de={DATE_INPUT:"date",DIET_TYPE_SELECT:"diet-type",TOP_BAR:".top-bar",FOOTER:"footer",EASTER_EGG_OVERLAY:".easter-egg-overlay",EASTER_EGG_ICON:".easter-egg-icon"},ut={LUNCH:"lunch",DINNER:"dinner"},qn={[ut.LUNCH]:"comida",[ut.DINNER]:"cena",DEFAULT:"dieta"},le={TOP_BAR:3,FOOTER:2,TIMEOUT:1e3,ANIMATION_DURATION:1e3};function Wn(){let e=document.getElementById(de.DATE_INPUT);if(!e){console.warn("Utils: Input de data no trobat.");return}try{e.valueAsDate=new Date}catch(t){console.error("Error establint la data d'avui:",t)}}function Yn(e){return typeof e!="string"||!e?"":e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function De(e){return e?e.split(" ").map(t=>t.includes(".")?t.toUpperCase():t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):""}function Ft(){let e=new Date().getHours();return e>=6&&e<18?ut.LUNCH:ut.DINNER}function zn(){let e=document.getElementById(de.DIET_TYPE_SELECT);if(!e){console.warn("Utils: Select de tipus de dieta no trobat.");return}e.value=Ft()}function Vt(e,t){let n="Data inv\xE0lida";if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e))try{let i=e.split("-"),s=i[0].slice(-2);n=`${i[2]}/${i[1]}/${s}`}catch(i){console.error("Error formatant data:",i)}let o=qn[t]||qn.DEFAULT;return{ddmmaa:n,franjaText:o}}var L={topBarTaps:0,footerTaps:0,tapTimeoutId:null};function _e(){L.topBarTaps=0,L.footerTaps=0,L.tapTimeoutId&&(clearTimeout(L.tapTimeoutId),L.tapTimeoutId=null)}function Vi(){if(document.querySelector(de.EASTER_EGG_OVERLAY))return;let e=document.createElement("div");e.className=de.EASTER_EGG_OVERLAY.substring(1);let t=document.createElement("div");t.className=de.EASTER_EGG_ICON.substring(1),t.innerHTML='<img src="assets/icons/egg.svg" alt="Easter Egg">',e.appendChild(t),document.body.appendChild(e);let n=o=>{o.stopPropagation(),t.classList.add("clicked"),setTimeout(()=>e.remove(),le.ANIMATION_DURATION)};e.addEventListener("click",n)}function Kn(){let e=document.querySelector(de.TOP_BAR),t=document.querySelector(de.FOOTER);if(!e||!t){console.warn("Easter Egg: No s'han trobat top bar o footer.");return}e.addEventListener("touchend",n=>{n.changedTouches.length===1?(L.topBarTaps++,L.tapTimeoutId&&clearTimeout(L.tapTimeoutId),L.tapTimeoutId=setTimeout(_e,le.TIMEOUT),L.topBarTaps>le.TOP_BAR&&_e()):_e()}),t.addEventListener("touchend",n=>{L.topBarTaps===le.TOP_BAR&&n.changedTouches.length===1&&(L.footerTaps++,L.tapTimeoutId&&clearTimeout(L.tapTimeoutId),L.tapTimeoutId=setTimeout(_e,le.TIMEOUT),L.footerTaps===le.FOOTER?(Vi(),_e()):L.footerTaps>le.FOOTER&&_e())})}function Gt(e,t){let n,o=function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)};return o.cancel=()=>clearTimeout(n),o}var N={CONTAINER_ID:"toast-container",TOAST_CLASS:"toast",DEFAULT_DURATION:3e3,DEFAULT_TYPE:"info",ALLOWED_TYPES:["info","success","error","warning"],MAX_QUEUE_SIZE:10,ANIMATION:{ENTER:"toast-enter",EXIT:"toast-exit"},UNDO_BTN_CLASS:"toast-undo-btn",DEFAULT_PRIORITY:1},S={queue:[],isVisible:!1,container:null,currentTimeout:null},Gi=e=>e&&typeof e=="string"?e.replace(/[<>&]/g,""):"";function Hi(e,t,n){if(!e||typeof e!="string"||!e.trim())throw new Error("El missatge del toast \xE9s obligatori i ha de ser una cadena no buida.");if(!N.ALLOWED_TYPES.includes(t))throw new Error(`Tipus de toast inv\xE0lid: ${t}. Ha de ser un de: ${N.ALLOWED_TYPES.join(", ")}`);if(!Number.isInteger(n)||n<0||n>6e4)throw new Error("La durada ha d'estar entre 0 i 60000\u202Fms.")}function $i(){return!S.container&&(S.container=document.getElementById(N.CONTAINER_ID),!S.container)?(console.error(`[Toast] Contenidor '#${N.CONTAINER_ID}' no trobat.`),null):S.container}function Ht(e){S.currentTimeout&&(clearTimeout(S.currentTimeout),S.currentTimeout=null),e&&(e.classList.add(N.ANIMATION.EXIT),e.addEventListener("transitionend",()=>e.remove(),{once:!0})),S.isVisible=!1,Jn()}function Xi({message:e,type:t,duration:n,options:o}){let i=$i();if(!i)return;let s=document.createElement("div");s.className=`${N.TOAST_CLASS} ${t}`,s.setAttribute("role","alert"),s.setAttribute("aria-live","polite"),s.setAttribute("aria-atomic","true"),s.textContent=Gi(e);let a=!0;if(o?.undoCallback instanceof Function){let r=document.createElement("button");r.type="button",r.className=N.UNDO_BTN_CLASS,r.textContent="Deshacer",r.setAttribute("aria-label","Deshacer la acci\xF3n"),r.addEventListener("click",()=>{a=!1;try{o.undoCallback()}finally{Ht(s)}}),s.appendChild(r)}i.appendChild(s),requestAnimationFrame(()=>{s.classList.add(N.ANIMATION.ENTER)}),S.currentTimeout=setTimeout(()=>{a&&o?.onExpire instanceof Function&&o.onExpire(),Ht(s)},n)}function Jn(){S.isVisible||S.queue.length===0||(S.isVisible=!0,S.queue.sort((e,t)=>t.priority-e.priority),Xi(S.queue.shift()))}function m(e,t=N.DEFAULT_TYPE,n=N.DEFAULT_DURATION,o={}){Hi(e,t,n);let i=o.priority??N.DEFAULT_PRIORITY,s={message:e,type:t,duration:n,priority:i,options:o};if(!(o.queueable!==!1)&&S.isVisible){if(S.container){let c=S.container.querySelector(`.${N.TOAST_CLASS}:not(.${N.ANIMATION.EXIT})`);c&&c.remove()}Ht()}S.queue.length>=N.MAX_QUEUE_SIZE&&S.queue.sort((c,d)=>c.priority-d.priority).shift();let r=S.queue.findIndex(c=>c.priority<i);r===-1?S.queue.push(s):S.queue.splice(r,0,s),ji(),Jn()}function ji(){let e="toast-undo-style";if(document.getElementById(e))return;let t=document.body.getAttribute("data-csp-nonce"),n=document.createElement("style");n.id=e,t&&n.setAttribute("nonce",t),n.textContent=`
    .${N.UNDO_BTN_CLASS} {
      margin-left: auto; 
      padding: 8px 12px; 
      background: none;
      border: none;
      border-radius: 4px; 
      cursor: pointer;     
      font-weight: 600;
      font-size: 0.875rem; 
      text-transform: uppercase; 
      letter-spacing: 0.08em; 
      color: inherit; 
      transition: background-color 0.2s ease;
    }
    .${N.UNDO_BTN_CLASS}:hover {
      background-color: rgba(255, 255, 255, 0.15); 
    }
  `,document.head.appendChild(n)}var X={DATE_INPUT:"date",DIET_TYPE_SELECT:"diet-type",SERVICE_NUMBER_PREFIX:"service-number-",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2"},no={INPUT_ERROR:"input-error"},ee={SERVICE_NUMBER_LENGTH:9,VEHICLE_MAX_LENGTH:6,PERSON_NAME_MAX_LENGTH:28,LOCATION_MAX_LENGTH:35,PERSON_NAME_ALLOWED_CHARS:/^[a-zA-Z\s'’áéíóúàèìòùäëïöüñçÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÑÇ]+$/u},Qn={PERSON_INPUT_GROUP:".input-with-icon"};function ue(e){e?.classList.add(no.INPUT_ERROR)}function ye(e){e?.classList.remove(no.INPUT_ERROR)}function Zn(e){if(!e||e.length===0)return"";let t=e.map(n=>`S${n}`);return t.length===1?t[0]:t.length===2?t.join(" y "):`${t.slice(0,-1).join(", ")} y ${t[t.length-1]}`}function We(e){!e||e.dataset.errorListenerAttached||(e.addEventListener("input",()=>ye(e),{once:!0}),e.dataset.errorListenerAttached="true")}function eo(e,t,n,o){if(!e)return!0;ye(e);let i=e.value.trim(),s=!1;return i?/^\d+$/.test(i)?i.length!==ee.SERVICE_NUMBER_LENGTH&&(o.digitLength.push(t),s=!0):(o.nonNumeric.push(t),s=!0):n&&(o.emptyRequiredS1=!0,s=!0),s?(ue(e),We(e),!1):!0}function qi(e){let t=[];return e.nonNumeric.length>0&&t.push(`El n\xFAmero de servicio ${Zn(e.nonNumeric)} debe contener solo d\xEDgitos.`),e.digitLength.length>0&&t.push(`El n\xFAmero de servicio ${Zn(e.digitLength)} debe tener ${ee.SERVICE_NUMBER_LENGTH} d\xEDgitos.`),t}function mt(){let e=!0;return[document.getElementById(X.DATE_INPUT),document.getElementById(X.DIET_TYPE_SELECT)].filter(Boolean).forEach(n=>{ye(n),n.value.trim()||(ue(n),We(n),e=!1)}),e}function Et(){let e={emptyRequiredS1:!1,nonNumeric:[],digitLength:[]},t=!0,n=document.getElementById(`${X.SERVICE_NUMBER_PREFIX}1`);if(!n)return console.error("Validation: No se ha encontrado el input para el servicio S1."),!1;t=eo(n,1,!0,e)&&t;for(let i=2;i<=4;i++){let s=document.getElementById(`${X.SERVICE_NUMBER_PREFIX}${i}`);s&&(t=eo(s,i,!1,e)&&t)}if(t)return!0;let o=qi(e);return o.length>0&&m(o.join(`
`),"error"),!1}function D(e){return typeof e!="string"?"":e.trim().replace(/[<>&"'`]/g,"").trim()}function ft(e){return e?/^(?:2[0-3]|[01]?[0-9]):[0-5][0-9]$/.test(e):!0}function to(e,t,n,o){let i=e?.value.trim()||"";return i&&!ee.PERSON_NAME_ALLOWED_CHARS.test(i)?(ue(t),!1):i.length>ee.PERSON_NAME_MAX_LENGTH?(ue(t),o.push(`El nombre del ${n} no puede superar los ${ee.PERSON_NAME_MAX_LENGTH} caracteres.`),!1):!0}function oo(){let e=document.getElementById(X.VEHICLE_INPUT),t=document.getElementById(X.PERSON1_INPUT),n=document.getElementById(X.PERSON2_INPUT),o=t?.closest(Qn.PERSON_INPUT_GROUP),i=n?.closest(Qn.PERSON_INPUT_GROUP);ye(e),ye(o),ye(i);let s=e?.value.trim()||"",a=t?.value.trim()||"",r=n?.value.trim()||"",c=!0,d=[];return s||(ue(e),d.push("El campo Veh\xEDculo es obligatorio."),c=!1),c=to(t,o,"Conductor",d)&&c,c=to(n,i,"Ayudante",d)&&c,!a&&!r&&(ue(o),ue(i),d.push("Debe indicar al menos un Conductor o Ayudante."),c=!1),c||(We(e),We(t),We(n),m(d.join(`
`),"error")),c}function io(){let e=ee.PERSON_NAME_ALLOWED_CHARS,t=/^[^\x00-\x1F\x7F<>&"'`]*$/u;function n(l){let f=l.target.value;e.test(f)||(l.target.value=f.replace(/[^a-zA-Z\s'’áéíóúàèìòùäëïöüñçÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÑÇ.]/g,""))}function o(l){let f=l.target.value;t.test(f)||(l.target.value=f.replace(/[<>&"'`]/g,"").trim())}function i(l){l.key==="Enter"||l.key==="Tab"||l.ctrlKey||l.metaKey||l.altKey||l.key.length>1||e.test(l.key)||l.preventDefault()}function s(l){l.key==="Enter"||l.key==="Tab"||l.ctrlKey||l.metaKey||l.altKey||l.key.length>1||t.test(l.key)||l.preventDefault()}function a(l){}[document.getElementById(X.PERSON1_INPUT),document.getElementById(X.PERSON2_INPUT)].filter(Boolean).forEach(l=>{l.addEventListener("input",n),l.addEventListener("keypress",i)}),document.querySelectorAll(".service .origin, .service .destination").forEach(l=>{l.addEventListener("input",o),l.addEventListener("keypress",s)});function d(l){l.target.value.length>ee.VEHICLE_MAX_LENGTH&&(l.target.value=l.target.value.slice(0,ee.VEHICLE_MAX_LENGTH))}}var C={DADES:"dades",SERVEIS:"serveis"},me={TAB_DADES:`tab-${C.DADES}`,TAB_SERVEIS:`tab-${C.SERVEIS}`,CONTENT_DADES:`${C.DADES}-tab-content`,CONTENT_SERVEIS:`${C.SERVEIS}-tab-content`,MAIN_CONTENT_AREA:"main-content"},Ae={ACTIVE_TAB:"active",ERROR_TAB:"error-tab"},so={MIN_DISTANCE:60,MAX_VERTICAL_RATIO:.5},Le=C.DADES,gt=0,$t=0,jt=!0;function ro(){let e=document.getElementById(me.TAB_DADES),t=document.getElementById(me.TAB_SERVEIS);!e||!t||(e.addEventListener("click",()=>Ye(C.DADES)),t.addEventListener("click",()=>Ye(C.SERVEIS)),Wi(),Ye(Le))}function qt(e){jt=!!e}function Ye(e){if(Le===e&&document.scrollingElement.scrollTop!==0){window.scrollTo({top:0,behavior:"smooth"});return}if(Le===e||e!==C.DADES&&e!==C.SERVEIS)return;window.scrollTo({top:0,behavior:"auto"}),Le=e;let t=document.getElementById(me.TAB_DADES),n=document.getElementById(me.TAB_SERVEIS),o=document.getElementById(me.CONTENT_DADES),i=document.getElementById(me.CONTENT_SERVEIS);if(!t||!n||!o||!i)return;t.classList.remove(Ae.ERROR_TAB),n.classList.remove(Ae.ERROR_TAB);let s=e===C.DADES;t.classList.toggle(Ae.ACTIVE_TAB,s),n.classList.toggle(Ae.ACTIVE_TAB,!s),o.classList.toggle(Ae.ACTIVE_TAB,s),i.classList.toggle(Ae.ACTIVE_TAB,!s),t.setAttribute("aria-selected",s?"true":"false"),n.setAttribute("aria-selected",s?"false":"true"),e===C.SERVEIS&&typeof Xt=="function"&&Xt()}function Wi(){let e=document.getElementById(me.MAIN_CONTENT_AREA);e&&(e.addEventListener("touchstart",Yi,{passive:!0}),e.addEventListener("touchend",zi,{passive:!0}))}function Yi(e){if(!jt)return;let t=e.touches[0];gt=t.clientX,$t=t.clientY}function zi(e){if(!jt||gt===0||!e.changedTouches||e.changedTouches.length===0)return;let t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY,o=t-gt,i=n-$t;gt=0,$t=0,!(Math.abs(i)>Math.abs(o)*so.MAX_VERTICAL_RATIO)&&Math.abs(o)>so.MIN_DISTANCE&&(o>0?Le===C.SERVEIS&&Ye(C.DADES):Le===C.DADES&&Ye(C.SERVEIS))}var te={MODAL:"signature-modal",CANVAS:"signature-canvas",CANCEL_BTN:"signature-cancel",ACCEPT_BTN:"signature-accept",SIGN_PERSON1_BTN:"sign-person1",SIGN_PERSON2_BTN:"sign-person2",TITLE:"signature-title"},Wt={MODAL_OPEN:"modal-open",SIGNED:"signed"},ne={LINE_WIDTH:2,LINE_CAP:"round",STROKE_STYLE:"#000000",IMAGE_FORMAT:"image/png",DOUBLE_CLICK_TIMEOUT:300,DOUBLE_TAP_TIMEOUT:300,DOUBLE_TAP_MAX_DIST:20},ao={SIGNATURE_PENDING:"assets/icons/signature.svg",SIGNATURE_OK:"assets/icons/signature_ok.svg"},co={PERSON1:"Firma del conductor",PERSON2:"Firma del ayudante"},Yt=class{constructor(){this.signatureConductor="",this.signatureAjudant="",this.currentSignatureTarget=null,this.isDrawing=!1,this.canvasContext=null,this.signatureCanvasElement=null,this.signatureModalElement=null,this.signPerson1Button=null,this.signPerson2Button=null,this.hasUserDrawn=!1,this.lastTouchTime=0,this.lastTouchX=0,this.lastTouchY=0,this.clickCount=0,this.clickTimer=null}init(){this.signatureModalElement=document.getElementById(te.MODAL),this.signatureCanvasElement=document.getElementById(te.CANVAS);let t=document.getElementById(te.CANCEL_BTN),n=document.getElementById(te.ACCEPT_BTN);this.signPerson1Button=document.getElementById(te.SIGN_PERSON1_BTN),this.signPerson2Button=document.getElementById(te.SIGN_PERSON2_BTN),!(!this.signatureModalElement||!this.signatureCanvasElement||!t||!n||!this.signPerson1Button||!this.signPerson2Button)&&(this.resizeCanvas(),this.initCanvasEvents(),t.addEventListener("click",this.closeSignatureModal.bind(this)),n.addEventListener("click",this.acceptSignature.bind(this)),this.signPerson1Button.addEventListener("click",()=>this.openSignatureModal("person1")),this.signPerson2Button.addEventListener("click",()=>this.openSignatureModal("person2")),this.signatureModalElement.addEventListener("click",o=>{o.target===this.signatureModalElement&&this.closeSignatureModal()}),window.addEventListener("resize",this.debounce(this.resizeCanvas.bind(this),150)),document.addEventListener("keydown",o=>{o.key==="Escape"&&this.signatureModalElement.style.display==="block"&&this.closeSignatureModal()}),this.updateSignatureIcons())}debounce(t,n){let o;return(...i)=>{clearTimeout(o),o=setTimeout(()=>t.apply(this,i),n)}}resizeCanvas(){if(!this.signatureCanvasElement||!this.signatureCanvasElement.parentElement)return;let t=this.signatureCanvasElement.parentElement;this.canvasContext||(this.canvasContext=this.signatureCanvasElement.getContext("2d",{willReadFrequently:!0})),this.canvasContext&&(this.signatureCanvasElement.width=t.offsetWidth,this.signatureCanvasElement.height=t.offsetHeight,this.canvasContext.lineWidth=ne.LINE_WIDTH,this.canvasContext.lineCap=ne.LINE_CAP,this.canvasContext.strokeStyle=ne.STROKE_STYLE)}clearCanvas(){!this.canvasContext||!this.signatureCanvasElement||(this.canvasContext.clearRect(0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height),this.hasUserDrawn=!1)}getEventCoordinates(t){if(!this.signatureCanvasElement)return{x:0,y:0};let n=this.signatureCanvasElement.getBoundingClientRect(),o,i;return t.touches&&t.touches.length>0?(o=t.touches[0].clientX,i=t.touches[0].clientY):(o=t.clientX,i=t.clientY),{x:o-n.left,y:i-n.top}}startDrawing(t){if(!this.canvasContext)return;this.isDrawing=!0,this.hasUserDrawn=!0,this.canvasContext.beginPath();let{x:n,y:o}=this.getEventCoordinates(t);this.canvasContext.moveTo(n,o)}draw(t){if(!this.isDrawing||!this.canvasContext)return;t.preventDefault();let{x:n,y:o}=this.getEventCoordinates(t);this.canvasContext.lineTo(n,o),this.canvasContext.stroke()}stopDrawing(){!this.isDrawing||!this.canvasContext||(this.isDrawing=!1)}handleCanvasClick(t){this.clickCount++,this.clickCount===1?this.clickTimer=setTimeout(()=>this.clickCount=0,ne.DOUBLE_CLICK_TIMEOUT):this.clickCount===2&&(clearTimeout(this.clickTimer),this.clickCount=0,t.preventDefault(),this.clearCanvas())}handleCanvasTouchEnd(t){if(t.touches.length>0)return;let n=Date.now(),o=t.changedTouches[0];if(!o)return;let{x:i,y:s}=this.getEventCoordinates({clientX:o.clientX,clientY:o.clientY}),a=n-this.lastTouchTime,r=Math.abs(i-this.lastTouchX),c=Math.abs(s-this.lastTouchY);a<ne.DOUBLE_TAP_TIMEOUT&&r<ne.DOUBLE_TAP_MAX_DIST&&c<ne.DOUBLE_TAP_MAX_DIST?(t.preventDefault(),this.clearCanvas(),this.lastTouchTime=0):(this.lastTouchTime=n,this.lastTouchX=i,this.lastTouchY=s)}initCanvasEvents(){this.signatureCanvasElement&&(this.signatureCanvasElement.addEventListener("mousedown",this.startDrawing.bind(this)),this.signatureCanvasElement.addEventListener("mousemove",this.draw.bind(this)),this.signatureCanvasElement.addEventListener("mouseup",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("mouseout",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("click",this.handleCanvasClick.bind(this)),this.signatureCanvasElement.addEventListener("touchstart",this.startDrawing.bind(this),{passive:!1}),this.signatureCanvasElement.addEventListener("touchmove",this.draw.bind(this),{passive:!1}),this.signatureCanvasElement.addEventListener("touchend",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("touchcancel",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("touchend",this.handleCanvasTouchEnd.bind(this),{passive:!1}))}openSignatureModal(t){if(!this.signatureModalElement||!this.canvasContext)return;qt(!1),this.currentSignatureTarget=t;let n=document.getElementById(te.TITLE);n&&(n.textContent=t==="person1"?co.PERSON1:co.PERSON2),this.signatureModalElement.style.display="block",document.body.classList.add(Wt.MODAL_OPEN),this.resizeCanvas(),this.clearCanvas();let o=t==="person1"?this.signatureConductor:this.signatureAjudant;o&&this.drawSignatureFromDataUrl(o),document.getElementById(te.ACCEPT_BTN)?.focus()}closeSignatureModal(){this.signatureModalElement&&(qt(!0),this.signatureModalElement.style.display="none",document.body.classList.remove(Wt.MODAL_OPEN),this.currentSignatureTarget=null,(this.currentSignatureTarget==="person1"?this.signPerson1Button:this.signPerson2Button)?.focus())}isCanvasEmpty(){if(!this.canvasContext||!this.signatureCanvasElement)return!0;try{return!new Uint32Array(this.canvasContext.getImageData(0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height).data.buffer).some(n=>n!==0)}catch{return!1}}acceptSignature(){if(!this.canvasContext||!this.signatureCanvasElement||!this.currentSignatureTarget)return;let t=this.isCanvasEmpty(),n=t?"":this.signatureCanvasElement.toDataURL(ne.IMAGE_FORMAT),o=null;this.currentSignatureTarget==="person1"?(this.signatureConductor=n,o=this.signPerson1Button):this.currentSignatureTarget==="person2"&&(this.signatureAjudant=n,o=this.signPerson2Button),this.updateSignatureUI(o,!t),this.closeSignatureModal(),j()}drawSignatureFromDataUrl(t){if(!this.canvasContext||!t)return;let n=new Image;n.onload=()=>this.canvasContext.drawImage(n,0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height),n.onerror=()=>{},n.src=t}updateSignatureUI(t,n){if(!t)return;let o=t.querySelector(".icon");o&&(t.classList.toggle(Wt.SIGNED,n),o.src=n?ao.SIGNATURE_OK:ao.SIGNATURE_PENDING)}updateSignatureIcons(){this.updateSignatureUI(this.signPerson1Button,!!this.signatureConductor),this.updateSignatureUI(this.signPerson2Button,!!this.signatureAjudant)}getSignatureConductor(){return this.signatureConductor}getSignatureAjudant(){return this.signatureAjudant}setSignatureConductor(t){this.signatureConductor=t||"",this.updateSignatureUI(this.signPerson1Button,!!this.signatureConductor)}setSignatureAjudant(t){this.signatureAjudant=t||"",this.updateSignatureUI(this.signPerson2Button,!!this.signatureAjudant)}},ze=new Yt,lo=()=>ze.init(),pt=()=>ze.getSignatureConductor(),Tt=()=>ze.getSignatureAjudant(),ht=e=>ze.setSignatureConductor(e),St=e=>ze.setSignatureAjudant(e);function Ki(){let e="dietSalt",t=(o=16)=>Array.from({length:o},()=>Math.floor(Math.random()*256).toString(16).padStart(2,"0")).join(""),n=localStorage.getItem(e);if(!n){if(window.crypto?.getRandomValues){let o=crypto.getRandomValues(new Uint8Array(16));n=Array.from(o).map(i=>i.toString(16).padStart(2,"0")).join("")}else console.warn("[pseudoId] crypto.getRandomValues no disponible; usant Math.random() (menys segur, nom\xE9s mode desenvolupament)."),n=t(16);localStorage.setItem(e,n)}return n}async function Ne(e){if(!window.crypto?.subtle)return console.warn("[pseudoId] WebCrypto no disponible (context no segur). S\u2019usar\xE0 l\u2019ID en clar nom\xE9s en aquesta sessi\xF3."),e;let n=new TextEncoder().encode(Ki()+e),o=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(o)).map(i=>i.toString(16).padStart(2,"0")).join("")}var zt=new Intl.RelativeTimeFormat("es",{numeric:"auto"});function uo(e){if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("La data proporcionada no \xE9s v\xE0lida.");let t=Date.now()-e.getTime();if(t<0)return"en el futuro";let n=Math.round(t/1e3);if(n<45)return"hace unos segundos";if(n<90)return"hace un minuto";let o=Math.round(n/60);if(o<60)return zt.format(-o,"minute");let i=Math.round(o/60);if(i<24)return zt.format(-i,"hour");let s=Math.round(i/24);return zt.format(-s,"day")}var P={IS_INSTALLED:"pwa_isInstalled",PROMPT_DISMISSED_COUNT:"pwa_promptDismissedCount",NEVER_SHOW_AGAIN:"pwa_neverShowAgain",ACTION_TRIGGER_COUNT:"pwa_actionTriggerCount"},fo=2,mo=10,Ee=null,Kt=null,Jt=null,fe=null,Eo=!1,Qt=(e,t=0)=>parseInt(localStorage.getItem(e)||String(t),10),Zt=e=>localStorage.getItem(e)==="true",ge=(e,t)=>localStorage.setItem(e,String(t));function go(){let e=window.matchMedia("(display-mode: standalone)").matches,t=window.navigator.standalone===!0;return e||t||Zt(P.IS_INSTALLED)}function Ji(e=!1){if(console.log("[PWA] Intentant mostrar el b\xE0ner d'instal\xB7laci\xF3..."),go()){console.log("[PWA] Bloquejat: L'app ja est\xE0 instal\xB7lada.");return}if(Zt(P.NEVER_SHOW_AGAIN)){console.log("[PWA] Bloquejat: L'usuari ha demanat no tornar a mostrar.");return}if(!Ee){console.log("[PWA] Bloquejat: No hi ha cap event d'instal\xB7laci\xF3 guardat.");return}if(!fe){console.log("[PWA] Bloquejat: L'element HTML del b\xE0ner no s'ha trobat.");return}console.log("%c[PWA] Mostrant el b\xE0ner!","color: green; font-weight: bold;"),fe.classList.add("visible"),fe.classList.remove("hidden")}function po(){console.log("[PWA] Amagant el b\xE0ner."),fe?.classList.remove("visible"),fe?.classList.add("hidden")}function Qi(){console.log("[PWA] L'usuari ha descartat el b\xE0ner."),po();let e=Qt(P.PROMPT_DISMISSED_COUNT);e++,ge(P.PROMPT_DISMISSED_COUNT,e),console.log(`[PWA] Comptador de descartats actualitzat a: ${e}`),e>=fo&&(ge(P.NEVER_SHOW_AGAIN,!0),console.log("%c[PWA] S'ha assolit el l\xEDmit de descartats. No es tornar\xE0 a mostrar.","color: orange;"))}async function Zi(){if(console.log("[PWA] L'usuari ha fet clic a 'Instal\xB7lar'."),!Ee){console.warn("[PWA] El bot\xF3 d'instal\xB7lar s'ha premut, per\xF2 no hi havia cap event guardat.");return}po();try{Ee.prompt();let{outcome:e}=await Ee.userChoice;console.log(`[PWA] Resultat de la decisi\xF3 de l'usuari: ${e}`),e==="accepted"?(ge(P.IS_INSTALLED,!0),ge(P.NEVER_SHOW_AGAIN,!0),console.log("%c[PWA] L'usuari ha acceptat la instal\xB7laci\xF3! :)","color: green; font-weight: bold;")):console.log("[PWA] L'usuari ha rebutjat la instal\xB7laci\xF3 des del di\xE0leg del navegador.")}catch(e){console.error("[PWA] Error durant el proc\xE9s de prompt d'instal\xB7laci\xF3:",e)}finally{Ee=null}}function es(e){e.preventDefault(),Ee=e,console.log("%c[PWA] Event 'beforeinstallprompt' capturat i guardat.","color: blue;")}function To(){Eo||(console.log("[PWA] Inicialitzant el gestor d'instal\xB7laci\xF3..."),fe=document.getElementById("install-prompt"),Kt=document.getElementById("install-button"),Jt=document.getElementById("dismiss-button"),fe&&Kt&&Jt?(Kt.addEventListener("click",Zi),Jt.addEventListener("click",Qi),console.log("[PWA] Botons del b\xE0ner d'instal\xB7laci\xF3 configurats.")):console.warn("[PWA] No s'han trobat tots els elements del b\xE0ner d'instal\xB7laci\xF3."),window.addEventListener("beforeinstallprompt",es),window.matchMedia("(display-mode: standalone)").addEventListener("change",e=>{e.matches&&(console.log("[PWA] Detectat canvi a mode 'standalone'. Marcat com instal\xB7lat."),ge(P.IS_INSTALLED,!0),ge(P.NEVER_SHOW_AGAIN,!0))}),Eo=!0,console.log("[PWA] Gestor d'instal\xB7laci\xF3 inicialitzat correctament."))}function ho(){if(console.log("------------------------------------------"),console.log("[PWA] Comprovant si s'ha de mostrar el b\xE0ner despr\xE9s d'una acci\xF3..."),go()){console.log("[PWA Check] No es mostra: L'app ja est\xE0 instal\xB7lada.");return}if(Zt(P.NEVER_SHOW_AGAIN)){console.log("[PWA Check] No es mostra: L'usuari ha demanat no tornar a veure'l.");return}if(!Ee){console.log("[PWA Check] No es mostra: El navegador no ha ofert la possibilitat d'instal\xB7lar (deferredPrompt \xE9s nul).");return}let e=Qt(P.ACTION_TRIGGER_COUNT);e++,ge(P.ACTION_TRIGGER_COUNT,e),console.log(`[PWA] Comptador d'accions incrementat a: ${e}`);let t=Qt(P.PROMPT_DISMISSED_COUNT);console.log(`[PWA] Vegades que s'ha descartat el b\xE0ner: ${t}`);let n=e===1&&t===0||e>=mo&&t<fo;console.log(`[PWA] Es compleixen les condicions per mostrar? ${n}`),n?(setTimeout(()=>Ji(),1500),e>=mo):console.log("[PWA] No es mostra el b\xE0ner aquesta vegada."),console.log("------------------------------------------")}var Ce={OUTER_MARGIN:55,INNER_PADDING:10},It={DADES_TAB:"tab-dades",SERVEIS_TAB:"tab-serveis"},oe={ERROR_TAB:"error-tab"},q={TEMPLATE_URLS:{DEFAULT:"./dieta.pdf"},SERVICE_Y_OFFSET:82,SIGNATURE_WIDTH:100,SIGNATURE_HEIGHT:50,WATERMARK_TEXT:"misdietas.com",DEFAULT_FILENAME:"dieta.pdf",SERVICE_NUMBER_COLOR:"#004aad",MODE_PREFIX_TEXT_COLOR:"#8B0000",MAX_SIGNATURE_NAME_LENGTH:31},E={general:{date:{x:155,y:732,size:16,color:"#000000"},vehicleNumber:{x:441,y:732,size:16,color:"#000000"},person1:{x:65,y:368,size:16,color:"#000000"},person2:{x:310,y:368,size:16,color:"#000000"}},service:{serviceNumber:{x:130,y:715,size:16,color:"#000000"},origin:{x:232,y:698,size:16,color:"#000000"},originTime:{x:441,y:698,size:16,color:"#000000"},destination:{x:232,y:683,size:16,color:"#000000"},destinationTime:{x:441,y:681,size:16,color:"#000000"},endTimeNormal:{x:441,y:665,size:16,color:"#000000"},endTimeModeText:{x:390,y:665,size:16,color:q.MODE_PREFIX_TEXT_COLOR},endTimeValueWhenPrefixed:{x:441,y:665,size:16,color:"#000000"}},signature:{conductor:{x:125,y:295,width:100,height:50},ayudante:{x:380,y:295,width:100,height:50}},notesSection:{title:{x:65,y:250,size:16,color:"#000000"},lineHeight:18,maxWidth:465,start:{x:65,y:230,size:16,color:"#333333"}},fixedText:{website:{x:250,y:20,size:6,color:"#EEEEEE"}}};function ts(e){return!e||typeof e!="string"||e.trim()===""?"":e.split(/\s+/).filter(Boolean).map(t=>t.includes("-")?t.split("-").map(n=>n?n.charAt(0).toUpperCase()+n.slice(1).toLowerCase():"").join("-"):t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")}function ns(e){if(!e||typeof e!="string")return{r:0,g:0,b:0};let t=e.replace("#","");if(t.length!==6)return{r:0,g:0,b:0};let n=parseInt(t,16);return isNaN(n)?{r:0,g:0,b:0}:{r:n>>16&255,g:n>>8&255,b:n&255}}function en(e){if(!e||!/^\d{4}-\d{2}-\d{2}$/.test(e))return"";let[t,n,o]=e.split("-");return`${o}/${n}/${t}`}function os(){return q.TEMPLATE_URLS.DEFAULT}function is(e,t){let n=document.getElementById(It.DADES_TAB),o=document.getElementById(It.SERVEIS_TAB);n?.classList.remove(oe.ERROR_TAB),o?.classList.remove(oe.ERROR_TAB);let i="";!e&&!t?(i="Completa els camps obligatoris a Dades i Serveis.",n?.classList.add(oe.ERROR_TAB),o?.classList.add(oe.ERROR_TAB)):e?(i="Completa els camps obligatoris a Serveis.",o?.classList.add(oe.ERROR_TAB)):(i="Completa els camps obligatoris a Dades.",n?.classList.add(oe.ERROR_TAB)),i&&m(i,"error")}function So(e,t){let n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(n),500)}async function Io(e,t){if(!e||!Array.isArray(t))throw new Error("Dades inv\xE0lides.");if(!window.PDFLib)throw new Error("PDFLib no carregada.");let{PDFDocument:n,StandardFonts:o,rgb:i}=window.PDFLib,s=os(),a=await fetch(s).then(g=>g.arrayBuffer()),r=await n.load(a),c=await r.embedFont(o.Helvetica),d=r.getPages()[0],l=g=>{let{r:H,g:p,b:R}=ns(g);return i(H/255,p/255,R/255)};Object.entries(E.general).forEach(([g,H])=>{let p=e[g]||"";g==="date"&&(p=en(p)),g==="vehicleNumber"&&(p=p.toUpperCase()),(g==="person1"||g==="person2")&&(p=ts(p),p.length>q.MAX_SIGNATURE_NAME_LENGTH&&(p=p.slice(0,q.MAX_SIGNATURE_NAME_LENGTH-3)+"...")),d.drawText(p,{...H,font:c,color:l(H.color)})}),t.forEach((g,H)=>{let p=H*q.SERVICE_Y_OFFSET,R=g.mode||"3.6";d.drawText(g.serviceNumber||"",{...E.service.serviceNumber,y:E.service.serviceNumber.y-p,font:c,color:l(q.SERVICE_NUMBER_COLOR)}),d.drawText(g.origin||"",{...E.service.origin,y:E.service.origin.y-p,font:c,color:l(E.service.origin.color)}),d.drawText(g.originTime||"",{...E.service.originTime,y:E.service.originTime.y-p,font:c,color:l(E.service.originTime.color)}),R==="3.6"&&(d.drawText(g.destination||"",{...E.service.destination,y:E.service.destination.y-p,font:c,color:l(E.service.destination.color)}),d.drawText(g.destinationTime||"",{...E.service.destinationTime,y:E.service.destinationTime.y-p,font:c,color:l(E.service.destinationTime.color)}));let ve=(g.endTime||"").trim();R!=="3.6"&&ve?(d.drawText(R,{...E.service.endTimeModeText,y:E.service.endTimeModeText.y-p,font:c,color:l(E.service.endTimeModeText.color)}),d.drawText(ve,{...E.service.endTimeValueWhenPrefixed,y:E.service.endTimeValueWhenPrefixed.y-p,font:c,color:l(E.service.endTimeValueWhenPrefixed.color)})):d.drawText(ve,{...E.service.endTimeNormal,y:E.service.endTimeNormal.y-p,font:c,color:l(E.service.endTimeNormal.color)})});let f=async(g,H)=>{if(typeof g=="string"&&g.startsWith("data:image/png;base64,")&&g.length>22)try{let R=await r.embedPng(g);d.drawImage(R,{...H})}catch(R){console.warn(`No s'ha pogut incrustar una signatura. Error: ${R.message}`)}};await Promise.all([f(e.signatureConductor,E.signature.conductor),f(e.signatureAjudant,E.signature.ayudante)]);let _=d.getWidth(),B=Ce.OUTER_MARGIN+Ce.INNER_PADDING,bi=_-(Ce.OUTER_MARGIN+Ce.INNER_PADDING),wt=t.map(g=>({num:g.serviceNumber||"",text:(g.notes||"").trim()})).filter(g=>g.num&&g.text);if(wt.length){d.drawLine({start:{x:Ce.OUTER_MARGIN,y:275},end:{x:_-Ce.OUTER_MARGIN,y:275},thickness:.5,color:i(.8,.8,.8)});let H=wt.length===1?"Observaci\xF3":"Observacions";d.drawText(H,{...E.notesSection.title,font:c,color:l(E.notesSection.title.color)});let p=E.notesSection.start.y,R=E.notesSection.start.size,ve=E.notesSection.lineHeight,Mi=l(E.notesSection.start.color);wt.forEach(({num:xi,text:Ui})=>{if(p<40)return;let Un=`Servei ${xi}: `;d.drawText(Un,{x:B,y:p,font:c,size:R,color:l(q.SERVICE_NUMBER_COLOR)});let ki=c.widthOfTextAtSize(Un,R),lt=B+ki;Ui.split(" ").forEach(xt=>{if(!xt)return;let kn=c.widthOfTextAtSize(xt+" ",R);lt+kn>bi&&(p-=ve,lt=B),d.drawText(xt+" ",{x:lt,y:p,font:c,size:R,color:Mi}),lt+=kn}),p-=ve*1.5})}let Mn=q.WATERMARK_TEXT,xn=E.fixedText.website.size,Bi=c.widthOfTextAtSize(Mn,xn);d.drawText(Mn,{x:(d.getWidth()-Bi)/2,y:E.fixedText.website.y,size:xn,font:c,color:l(E.fixedText.website.color)});let Pi=en(e.date)||"Dieta",wi=`Dieta ${e.dietType==="lunch"?"Comida":e.dietType==="dinner"?"Cena":""} ${Pi}`.trim().replace(/ +/g," ");r.setTitle(wi),r.setAuthor("misdietas.com"),r.setSubject("Justificante de dieta de transporte sanitario"),r.setCreator("MisDietas"),r.setKeywords(["dieta","justificante","transporte sanitario","tsu","tsnu"]);let Mt=new Date(e.date);return isNaN(Mt.getTime())||(r.setCreationDate(Mt),r.setModificationDate(Mt)),await r.save({permissions:{modifying:!1,copying:!1}})}function vo(e,t){let n=en(e).replace(/\//g,"_")||"";return n?`${t==="lunch"?"dieta_comida":t==="dinner"?"dieta_cena":"dieta"}_${n}.pdf`:q.DEFAULT_FILENAME}async function _o(){let e=mt(),t=Et();if(!e||!t){is(e,t);return}document.getElementById(It.DADES_TAB)?.classList.remove(oe.ERROR_TAB),document.getElementById(It.SERVEIS_TAB)?.classList.remove(oe.ERROR_TAB);try{let{generalData:n,servicesData:o}=vt();if(!n||!o)throw new Error("Dades no recollides.");let i=await Io(n,o),s=vo(n.date,n.dietType);So(new Blob([i],{type:"application/pdf"}),s),typeof gtag=="function"&&gtag("event","download_pdf",{event_category:"PDF Generation",event_label:"Download from main form"}),m("Desc\xE0rrega iniciada correctament.","success"),ho()}catch(n){m(`Error en la generaci\xF3 del PDF: ${n.message||"Desconegut"}`,"error")}}async function Do(e){if(!e){m("ID de dieta inv\xE1lido.","error");return}try{let t=e.length===64?e:await Ne(e),n=await Z(t);if(!n)throw new Error("Dieta no encontrada.");let o={date:n.date||"",dietType:n.dietType||"",vehicleNumber:n.vehicleNumber||"",person1:n.person1||"",person2:n.person2||"",serviceType:n.serviceType||"TSU",signatureConductor:n.signatureConductor||"",signatureAjudant:n.signatureAjudant||""},i=n.services.map(r=>({serviceNumber:r.serviceNumber||"",origin:r.origin||"",originTime:r.originTime||"",destination:r.destination||"",destinationTime:r.destinationTime||"",endTime:r.endTime||"",mode:r.mode||"3.6",notes:r.notes||""})),s=await Io(o,i),a=vo(o.date,o.dietType);So(new Blob([s],{type:"application/pdf"}),a),typeof gtag=="function"&&gtag("event","download_pdf",{event_category:"PDF Generation",event_label:"Download from saved list"}),m("Descarga iniciada correctamente.","success")}catch(t){console.error("Error en downloadDietPDF:",t),m(`Error en la generaci\xF3n del PDF: ${t.message||"Desconocido"}`,"error")}}var yo="dotacions_v2",y={MODAL:"dotacio-modal",OPTIONS_CONTAINER:"dotacio-options",TEMPLATE:"dotacio-template",NO_DOTACIO_TEXT:"no-dotacio-text",ADD_BTN:"add-dotacio",OPEN_MODAL_BTN:"open-dotacio-modal",CLOSE_MODAL_BTN:"close-dotacio-modal",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2"},k={MODAL_OPEN:"modal-open",INPUT_ERROR:"input-error",HIDDEN:"hidden"},Oe={PERSON_INPUT_GROUP:".input-with-icon",DOTACIO_INFO:".dotacio-info",LOAD_BTN:".dotacio-load",DELETE_BTN:".dotacio-delete"},Ao={INDEX:"data-index"},ss=180,tn=class{constructor(){this.savedDotacions=[],this.dotacioModalElement=null,this.optionsContainerElement=null,this.dotacioTemplateElement=null,this.noDotacioTextElement=null,this.isInitialized=!1}init(){if(this.isInitialized)return;this.dotacioModalElement=document.getElementById(y.MODAL),this.optionsContainerElement=document.getElementById(y.OPTIONS_CONTAINER),this.dotacioTemplateElement=document.getElementById(y.TEMPLATE),this.noDotacioTextElement=document.getElementById(y.NO_DOTACIO_TEXT);let t=document.getElementById(y.ADD_BTN),n=document.getElementById(y.OPEN_MODAL_BTN),o=document.getElementById(y.CLOSE_MODAL_BTN);if(!this.dotacioModalElement||!this.optionsContainerElement||!this.dotacioTemplateElement||!t||!n||!o)return;this.loadDotacionsFromStorage(),t.addEventListener("click",this.addDotacioFromMainForm.bind(this)),n.addEventListener("click",this.openDotacioModal.bind(this)),o.addEventListener("click",this.closeDotacioModal.bind(this)),this.dotacioModalElement.addEventListener("click",s=>{s.target===this.dotacioModalElement&&this.closeDotacioModal()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.dotacioModalElement.style.display==="block"&&this.closeDotacioModal()}),this.optionsContainerElement.addEventListener("click",this.handleOptionsClick.bind(this)),[y.VEHICLE_INPUT,y.PERSON1_INPUT,y.PERSON2_INPUT].forEach(s=>{let a=document.getElementById(s);a?.addEventListener("input",()=>{let r=a.closest(Oe.PERSON_INPUT_GROUP);r?r.classList.remove(k.INPUT_ERROR):a.classList.remove(k.INPUT_ERROR)})}),this.isInitialized=!0}loadDotacionsFromStorage(){try{let t=localStorage.getItem(yo);this.savedDotacions=t?JSON.parse(t):[],Array.isArray(this.savedDotacions)||(this.savedDotacions=[])}catch{this.savedDotacions=[]}}saveDotacionsToStorage(){try{localStorage.setItem(yo,JSON.stringify(this.savedDotacions))}catch{m("No se han podido guardar las dotaciones.","error")}}openDotacioModal(){this.dotacioModalElement&&(this.dotacioModalElement.style.display="block",document.body.classList.add(k.MODAL_OPEN),this.displayDotacioOptions())}closeDotacioModal(){this.dotacioModalElement&&(this.dotacioModalElement.style.display="none",document.body.classList.remove(k.MODAL_OPEN),document.getElementById(y.OPEN_MODAL_BTN)?.focus())}displayDotacioOptions(){!this.optionsContainerElement||!this.dotacioTemplateElement||(this.optionsContainerElement.innerHTML="",this.savedDotacions.length===0?(this.noDotacioTextElement?.classList.remove(k.HIDDEN),this.optionsContainerElement.classList.add(k.HIDDEN)):(this.noDotacioTextElement?.classList.add(k.HIDDEN),this.optionsContainerElement.classList.remove(k.HIDDEN),this.savedDotacions.forEach((t,n)=>{let o=this.dotacioTemplateElement.content.cloneNode(!0),i=o.querySelector(Oe.DOTACIO_INFO),s=o.querySelector(Oe.LOAD_BTN),a=o.firstElementChild,r=`${t.numero}-${t.conductor}-${t.ajudant}`.replace(/\s/g,"");a.setAttribute("data-dotacio-id",r),i&&(i.textContent=this.formatDotacioListText(t)),s&&s.setAttribute(Ao.INDEX,n),this.optionsContainerElement.appendChild(o),on(a,r),nn(a,r)})))}formatDotacioListText(t){let n=t.numero||"S/N",o=De(t.conductor||""),i=De(t.ajudant||""),s=`${o} / ${i}`;o||i?s=` - ${s}`:s="";let a=`${n}${s}`;if(this.measureTextWidth(a)>ss){let c=t.conductor?this.shortenPersonName(t.conductor):"",d=t.ajudant?this.shortenPersonName(t.ajudant):"",l=`${c} / ${d}`;c||d?l=` - ${l}`:l="",a=`${n}${l}`}return a}shortenPersonName(t){if(!t||typeof t!="string")return"";let n=t.trim().split(/\s+/).filter(r=>r.length>0);if(n.length===0)return"";if(n.length===1)return De(n[0]);let o=new Set(["de","la","del","el","los","las","von","van","d'","es","da","dels","i","y"]),i=n.filter(r=>!o.has(r.toLowerCase()));if(i.length===0)return De(n[0]);let s=De(i[0]),a=i.slice(1).map(r=>r.charAt(0).toUpperCase()+".").join(" ");return`${s} ${a}`}measureTextWidth(t){let n=document.createElement("span");n.style.visibility="hidden",n.style.whiteSpace="nowrap",n.style.fontSize=getComputedStyle(document.body).fontSize,n.style.fontFamily=getComputedStyle(document.body).fontFamily,n.textContent=t,document.body.appendChild(n);let o=n.offsetWidth;return document.body.removeChild(n),o}loadDotacionByIndex(t){if(t<0||t>=this.savedDotacions.length)return;let n=this.savedDotacions[t];this.clearDotacionInputErrors(),document.getElementById(y.VEHICLE_INPUT).value=n.numero||"",document.getElementById(y.PERSON1_INPUT).value=n.conductor||"",document.getElementById(y.PERSON2_INPUT).value=n.ajudant||"",ht(n.firmaConductor||""),St(n.firmaAjudant||""),m(`Dotaci\xF3n ${n.numero} cargada.`,"success"),this.closeDotacioModal()}async handleDeleteById(t){let n=this.savedDotacions.findIndex(s=>`${s.numero}-${s.conductor}-${s.ajudant}`.replace(/\s/g,"")===t);if(n===-1){console.warn("Se intent\xF3 eliminar una dotaci\xF3n que ya no existe:",t);return}let i={...this.savedDotacions[n],originalIndex:n};this.savedDotacions.splice(n,1),this.saveDotacionsToStorage(),Ke(),m("Dotaci\xF3n eliminada.","success",5e3,{undoCallback:()=>{this.savedDotacions.splice(i.originalIndex,0,i),this.saveDotacionsToStorage(),Lo(i),m("Dotaci\xF3n restaurada.","success")}})}handleOptionsClick(t){let o=t.target.closest(Oe.LOAD_BTN);if(o){t.stopPropagation();let i=parseInt(o.getAttribute(Ao.INDEX),10);isNaN(i)||this.loadDotacionByIndex(i)}}getDotacionInputValues(){let t=document.getElementById(y.VEHICLE_INPUT),n=document.getElementById(y.PERSON1_INPUT),o=document.getElementById(y.PERSON2_INPUT);return{vehiculo:t?.value.trim()||"",conductor:n?.value.trim()||"",ayudante:o?.value.trim()||""}}findExistingDotacionIndex(t,n,o){let i=t.toLowerCase(),s=n.toLowerCase(),a=o.toLowerCase();return this.savedDotacions.findIndex(r=>r.numero.toLowerCase()===i&&r.conductor.toLowerCase()===s&&r.ajudant.toLowerCase()===a)}addDotacioFromMainForm(){if(!oo())return;let{vehiculo:t,conductor:n,ayudante:o}=this.getDotacionInputValues(),i=pt(),s=Tt(),a=this.findExistingDotacionIndex(t,n,o),r={numero:t,conductor:n,ajudant:o,firmaConductor:i,firmaAjudant:s};a!==-1?(this.savedDotacions[a]=r,m(`Dotaci\xF3n ${t} actualizada.`,"success")):(this.savedDotacions.push(r),m(`Dotaci\xF3n ${t} creada.`,"success")),this.saveDotacionsToStorage()}clearDotacionInputErrors(){let t=document.getElementById(y.VEHICLE_INPUT),n=document.getElementById(y.PERSON1_INPUT),o=document.getElementById(y.PERSON2_INPUT),i=n?.closest(Oe.PERSON_INPUT_GROUP),s=o?.closest(Oe.PERSON_INPUT_GROUP);t?.classList.remove(k.INPUT_ERROR),i?.classList.remove(k.INPUT_ERROR),s?.classList.remove(k.INPUT_ERROR)}},Re=new tn;var T={MODAL_VISIBLE:"visible",MODAL_OPEN_BODY:"modal-open",HIDDEN:"hidden",DIET_ITEM:"diet-item",DIET_DATE:"diet-date",DIET_ICONS:"diet-icons",DIET_DELETE_BTN:"diet-delete",DIET_LOAD_BTN:"diet-load",LIST_ITEM_BTN:"list-item-btn",LIST_ITEM_BTN_LOAD:"list-item-btn--load",LIST_ITEM_BTN_DELETE:"list-item-btn--delete",DIET_ITEM_SWIPING:"swiping",DIET_DELETE_REVEAL:"delete-reveal"},w={DIET_MODAL:"diet-modal",DIET_OPTIONS_LIST:"diet-options",NO_DIETS_TEXT:"no-diets-text",CONFIRM_MODAL:"confirm-modal",CONFIRM_MESSAGE:"confirm-message",CONFIRM_TITLE:".modal-title",CONFIRM_YES_BTN:"confirm-yes",CONFIRM_NO_BTN:"confirm-no",ABOUT_MODAL:"about-modal",SIGNATURE_MODAL:"signature-modal",DOTACIO_MODAL:"dotacio-modal",CAMERA_GALLERY_MODAL:"camera-gallery-modal"},_t={MODAL:".modal",MODAL_CLOSE_BTN:".close-modal, .close-modal-btn",MODAL_TRIGGER:'a[href^="#"]',FOCUSABLE_ELEMENTS:'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'},ie={DIET_ID:"data-diet-id",DIET_DATE:"data-diet-date",DIET_TYPE:"data-diet-type"},Be=null,h=null,x=null,sn=null,rs=null,as=null,cs=null,ls=null;var b=null,be=null,Pe=null,we=null;function No(e){if(!e||b&&b.id!==e.id&&e.id!==w.CONFIRM_MODAL)return;b||(be=document.activeElement),b=e,e.style.display="block",document.body.classList.add(T.MODAL_OPEN_BODY),Pe||(Pe=n=>{n.target===b&&(b.id===w.CONFIRM_MODAL?_handleConfirmNo():Dt())},document.addEventListener("click",Pe,!0)),we||(we=n=>{n.key==="Escape"&&b&&(b.id===w.CONFIRM_MODAL?_handleConfirmNo():Dt())},document.addEventListener("keydown",we,!0)),e.querySelector(_t.FOCUSABLE_ELEMENTS)?.focus()}function Dt(){if(!b)return;Pe&&(document.removeEventListener("click",Pe,!0),Pe=null),we&&(document.removeEventListener("keydown",we,!0),we=null),b.style.display="none";let e=b.id===w.CONFIRM_MODAL;b=null;let t=document.querySelector('.modal[style*="display: block"]');t||document.body.classList.remove(T.MODAL_OPEN_BODY),!e&&be?(be.focus(),be=null):t||(be?.focus(),be=null)}function ds(e){if(!e)return"";let t=new Date(e);if(isNaN(t.getTime()))return"";let n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}:${o}`}function Co(e){let t=e.services&&e.services.length>0?e.services[0].serviceNumber:"?????????",{ddmmaa:n,franjaText:o}=Vt(e.date,e.dietType),i=ds(e.timeStampDiet),s=document.createElement("div");s.className=T.DIET_ITEM;let a=document.createElement("div");a.className="diet-item-content";let r=document.createElement("span");r.className=T.DIET_DATE;let c=n;i&&(c+=` [${i}]`),c+=` - ${Yn(o)}`,r.textContent=c;let d=document.createElement("div");d.className=T.DIET_ICONS;let l=document.createElement("div");l.className="delete-reveal",l.innerHTML='<img src="assets/icons/delete.svg" alt="Eliminar" class="icon">';let f=document.createElement("button");f.className=`${T.LIST_ITEM_BTN} ${T.LIST_ITEM_BTN_LOAD} ${T.DIET_LOAD_BTN}`,f.setAttribute("aria-label",`Editar dieta ${n}`),f.innerHTML='<img src="assets/icons/ic_edit.svg" alt="" class="icon"><span class="btn-text visually-hidden">Editar</span>',f.setAttribute(ie.DIET_ID,t),f.setAttribute(ie.DIET_DATE,e.date),f.setAttribute(ie.DIET_TYPE,e.dietType);let _=document.createElement("button");return _.className=`${T.LIST_ITEM_BTN} diet-download`,_.setAttribute("aria-label",`Descarregar PDF de la dieta ${n}`),_.innerHTML='<img src="assets/icons/download_blue.svg" alt="" class="icon"><span class="btn-text visually-hidden">PDF</span>',_.setAttribute(ie.DIET_ID,t),d.appendChild(f),d.appendChild(_),a.appendChild(r),a.appendChild(d),s.appendChild(a),s.appendChild(l),s}async function us(e){let t=e.target,n=t.closest(`.${T.DIET_LOAD_BTN}`),o=t.closest(".diet-download");if(n){e.stopPropagation();let i=n.getAttribute(ie.DIET_ID),s=n.getAttribute(ie.DIET_DATE),a=n.getAttribute(ie.DIET_TYPE);if(!i||!s||!a)return;let{ddmmaa:r,franjaText:c}=Vt(s,a);try{await Po(i)}catch(d){console.error("Error en carregar la dieta:",d)}}else if(o){e.stopPropagation();let i=o.getAttribute(ie.DIET_ID);i&&Do(i)}}function Oo(e){if(!h)return;let t=h.querySelector(`[data-diet-id="${e}"]`)?.closest(".diet-item");if(!t)return;let n=h.scrollHeight+"px";h.style.height=n,t.remove(),requestAnimationFrame(()=>{h.style.height=h.scrollHeight+"px"}),At()}function Ro(){sn=document.getElementById(w.CONFIRM_MODAL),sn&&(rs=document.getElementById(w.CONFIRM_MESSAGE),as=sn.querySelector(w.CONFIRM_TITLE),cs=document.getElementById(w.CONFIRM_YES_BTN),ls=document.getElementById(w.CONFIRM_NO_BTN)),document.querySelectorAll(_t.MODAL_TRIGGER).forEach(t=>{let n=t.getAttribute("href")?.substring(1);if(!n)return;let o=document.getElementById(n);o&&o.matches(_t.MODAL)&&(t.addEventListener("click",s=>{s.preventDefault(),No(o)}),o.querySelectorAll(_t.MODAL_CLOSE_BTN).forEach(s=>{s.addEventListener("click",()=>Dt())}))})}function rn(){if(!Be){Be=document.getElementById(w.DIET_MODAL),h=document.getElementById(w.DIET_OPTIONS_LIST),x=document.getElementById(w.NO_DIETS_TEXT);let e=document.getElementById("close-diet-modal");e&&e.addEventListener("click",an),h&&h.addEventListener("click",us)}Be&&(No(Be),yt())}function an(){b&&b.id===w.DIET_MODAL&&Dt()}async function yt(){if(!(!h||!x)){h.innerHTML="";try{let e=await dt();e.length===0?(h.classList.add(T.HIDDEN),x.classList.remove(T.HIDDEN),x.textContent="No hay dietas guardadas."):(h.classList.remove(T.HIDDEN),x.classList.add(T.HIDDEN),e.sort((t,n)=>new Date(n.timeStampDiet)-new Date(t.timeStampDiet)),e.forEach((t,n)=>{let o=Co(t);o.setAttribute("data-index",n),h.appendChild(o),bo(o,t.id,t.date,t.dietType)}))}catch{h.classList.add(T.HIDDEN),x.classList.remove(T.HIDDEN),x.textContent="Error al cargar las dietas."}}}function At(){console.log("Actualitzant visibilitat: children.length =",h.children.length),h.children.length===0?(h.classList.add(T.HIDDEN),x.classList.remove(T.HIDDEN),x.textContent="No hay dietas guardadas."):(h.classList.remove(T.HIDDEN),x.classList.add(T.HIDDEN))}function ms(e,t,n,o){let i=0,s=0,a=!1;e.addEventListener("mousedown",r=>{r.target.closest("button")||r.target.closest(".diet-icons")||(i=r.clientX,s=i,a=!1)}),document.addEventListener("mousemove",r=>{s=r.clientX;let c=i-s;c>10&&!a&&(a=!0,e.classList.add(T.DIET_ITEM_SWIPING)),a&&c>10&&(e.style.transform=`translateX(-${Math.min(c,80)}px)`,r.preventDefault())}),document.addEventListener("mouseup",async r=>{if(!a)return;a=!1;let c=i-s;e.classList.remove(T.DIET_ITEM_SWIPING),e.style.transition="transform 0.3s ease, opacity 0.3s ease",c>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{e.remove(),At(),await cn(t,n,o)},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300)})}function bo(e,t,n,o){let i=0,s=0,a=!1;e.addEventListener("touchstart",r=>{r.target.closest("button")||r.target.closest(".diet-icons")||(i=r.touches[0].clientX,s=i,a=!1,r.stopPropagation())},{passive:!1}),e.addEventListener("touchmove",r=>{s=r.touches[0].clientX;let c=i-s;c>10&&!a&&(a=!0,e.classList.add(T.DIET_ITEM_SWIPING),Be.style.overflow="hidden"),a&&c>10&&(e.style.transform=`translateX(-${Math.min(c,80)}px)`,r.preventDefault(),r.stopPropagation())},{passive:!1}),e.addEventListener("touchend",async r=>{if(!a)return;a=!1;let c=i-s;e.classList.remove(T.DIET_ITEM_SWIPING),e.style.transition="transform 0.3s ease, opacity 0.3s ease",c>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{e.remove(),At(),await cn(t,n,o)},300)):(e.style.transform="translateX(0)",e.style.opacity="1",Be.style.overflow=""),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300),r.stopPropagation()}),ms(e,t,n,o)}function nn(e,t){let n=0,o=0,i=!1;e.addEventListener("mousedown",s=>{s.target.closest("button")||s.target.closest(".button-container")||(n=s.clientX,o=n,i=!1)}),document.addEventListener("mousemove",s=>{o=s.clientX;let a=n-o;a>10&&!i&&(i=!0,e.classList.add("swiping")),i&&a>10&&(e.style.transform=`translateX(-${Math.min(a,80)}px)`,s.preventDefault())}),document.addEventListener("mouseup",async s=>{if(!i)return;i=!1;let a=n-o;e.classList.remove("swiping"),e.style.transition="transform 0.3s ease, opacity 0.3s ease",a>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{await Re.handleDeleteById(t),e.remove(),Ke()},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300)})}function on(e,t){let n=0,o=0,i=!1;e.addEventListener("touchstart",s=>{s.target.closest("button")||(n=s.touches[0].clientX,o=n,i=!1,s.stopPropagation())},{passive:!1}),e.addEventListener("touchmove",s=>{o=s.touches[0].clientX;let a=n-o;a>10&&!i&&(i=!0,e.classList.add("swiping")),i&&a>10&&(e.style.transform=`translateX(-${Math.min(a,80)}px)`,s.preventDefault(),s.stopPropagation())},{passive:!1}),e.addEventListener("touchend",async s=>{if(!i)return;i=!1;let a=n-o;e.classList.remove("swiping"),e.style.transition="transform 0.3s ease, opacity 0.3s ease",a>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{await Re.handleDeleteById(t),e.remove(),Ke()},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300),s.stopPropagation()})}function Bo(e){if(!h||!x){yt();return}let t=e.index||0,n=Co(e);n.style.opacity="0",n.style.transform="translateX(-100%)";let o=h.children[t];o?h.insertBefore(n,o):h.appendChild(n),requestAnimationFrame(()=>{n.style.transition="opacity 0.5s ease, transform 0.5s ease",n.style.opacity="1",n.style.transform="translateX(0)",bo(n,e.id,e.date,e.dietType)}),At(),h.classList.remove(T.HIDDEN),x.classList.add(T.HIDDEN)}function Ke(){let e=document.getElementById("dotacio-options"),t=document.getElementById("no-dotacio-text");e.children.length===0?(e.classList.add("hidden"),t.classList.remove("hidden"),t.innerHTML='No hay dotaciones, guarde antes: <img src="assets/icons/save_green.svg" alt="Guardar" class="save-icon" />'):(e.classList.remove("hidden"),t.classList.add("hidden"))}function Es(e,t){let n=document.getElementById("dotacio-template");if(!n)return null;let o=n.content.cloneNode(!0),i=o.firstElementChild,s=`${e.numero}-${e.conductor}-${e.ajudant}`.replace(/\s/g,"");i.setAttribute("data-dotacio-id",s);let a=o.querySelector(".dotacio-info"),r=o.querySelector(".dotacio-load");if(a){let c=[e.conductor,e.ajudant].filter(Boolean).join(" / ");a.textContent=c?`${e.numero} - ${c}`:e.numero}return r&&r.setAttribute("data-index",String(t)),i}function Lo(e){let t=document.getElementById("dotacio-options");if(!t){Re.displayDotacioOptions();return}let n=e.originalIndex,o=Es(e,n);if(!o)return;o.style.opacity="0",o.style.transform="translateX(-100%)";let i=t.children[n];i?t.insertBefore(o,i):t.appendChild(o),requestAnimationFrame(()=>{o.style.transition="opacity 0.5s ease, transform 0.5s ease",o.style.opacity="1",o.style.transform="translateX(0)";let s=`${e.numero}-${e.conductor}-${e.ajudant}`.replace(/\s/g,"");on(o,s),nn(o,s)}),Ke()}var fs="save-pill",gs=".pill-text",W={VISIBLE:"visible",HAS_CHANGES:"has-changes",SAVING:"saving",HAS_SAVED:"has-saved",ERROR:"error"},wo=2e3;var se=null,ln=null,pe=null,Je=null,ps=0,dn=!1;function Mo(){if(!se){if(se=document.getElementById(fs),ln=se?.querySelector(gs),!se||!ln)throw new Error("Elements de la p\xEDndola no trobats al DOM.");se.setAttribute("role","status"),se.setAttribute("aria-live","polite")}return{pillEl:se,textEl:ln}}function un(e,t){try{let{pillEl:n,textEl:o}=Mo();n.classList.add(W.VISIBLE),n.classList.remove(W.HAS_CHANGES,W.SAVING,W.HAS_SAVED,W.ERROR),t&&n.classList.add(t),o.textContent=e.replace(/[<>&]/g,"")}catch(n){console.warn("[saveIndicator] Error mostrant p\xEDndola:",n)}}function Lt(e="Guardando\u2026"){clearTimeout(Je),un(e,W.SAVING)}function Nt(){clearTimeout(Je),dn=!1,ps=Date.now(),un("Guardado",W.HAS_SAVED),clearTimeout(pe),pe=setTimeout(mn,wo)}function Qe(e="No se pudo guardar"){clearTimeout(Je),un(e,W.ERROR),clearTimeout(pe),pe=setTimeout(mn,wo*2)}function mn(e=!1){try{if(Mo(),clearTimeout(pe),dn&&!e)return;se?.classList.remove(W.VISIBLE),pe=null}catch(t){console.warn("[saveIndicator] Error amagant p\xEDndola:",t)}}function Me(){dn=!1,clearTimeout(Je),mn(!0)}window.addEventListener("pagehide",()=>{clearTimeout(pe),clearTimeout(Je)});var re={DADES_TAB:"tab-dades",SERVEIS_TAB:"tab-serveis",DATE_INPUT:"date",DIET_TYPE_SELECT:"diet-type",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2",SERVICE_TYPE_SELECT:"service-type"},En=Promise.resolve(),xo=!1;var xe={ERROR_TAB:"error-tab"},Ts=".service",Uo={serviceNumber:".service-number",origin:".origin",originTime:".origin-time",destination:".destination",destinationTime:".destination-time",endTime:".end-time"},fn=class{constructor({id:t="",date:n="",dietType:o="",vehicleNumber:i="",person1:s="",person2:a="",signatureConductor:r="",signatureAjudant:c="",services:d=[],serviceType:l="TSU",timeStampDiet:f=new Date().toISOString()}={}){this.id=String(t),this.date=String(n),this.dietType=String(o),this.vehicleNumber=String(i),this.person1=String(s),this.person2=String(a),this.signatureConductor=String(r),this.signatureAjudant=String(c),this.services=Array.isArray(d)?d:[],this.serviceType=String(l),this.timeStampDiet=String(f)}};async function hs(e,t,n){if(!e||!Array.isArray(t)||!n)throw new Error("Datos incompletos para construir la dieta.");if(!/^\d{9}$/.test(n))throw new Error("ID de dieta inv\xE1lido. Debe contener 9 d\xEDgitos.");for(let r of t)if(!ft(r.originTime)||!ft(r.destinationTime)||!ft(r.endTime))throw new Error("Formato de hora inv\xE1lido detectado. Use HH:mm.");let o=await Ne(n),i=await Z(o),s=i?i.timeStampDiet:new Date().toISOString(),a={id:o,date:D(e.date),dietType:D(e.dietType),vehicleNumber:D(e.vehicleNumber),person1:D(e.person1),person2:D(e.person2),signatureConductor:e.signatureConductor,signatureAjudant:e.signatureAjudant,services:t.map(r=>({serviceNumber:D(r.serviceNumber),origin:D(r.origin),destination:D(r.destination),originTime:r.originTime,destinationTime:r.destinationTime,endTime:r.endTime,mode:D(r.mode),notes:D(r.notes)||""})),serviceType:D(e.serviceType),timeStampDiet:s};return new fn(a)}function Ss(){let e=document.getElementById(re.DADES_TAB),t=document.getElementById(re.SERVEIS_TAB);e?.classList.remove(xe.ERROR_TAB),t?.classList.remove(xe.ERROR_TAB);let n=mt(),o=Et();if(n&&o)return!0;let i="";return!n&&!o?(i="Completa los campos obligatorios en Datos y Servicios.",e?.classList.add(xe.ERROR_TAB),t?.classList.add(xe.ERROR_TAB)):n?(i="Completa los campos obligatorios en la pesta\xF1a Servicios.",t?.classList.add(xe.ERROR_TAB)):(i="Completa los campos obligatorios en la pesta\xF1a Datos.",e?.classList.add(xe.ERROR_TAB)),m(i,"error"),!1}function Is(e){if(!e)return;let t=i=>document.getElementById(i);t(re.DATE_INPUT).value=e.date||"",t(re.DIET_TYPE_SELECT).value=e.dietType||"",t(re.VEHICLE_INPUT).value=e.vehicleNumber||"",t(re.PERSON1_INPUT).value=e.person1||"",t(re.PERSON2_INPUT).value=e.person2||"";let n=t(re.SERVICE_TYPE_SELECT);n&&(n.value=e.serviceType||"TSU",Ue(n.value)),ht(e.signatureConductor||""),St(e.signatureAjudant||"");let o=document.querySelectorAll(Ts);e.services.forEach((i,s)=>{let a=o[s];a&&(Object.entries(Uo).forEach(([r,c])=>{let d=a.querySelector(c);d&&(d.value=i[r]||"")}),Go(s,i.mode||"3.6"),et(a),Y[s]=i.notes||"")});for(let i=e.services.length;i<o.length;i++){let s=o[i];s&&(Object.values(Uo).forEach(a=>{let r=s.querySelector(a);r&&(r.value="")}),et(s),Y[i]="")}}async function ko(e){return En=En.then(async()=>{let{generalData:t,servicesData:n}=vt(),o=n[0]?.serviceNumber?.slice(0,9)||"";if(!o||!/^\d{9}$/.test(o)){e&&m("El primer servicio debe tener un N.\xBA de servicio v\xE1lido.","error");return}let i=await Ne(o),s=await Z(i);e&&Lt(!s?"Guardando nueva dieta\u2026":"Guardando\u2026"),gn(!1);try{if(await new Promise(d=>setTimeout(d,500)),!Ss()){e&&Qe("Validaci\xF3n fallida");return}let c=await hs(t,n,o);s?await $n(c):(await kt(c),Te(),Me()),e&&m("Dieta guardada correctament.","success"),Ze=new Date,pn(),Te(),Nt(),e&&await yt()}catch(c){console.error("Error en performSave:",c),Qe(c.message||"No se pudo guardar"),e&&m(`Error al guardar: ${c.message}`,"error")}finally{gn(!0),xo&&(xo=!1,setTimeout(()=>Ct(),100))}}),En}async function Fo(){Vo(),await ko(!0)}async function Ct(){await ko(!1)}async function Po(e){if(!e||typeof e!="string")throw new Error("ID inv\xE0lid");let t=e.length===64?await Z(e):await Z(await Ne(e));if(!t)throw new Error(`Dieta no trobada: ${e}`);Is(t),Te(),t.timeStampDiet&&(Ze=new Date(t.timeStampDiet),pn()),m("Dieta cargada correctamente.","success"),an()}async function cn(e,t,n){if(e)try{let o=await Z(e);if(!o){m("Error: Dieta no trobada","error");return}let s=(await dt()).sort((a,r)=>new Date(r.timeStampDiet)-new Date(a.timeStampDiet));o.index=s.findIndex(a=>a.id===e),await Xn(e),m("Dieta eliminada","success",5e3,{priority:2,undoCallback:async()=>{await kt(o),Bo(o),m("Dieta restaurada","success",3e3,{priority:0})},onExpire:()=>{Oo(e)}}),Te(),Me()}catch(o){console.error("Error en deleteDietHandler:",o),m("Error al eliminar la dieta","error")}}var Ze=null;function pn(){let e=document.getElementById("last-saved");e&&(e.textContent=Ze?uo(Ze):"")}setInterval(()=>{Ze&&pn()},6e4);var vs=".service",Ho="main-content",F={DATE:"date",DIET_TYPE:"diet-type",VEHICLE:"vehicle-number",P1:"person1",P2:"person2",SERVICE_TYPE:"service-type",SAVE_BTN:"save-diet"},_s="userSelectedServiceType",Ds={serviceNumber:".service-number",origin:".origin",originTime:".origin-time",destination:".destination",destinationTime:".destination-time",endTime:".end-time"},ys="chip-active",As=800,Ls=1e3,Ns=300,Tn=class{constructor(){this.initialFormDataStr="",this.saveStart=0,this.debouncedAutoSave=Gt(this.triggerAutoSave.bind(this),Ls),this.debouncedHandler=Gt(this.handleInputChange.bind(this),As)}isFormReadyForSave(){try{let t=!!document.getElementById(F.DATE)?.value.trim(),n=!!document.getElementById(F.DIET_TYPE)?.value.trim(),o=document.getElementById("service-number-1")?.value.trim(),i=/^\d{9}$/.test(o);return t&&n&&i}catch(t){return console.warn("[FormService] Error validant formulari:",t),!1}}hasPendingChanges(){return JSON.stringify(this.getFormDataObject()||{})!==this.initialFormDataStr}getFormDataObject(){try{let t={date:D(document.getElementById(F.DATE)?.value),dietType:D(document.getElementById(F.DIET_TYPE)?.value||Ft()),vehicleNumber:D(document.getElementById(F.VEHICLE)?.value),person1:D(document.getElementById(F.P1)?.value),person2:D(document.getElementById(F.P2)?.value),serviceType:D(document.getElementById(F.SERVICE_TYPE)?.value||"TSU"),signatureConductor:pt(),signatureAjudant:Tt()},n=Array.from(document.querySelectorAll(vs)).map((o,i)=>{let s={};for(let[r,c]of Object.entries(Ds))s[r]=D(o.querySelector(c)?.value);let a=o.querySelector(`.chip.${ys}`);return s.mode=a?.dataset.mode||"3.6",s.notes=Y[i]||"",s});return{generalData:t,servicesData:n}}catch(t){return console.error("[FormService] Error recollint dades:",t),null}}async triggerAutoSave(){if(!(!this.isFormReadyForSave()||!this.hasPendingChanges()))try{this.saveStart=Date.now(),Lt(),await Ct();let t=Date.now()-this.saveStart;setTimeout(Nt,Math.max(0,Ns-t)),this.initialFormDataStr=JSON.stringify(this.getFormDataObject()||{})}catch(t){console.warn("[Autosave skipped]",t?.message||"Error desconegut"),Qe("Revisa dades de Serveis")}}captureInitialFormState(){this.initialFormDataStr=JSON.stringify(this.getFormDataObject()||{}),this.handleFormChange()}setSaveButtonState(t){let n=document.getElementById(F.SAVE_BTN);n&&(n.disabled=!t,n.setAttribute("aria-disabled",t?"false":"true"),n.classList.toggle("is-disabled",!t))}handleFormChange(){if(this.debouncedAutoSave.cancel(),!this.hasPendingChanges()){this.setSaveButtonState(!1),Me();return}this.isFormReadyForSave()?(this.setSaveButtonState(!0),this.debouncedAutoSave()):(this.setSaveButtonState(!1),Me())}handleInputChange(){this.handleFormChange()}addInputListeners(){let t=document.getElementById(Ho);if(!t)return;t.addEventListener("input",this.debouncedHandler),t.addEventListener("change",this.debouncedHandler),t.addEventListener("blur",o=>{o.target.matches("input, select, textarea")&&(this.handleFormChange(),this.isFormReadyForSave()&&this.hasPendingChanges()&&(this.debouncedAutoSave.cancel(),this.triggerAutoSave()))},!0);let n=document.getElementById(F.DATE);n?.addEventListener("change",()=>{n.blur(),this.debouncedHandler()}),window.addEventListener("beforeunload",()=>{this.debouncedAutoSave.cancel(),this.isFormReadyForSave()&&Ct()})}addServiceTypeListener(){let t=document.getElementById(F.SERVICE_TYPE);t&&t.addEventListener("change",n=>{let o=n.target.value.trim();Ue(o);try{localStorage.setItem(_s,o)}catch(i){console.error("No s\u2019ha pogut desar tipus servei",i)}})}cancelPendingAutoSave(){this.debouncedAutoSave.cancel()}addDoneBehavior(){document.getElementById(Ho)?.addEventListener("keydown",n=>{n.key==="Enter"&&n.target.matches('input[enterkeyhint="done"]')&&(n.preventDefault(),n.target.blur())})}gatherAllData(){return this.getFormDataObject()}getInitialFormDataStr(){return this.initialFormDataStr}},ae=new Tn,Te=()=>ae.captureInitialFormState(),gn=e=>ae.setSaveButtonState(e),j=()=>ae.handleFormChange(),$o=()=>ae.addInputListeners(),Xo=()=>ae.addServiceTypeListener(),Vo=()=>ae.cancelPendingAutoSave(),jo=()=>ae.addDoneBehavior(),vt=()=>ae.gatherAllData();var Os=["3.6","3.51","3.22","3.11"],ke={CONTAINER:"services-container",BUTTONS_CONTAINER:"service-buttons-container",OPTIONS_MENU:"options-menu",OPTIONS_TOGGLE_BTN:"options-toggle",CLEAR_BTN:"clear-selected-service",CAMERA_BTN:"camera-in-dropdown",CHIP_GROUP:"service-mode-chips"},ot={SERVICE_PANEL:".service",SERVICE_BUTTON:".service-button",CHIP:".chip",FORM_GROUP:".form-group"},I={SERVICE_HIDDEN:"hidden",BUTTON_ACTIVE:"active-square",SERVICE_COLORS:["service-1","service-2","service-3","service-4"],OPTIONS_MENU_HIDDEN:"hidden",CHIP_ACTIVE:"chip-active"},Rs=[".chip-group-title",".chip-group",".btn-ocr-inline",".section-divider"],bs=[".destination",".destination-time"],qo=!1,Fe=0,A=[],it=[],Wo=[],hn=null,tt=null,z=null,nt=null,Bs=null,Ps=[],ce=[],Y=["","","",""];function ws(){tt&&(tt.innerHTML="",it=A.map((e,t)=>{let n=document.createElement("button");return n.className=`service-button ${I.SERVICE_COLORS[t]}`,n.textContent=`S${t+1}`,n.type="button",n.setAttribute("aria-label",`Mostrar servei ${t+1}`),n.addEventListener("click",()=>Fs(t)),tt.appendChild(n),n}))}function Ms(){!z||!nt||(nt.addEventListener("click",e=>{e.stopPropagation(),z.classList.toggle(I.OPTIONS_MENU_HIDDEN)}),document.addEventListener("click",e=>{!nt?.contains(e.target)&&!z?.contains(e.target)&&z.classList.add(I.OPTIONS_MENU_HIDDEN)}),document.addEventListener("keydown",e=>{e.key==="Escape"&&z&&z.classList.add(I.OPTIONS_MENU_HIDDEN)}),z.addEventListener("click",e=>{e.target.closest("button")&&z.classList.add(I.OPTIONS_MENU_HIDDEN)}))}function xs(e,t){let n=e.querySelector(t);return n?n.closest(ot.FORM_GROUP):null}function Ot(e,t){if(!e)return;let n=t!=="3.6";bs.forEach(i=>{xs(e,i)?.classList.toggle(I.SERVICE_HIDDEN,n)});let o=e.querySelector(".origin");o&&(n?o.setAttribute("enterkeyhint","done"):o.removeAttribute("enterkeyhint"))}function Us(e){Bs&&Ps.forEach(t=>t.classList.toggle(I.CHIP_ACTIVE,t.dataset.mode===e))}function Rt(e,t){e.querySelectorAll(ot.CHIP).forEach(o=>o.classList.toggle(I.CHIP_ACTIVE,o.dataset.mode===t))}function ks(){A.forEach((e,t)=>{e.querySelectorAll(ot.CHIP).forEach(o=>{o.addEventListener("click",()=>{let i=o.dataset.mode;if(!Os.includes(i)){console.error(`Intent de canviar a un mode inv\xE0lid: "${i}". Acci\xF3 bloquejada.`);return}if(ce[t]===i)return;ce[t]=i,Rt(e,i),Ot(e,i);let s=e.querySelector(".chip-group");s&&(I.SERVICE_COLORS.forEach(a=>s.classList.remove(a)),s.classList.add(I.SERVICE_COLORS[t])),j()})})})}function Sn(e){let t=I.SERVICE_COLORS[e],n=(o,i)=>{o&&(o.classList.remove(...I.SERVICE_COLORS),o.classList.add(i,t))};n(document.getElementById(ke.CLEAR_BTN),"clear-selected-btn"),n(document.getElementById(ke.CAMERA_BTN),"camera-btn"),n(document.getElementById("notes-selected-service"),"notes-btn"),n(nt,"options-btn")}function Yo(){if(!qo&&(Wo=document.querySelectorAll(ot.SERVICE_PANEL),hn=document.getElementById(ke.CONTAINER),tt=document.getElementById(ke.BUTTONS_CONTAINER),z=document.getElementById(ke.OPTIONS_MENU),nt=document.getElementById(ke.OPTIONS_TOGGLE_BTN),!(!hn||!tt)&&(A=Array.from(hn.querySelectorAll(ot.SERVICE_PANEL)),!!A.length))){if(ce=A.map(()=>"3.6"),ws(),Ms(),ks(),A.length>0&&it.length>0){A.forEach((n,o)=>n.classList.toggle(I.SERVICE_HIDDEN,o!==0)),it[0].classList.add(I.BUTTON_ACTIVE);let e=ce[0];Ot(A[0],e),Rt(A[0],e);let t=A[0].querySelector(".chip-group");t&&t.classList.add(I.SERVICE_COLORS[0]),Us(e),Sn(0)}qo=!0}}function Fs(e){if(e<0||e>=A.length||e===Fe)return;A[Fe].classList.add(I.SERVICE_HIDDEN),A[e].classList.remove(I.SERVICE_HIDDEN),it[Fe].classList.remove(I.BUTTON_ACTIVE),it[e].classList.add(I.BUTTON_ACTIVE),Fe=e;let t=ce[e];Ot(A[e],t),Rt(A[e],t);let n=A[e].querySelector(".chip-group");n&&(I.SERVICE_COLORS.forEach(o=>n.classList.remove(o)),n.classList.add(I.SERVICE_COLORS[e])),Sn(e)}var he=()=>Fe,zo=e=>{if(e>=0&&e<ce.length)return ce[e]};function Ko(e){e&&e.querySelectorAll("input, select, textarea").forEach(t=>{t.type==="checkbox"||t.type==="radio"?t.checked=!1:t.type!=="button"&&t.type!=="submit"&&t.type!=="reset"&&(t.value=""),t.tagName==="SELECT"&&(t.selectedIndex=0)})}function Xt(){Sn(Fe)}function Go(e,t){if(e<0||e>=A.length)return;ce[e]=t;let n=A[e];n&&(Rt(n,t),Ot(n,t),j())}function Ue(e){let t=e==="TSNU";Wo.forEach(n=>{Rs.forEach(o=>{n.querySelector(o)?.classList.toggle(I.SERVICE_HIDDEN,t)})})}function et(e){e&&e.querySelectorAll(".input-error").forEach(t=>t.classList.remove("input-error"))}var In={TOGGLE_BTN:"theme-toggle-btn",THEME_ICON:"theme-icon",THEME_TEXT:"theme-btn-text"},Jo={DARK_THEME:"theme-dark"},vn="themePreference",U={LIGHT:"light",DARK:"dark"},Qo={LIGHT:"assets/icons/moon.svg",DARK:"assets/icons/sun.svg"},Zo={LIGHT:"#004aad",DARK:"#343a40"},_n=class{constructor(){this.themeToggleButton=null,this.themeIconElement=null,this.themeTextElement=null,this.bodyElement=null,this.systemDarkMatcher=null}init(){if(this.themeToggleButton=document.getElementById(In.TOGGLE_BTN),this.themeIconElement=document.getElementById(In.THEME_ICON),this.themeTextElement=document.getElementById(In.THEME_TEXT),this.bodyElement=document.body,!this.themeToggleButton||!this.themeIconElement||!this.themeTextElement||!this.bodyElement){console.warn("Faltan elementos del DOM para el gestor de temas.");return}let t,n=localStorage.getItem(vn);n&&(n===U.LIGHT||n===U.DARK)?t=n:(this.systemDarkMatcher=window.matchMedia("(prefers-color-scheme: dark)"),t=this.systemDarkMatcher.matches?U.DARK:U.LIGHT,this.systemDarkMatcher.addEventListener("change",this._handleSystemThemeChange.bind(this))),this._applyTheme(t,!1),this.themeToggleButton.addEventListener("click",this._handleThemeToggle.bind(this))}_updateThemeColorMeta(t){let n=document.querySelector('meta[name="theme-color"]');n&&(n.content=t)}_applyTheme(t,n=!1){let o=t===U.DARK;this.bodyElement.classList.toggle(Jo.DARK_THEME,o),this.themeIconElement.src=o?Qo.DARK:Qo.LIGHT,this.themeTextElement.textContent=o?"Claro":"Oscuro",this.themeIconElement.alt=o?"Cambiar a tema claro":"Cambiar a tema oscuro",this._updateThemeColorMeta(o?Zo.DARK:Zo.LIGHT),n&&localStorage.setItem(vn,t)}_handleThemeToggle(){let n=(this.bodyElement.classList.contains(Jo.DARK_THEME)?U.DARK:U.LIGHT)===U.DARK?U.LIGHT:U.DARK;this._applyTheme(n,!0)}_handleSystemThemeChange(t){if(!localStorage.getItem(vn)){let n=t.matches?U.DARK:U.LIGHT;this._applyTheme(n,!1)}}},Vs=new _n,ei=()=>Vs.init();var Dn={GENERATE_PDF:".generate-pdf",SAVE_DIET:"#save-diet",MANAGE_DIETS:"#manage-diets"};function ti(){let e=document.querySelector(Dn.GENERATE_PDF);e&&e.addEventListener("click",_o);let t=document.getElementById(Dn.SAVE_DIET.substring(1));t&&t.addEventListener("click",Fo);let n=document.getElementById(Dn.MANAGE_DIETS.substring(1));n&&typeof rn=="function"&&n.addEventListener("click",rn)}var ni="clear-selected-service",Gs=".service";function oi(){let e=document.getElementById(ni);if(!e){console.warn(`Clear Service: Bot\xF3 amb ID '${ni}' no trobat.`);return}e.addEventListener("click",()=>{let t=he(),n=document.querySelectorAll(Gs);if(t>=0&&t<n.length){let o=n[t],i=o.querySelectorAll('input:not([type="button"]):not([type="submit"]), select, textarea');i.forEach(s=>{s.value!==""&&s.classList.add("field-clearing")}),setTimeout(()=>{Ko(o),et(o),j(),i.forEach(s=>{s.classList.remove("field-clearing")}),console.log(`Servei ${t+1} netejat amb efecte visual.`)},600)}else console.warn(`Clear Service: \xCDndex de servei inv\xE0lid (${t}) o element no trobat.`)}),console.log("Funcionalitat 'Netejar Servei Seleccionat' configurada.")}function ii(){document.querySelectorAll('input[type="date"]').forEach(t=>{t.dataset.pickerSetup!=="true"&&(t.dataset.pickerSetup="true",typeof t.showPicker=="function"&&t.addEventListener("click",()=>{try{t.showPicker()}catch{}}))})}function si(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.dataset.pickerSetup!=="true"&&(t.dataset.pickerSetup="true",typeof t.showPicker=="function"&&t.addEventListener("click",()=>{try{t.showPicker()}catch{}}))})}var Hs={SERVICE_NUMBER_INPUT:".service-number"},ri={DIGITS_ONLY:"Solo se permiten d\xEDgitos (0-9) en el n\xFAmero de servicio."};function $s(e,t){let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e(...o),t)}}var ai=$s(m,300);function Xs(e){return/^\d*$/.test(e)}function ci(){let e=document.querySelectorAll(Hs.SERVICE_NUMBER_INPUT);if(!e.length){console.warn("Restrictions: No se han encontrado inputs '.service-number'.");return}e.forEach(t=>{t.dataset.restrictionsSetup!=="true"&&(t.dataset.restrictionsSetup="true",t.addEventListener("keypress",n=>{n.key==="Enter"||n.key==="Tab"||n.ctrlKey||n.metaKey||n.altKey||n.key.length>1||/\d/.test(n.key)||(n.preventDefault(),ai(ri.DIGITS_ONLY,"warning"))}),t.addEventListener("paste",n=>{try{let o=(n.clipboardData||window.clipboardData)?.getData("text")||"";Xs(o)||(n.preventDefault(),ai(ri.DIGITS_ONLY,"warning"))}catch(o){console.error("Error procesando 'paste':",o),n.preventDefault()}}))})}var li={SETTINGS_BTN:"settings",SETTINGS_PANEL:"settings-panel"},Ve={PANEL_VISIBLE:"visible",BUTTON_OPEN:"open"},K=null,J=null,di=!1;function js(e){e.stopPropagation();let t=J.classList.toggle(Ve.PANEL_VISIBLE);K.classList.toggle(Ve.BUTTON_OPEN,t),K.setAttribute("aria-expanded",t),t&&J.querySelector("button")?.focus()}function qs(e){J.classList.contains(Ve.PANEL_VISIBLE)&&!J.contains(e.target)&&!K.contains(e.target)&&yn()}function Ws(e){e.key==="Escape"&&J.classList.contains(Ve.PANEL_VISIBLE)&&(yn(),K.focus())}function yn(){J.classList.remove(Ve.PANEL_VISIBLE),K.classList.remove(Ve.BUTTON_OPEN),K.setAttribute("aria-expanded","false")}function ui(){di||(K=document.getElementById(li.SETTINGS_BTN),J=document.getElementById(li.SETTINGS_PANEL),!(!K||!J)&&(K.addEventListener("click",js),document.addEventListener("click",qs),document.addEventListener("keydown",Ws),J.querySelectorAll("button").forEach(e=>{e.addEventListener("click",yn)}),di=!0))}var Ys={SERVICE_BUTTONS:".service-button:not(.active-square)",OPTIONS_BTN:"#options-toggle",TABS:".tab:not(.active)"},zs="disabled-control";function An(e=!0){document.querySelectorAll(Object.values(Ys).join(", ")).forEach(n=>{n&&(n.classList.toggle(zs,e),n.setAttribute("aria-disabled",e?"true":"false"),n.disabled=e)})}var Ks="spa",Js=1,Qs="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ:/-\xC0\xC9\xCD\xD3\xDA\xC8\xD2\xC0\xDC\xCF\xC7\xD1",Ln=1500,Zs=.95,Ti="image/png",mi=10,er=300,tr=1e3;var nr={tessedit_char_whitelist:Qs,tessedit_pageseg_mode:6,load_system_dawg:!1,load_freq_dawg:!1},Q={CAMERA_BTN:"camera-in-dropdown",CAMERA_MODAL:"camera-gallery-modal",MODAL_CONTENT:".modal-bottom-content",OPTION_CAMERA:"option-camera",OPTION_GALLERY:"option-gallery",CAMERA_INPUT:"camera-input",OCR_PROGRESS_CONTAINER:".ocr-progress-container",OCR_PROGRESS_TEXT:".ocr-progress-text",OCR_SCAN_BTN:".btn-ocr-inline"},V={VISIBLE:"visible",HIDDEN:"hidden",SERVICE_COLORS:["service-1","service-2","service-3","service-4"]},or={ORIGIN_TIME:{id:"originTime",label:"Hora movilizaci\xF3n",fieldIdSuffix:"origin-time",lineKeywordRegex:/movilizaci|ltat|desplaza/i},DESTINATION_TIME:{id:"destinationTime",label:"Hora de llegada hospital",fieldIdSuffix:"destination-time",lineKeywordRegex:/arribada|hospital|aaah/i},END_TIME:{id:"endTime",label:"Hora Final",fieldIdSuffix:"end-time",valueRegex:/\d{2}\s*\/?\s*\d{2}\s*\/?\s*\d{2}\s+(\d{1,2}:\d{2}(?::\d{2})?)/i}},G=null,st=null,bt=null,Nn=null,O=null,Cn=!1,Ei=!1,fi=!1,gi=0;function ir(e){if(!e)return"";let t=e.replace(/[^\d:\-]/g,"");t=t.replace(/-/g,":");let n=t.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);if(n){let o=parseInt(n[1],10),i=parseInt(n[2],10);if(o>=0&&o<=23&&i>=0&&i<=59)return`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`}return""}function sr(){if(Date.now()-gi<500||(gi=Date.now(),!G||!st))return;document.body.classList.add("modal-open");let e=he(),t=V.SERVICE_COLORS[e]||"";st.classList.remove(...V.SERVICE_COLORS),t&&st.classList.add(t),G.classList.remove(V.HIDDEN),requestAnimationFrame(()=>G.classList.add(V.VISIBLE)),bt?.focus()}function Bt(){G&&(document.body.classList.remove("modal-open"),G.classList.remove(V.VISIBLE),setTimeout(()=>G.classList.add(V.HIDDEN),er))}function rr(e){G?.classList.contains(V.VISIBLE)&&!st?.contains(e.target)&&Bt()}function ar(){O&&(O.setAttribute("capture","environment"),O.click(),Bt())}function cr(){O&&(O.removeAttribute("capture"),O.click(),Bt())}function hi(){return document.querySelector(".service:not(.hidden)")}function Se(e,t){let o=hi()?.querySelector(Q.OCR_PROGRESS_CONTAINER);if(!o)return;o.classList.contains(V.HIDDEN)&&o.classList.remove(V.HIDDEN);let i=o.querySelector(Q.OCR_PROGRESS_TEXT);i&&(i.textContent=t)}function lr(){let t=hi()?.querySelector(Q.OCR_PROGRESS_CONTAINER);t&&setTimeout(()=>t.classList.add(V.HIDDEN),tr)}async function dr(e){try{let t=await createImageBitmap(e),{width:n,height:o}=t;if(Math.max(n,o)<=Ln)return t.close(),e;let i=Math.min(Ln/n,Ln/o),s=Math.round(n*i),a=Math.round(o*i),r=document.createElement("canvas");r.width=s,r.height=a;let c=r.getContext("2d");if(!c)throw new Error("No contexto 2D.");return c.drawImage(t,0,0,s,a),t.close(),new Promise(d=>r.toBlob(d,Ti,Zs))}catch(t){throw m("Error al procesar la imagen.","error"),t}}async function ur(e){try{let t=await createImageBitmap(e),n=document.createElement("canvas");n.width=t.width,n.height=t.height;let o=n.getContext("2d");if(!o)throw new Error("No contexto 2D.");return o.filter="grayscale(100%) contrast(180%) brightness(110%)",o.drawImage(t,0,0),t.close(),new Promise(i=>n.toBlob(i,Ti,1));u}catch(t){throw m("Error al mejorar la imagen.","error"),t}}function pi(e,t,n){let o=document.getElementById(e);if(o){o.value=t;let i=new Event("input",{bubbles:!0,cancelable:!0});o.dispatchEvent(i)}}function mr(e){if(!e||!e.trim()){m("No se reconoci\xF3 texto.","warning");return}let t=he(),n=zo(t)||"3.6",o=`-${t+1}`,i={},s=e.split(`
`),a=e.toLowerCase().replace(/ +/g," ");if(Object.values(or).forEach(c=>{if((n==="3.11"||n==="3.22")&&c.id==="destinationTime")return;let d=null;if(c.lineKeywordRegex){for(let l of s)if(c.lineKeywordRegex.test(l.toLowerCase())){let f=l.replace(/\D/g,"");if(f.length>=6){let _=f.slice(-6);d=[null,`${_.slice(0,2)}:${_.slice(2,4)}:${_.slice(4,6)}`];break}}}else c.valueRegex&&(d=a.match(c.valueRegex));if(d&&d[1]){let l=ir(d[1].trim());if(l&&!i[c.id]){let f=`${c.fieldIdSuffix}${o}`;pi(f,l,c.label),i[c.id]=c}}}),!i.endTime&&(i.originTime||i.destinationTime)){let c=new Date,d=String(c.getHours()).padStart(2,"0"),l=String(c.getMinutes()).padStart(2,"0"),f=`${d}:${l}`,_=`end-time${o}`;pi(_,f,"Hora Final (Actual)");let B=document.getElementById(_);B&&(B.classList.add("input-warning"),B.addEventListener("focus",()=>B.classList.remove("input-warning"),{once:!0}))}if(Object.keys(i).length>0){let c=Object.values(i).map(d=>d.label);m(`Campos actualizados: ${c.join(", ")}.`,"success")}else m("No se encontraron horas relevantes.","info")}function Si(){if(Ei||(G=document.getElementById(Q.CAMERA_MODAL),st=G?.querySelector(Q.MODAL_CONTENT),bt=document.getElementById(Q.OPTION_CAMERA),Nn=document.getElementById(Q.OPTION_GALLERY),O=document.getElementById(Q.CAMERA_INPUT),!G||!bt||!Nn||!O))return;document.querySelectorAll(Q.OCR_SCAN_BTN).forEach(t=>t.addEventListener("click",sr)),bt.addEventListener("click",ar),Nn.addEventListener("click",cr),O.addEventListener("change",fr),document.addEventListener("click",rr),document.addEventListener("keydown",t=>{t.key==="Escape"&&G?.classList.contains(V.VISIBLE)&&Bt()}),Ei=!0}function Er(){window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}async function fr(e){if(Cn){m("Proceso OCR ya en marcha.","warning");return}let t=e.target.files?.[0];if(!t)return;if(!t.type.startsWith("image/")){m("Selecciona una imagen.","error"),O&&(O.value="");return}let n=mi*1024*1024;if(t.size>n){m(`La imagen es demasiado grande (m\xE1x. ${mi} MB).`,"error"),O&&(O.value="");return}Cn=!0,An(!0),Se(0,"Preparando imagen..."),Er();let o=null;try{let i=await dr(t);i=await ur(i),Se(5,"Cargando motor OCR..."),fi||await new Promise((a,r)=>{let c=document.createElement("script");c.src="https://cdn.jsdelivr.net/npm/tesseract.js@6/dist/tesseract.min.js",c.onload=()=>{fi=!0,a()},c.onerror=r,document.head.appendChild(c)}),o=await Tesseract.createWorker(Ks,Js,{logger:a=>{if(a.status==="recognizing text"){let r=Math.max(10,Math.floor(a.progress*100));Se(r,`Reconociendo texto ${r}%...`)}else a.status==="loading language model"&&Se(5,"Cargando modelo de idioma...")}}),await o.setParameters(nr),Se(10,"Reconociendo texto 10%...");let{data:{text:s}}=await o.recognize(i);Se(100,"An\xE1lisis completado."),mr(s)}catch(i){m(`Error de escaneo: ${i.message||"Desconocido"}`,"error"),Se(0,"Error en el escaneo.")}finally{o&&await o.terminate(),O&&(O.value=""),lr(),An(!1),Cn=!1}}var Ii="anonymousUserId";function vi(){try{let e=localStorage.getItem(Ii);return e||(e=`user-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,localStorage.setItem(Ii,e)),e}catch{return`temp-user-${Date.now()}`}}var _i=document.getElementById("save-pill"),He=document.querySelector(".tab-content-container"),Ge=0,Di=!1,gr=10,pr=150,Tr=He&&parseInt(window.getComputedStyle(He).paddingBottom,10)||60;function On(e=Ge){Di=e>pr,Di?(_i.style.bottom=`calc(${e}px + ${gr}px + env(safe-area-inset-bottom, 0px))`,He&&(He.style.paddingBottom=`${e+50}px`)):(_i.style.bottom="calc(20px + env(safe-area-inset-bottom, 0px))",He&&(He.style.paddingBottom=`${Tr}px`))}if("virtualKeyboard"in navigator)navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",e=>{Ge=e.target.boundingRect.height,On(Ge)});else{let e=window.innerHeight;window.addEventListener("resize",()=>{window.innerHeight<e?(Ge=e-window.innerHeight,On(Ge)):(Ge=0,On(0))})}var hr=document.querySelectorAll('input:not([type="checkbox"]), select, textarea');function Sr(e){let t=e.target;t.closest(".modal")||setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"center"})},250)}hr.forEach(e=>{e.addEventListener("focus",Sr)});var yi="notes-selected-service",Ir="notes-modal",vr="notes-title",_r="notes-textarea",Dr="notes-save",yr="notes-cancel",Ar="notes-char-counter",$e,bn,v,Pt,Rn,Ie,rt=null,at=null,ct=null;function Ai(){let e=document.getElementById(yi);if(!e){console.warn(`Notes Service: Bot\xF3 amb ID '${yi}' no trobat.`);return}if($e=document.getElementById(Ir),bn=document.getElementById(vr),v=document.getElementById(_r),Pt=document.getElementById(Dr),Rn=document.getElementById(yr),Ie=document.getElementById(Ar),!$e||!bn||!v||!Pt||!Rn||!Ie){console.error("Notes Service: Un o m\xE9s elements del modal de notes no s'han trobat.");return}e.addEventListener("click",()=>{let t=he();Lr(t)}),Rn.addEventListener("click",Bn),console.log("Funcionalitat 'Afegir Notes' configurada.")}function Lr(e){if(!$e)return;bn.textContent=`S${e+1}: Observaciones`,v.value=Y[e]||"";let t=v.maxLength,n=()=>{let o=v.value.length;Ie.textContent=`${o} / ${t}`,Ie.classList.remove("warning","limit"),v.classList.remove("input-warning","input-error"),o>=t?(Ie.classList.add("limit"),v.classList.add("input-error")):o>t*.8&&(Ie.classList.add("warning"),v.classList.add("input-warning"))};n(),at=()=>{v.value.length>t&&(v.value=v.value.slice(0,t)),n()},v.addEventListener("input",at),ct=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),v.blur())},v.addEventListener("keydown",ct),rt=()=>{let o=v.value.trim(),i=Y[e]||"";if(o===i){Bn();return}Y[e]=o,o?m("Observaci\xF3n guardada.","success"):m("Observaci\xF3n eliminada.","info"),Bn(),j()},Pt.addEventListener("click",rt),$e.style.display="block",document.body.classList.add("modal-open"),setTimeout(()=>{v.focus({preventScroll:!0}),v.setSelectionRange(v.value.length,v.value.length)},0)}function Bn(){$e&&(rt&&(Pt.removeEventListener("click",rt),rt=null),at&&(v.removeEventListener("input",at),at=null),ct&&(v.removeEventListener("keydown",ct),ct=null),Ie.classList.remove("warning","limit"),v.classList.remove("input-warning","input-error"),$e.style.display="none",document.body.classList.remove("modal-open"))}var Nr=e=>{let n=`; ${document.cookie}`.split(`; ${e}=`);if(n.length===2)return n.pop()?.split(";").shift()},Li=(e,t,n)=>{let o=new Date;o.setTime(o.getTime()+n*24*60*60*1e3);let i=`expires=${o.toUTCString()}`;document.cookie=`${e}=${t};${i};path=/;SameSite=Lax;Secure`},Xe,Pn,wn;function Cr(){let e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-23SXKMLR75",document.head.appendChild(e),e.onload=()=>{window.gtag("js",new Date),window.gtag("config","G-23SXKMLR75")}}function Or(){Cr(),Li("cookie_consent","granted",365),Ni()}function Rr(){typeof window.gtag=="function"&&window.gtag("consent","update",{analytics_storage:"denied"}),Li("cookie_consent","denied",365),Ni()}function br(){Xe&&Xe.classList.remove("hidden")}function Ni(){Xe&&Xe.classList.add("hidden")}function Ci(){if(Xe=document.getElementById("cookie-consent-banner"),Pn=document.getElementById("accept-cookies"),wn=document.getElementById("decline-cookies"),!Xe||!Pn||!wn){console.warn("Elements del b\xE0ner de cookies no trobats.");return}Nr("cookie_consent")||(br(),Pn.addEventListener("click",Or),wn.addEventListener("click",Rr))}var Br="openDonation",Pr="userSelectedServiceType";function wr(){let e=document.getElementById(Br);if(!e)return console.warn("No s'ha trobat l'enlla\xE7 de donaci\xF3.");let t=vi();try{let n=new URL(e.href);n.searchParams.set("custom",t),e.href=n.toString(),console.log("Enlla\xE7 de donaci\xF3 actualitzat amb ID an\xF2nim.")}catch(n){console.error("Error modificant l'URL de donaci\xF3:",n)}}function Mr(){let e=document.getElementById("offline-indicator");if(!e)return;function t(){navigator.onLine?e.hidden=!0:e.hidden=!1}t(),window.addEventListener("online",t),window.addEventListener("offline",t)}async function Oi(){try{console.log("initializeApp() iniciant..."),Wn(),zn(),await jn(),Yo(),lo(),Re.init(),Si(),Vn(),ro(),ti(),oi(),Ai(),Ro(),ii(),si(),ui(),ei(),wr(),ci(),io(),$o(),Xo(),jo();let e=document.getElementById("service-type");if(e){let t=localStorage.getItem(Pr);(t==="TSU"||t==="TSNU")&&(e.value=t,console.log(`[LocalStorage] Carregat tipus de servei: ${t}`)),Ue(e.value)}Te(),Kn(),Ci(),Mr(),console.log("initializeApp() completada.")}catch(e){console.error("Error en la inicialitzaci\xF3 de l'app:",e)}}async function Ri(){try{await Oi(),To(),document.body.classList.add("app-ready")}catch(e){console.error("Error cr\xEDtic en startApp:",e),document.body.classList.add("app-ready")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ri):Ri();console.log("App.js carregat, esperant DOMContentLoaded per inicialitzar...");})();
