(()=>{var m={DATE_INPUT:"date",DIET_TYPE_SELECT:"diet-type",TOP_BAR:".top-bar",FOOTER:"footer",EASTER_EGG_OVERLAY:".easter-egg-overlay",EASTER_EGG_ICON:".easter-egg-icon",SERVICE_NUMBER_PREFIX:"service-number-",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2",TAB_DADES:"tab-dades",TAB_SERVEIS:"tab-serveis",CONTENT_DADES:"dades-tab-content",CONTENT_SERVEIS:"serveis-tab-content",MAIN_CONTENT_AREA:"main-content",CONTAINER:"services-container",BUTTONS_CONTAINER:"service-buttons-container",OPTIONS_MENU:"options-menu",OPTIONS_TOGGLE_BTN:"options-toggle",CLEAR_BTN:"clear-selected-service",CAMERA_BTN:"camera-in-dropdown",CHIP_GROUP:"service-mode-chips",SIGNATURE_MODAL:"signature-modal",CANVAS:"signature-canvas",CANCEL_BTN:"signature-cancel",ACCEPT_BTN:"signature-accept",SIGN_PERSON1_BTN:"sign-person1",SIGN_PERSON2_BTN:"sign-person2",TITLE:"signature-title",DOTACIO_MODAL:"dotacio-modal",OPTIONS_CONTAINER_DOT:"dotacio-options",TEMPLATE:"dotacio-template",NO_DOTACIO_TEXT:"no-dotacio-text",ADD_BTN:"add-dotacio",OPEN_MODAL_BTN:"open-dotacio-modal",CLOSE_MODAL_BTN:"close-dotacio-modal",DIET_MODAL:"diet-modal",DIET_OPTIONS_LIST:"diet-options",NO_DIETS_TEXT:"no-diets-text",CONFIRM_MODAL:"confirm-modal",CONFIRM_MESSAGE:"confirm-message",CONFIRM_TITLE:".modal-title",CONFIRM_YES_BTN:"confirm-yes",CONFIRM_NO_BTN:"confirm-no",ABOUT_MODAL:"about-modal",CAMERA_GALLERY_MODAL:"camera-gallery-modal",CAMERA_MODAL:"camera-gallery-modal",MODAL_CONTENT:".modal-bottom-content",OPTION_CAMERA:"option-camera",OPTION_GALLERY:"option-gallery",CAMERA_INPUT:"camera-input",OCR_PROGRESS_CONTAINER:".ocr-progress-container",OCR_PROGRESS_TEXT:".ocr-progress-text",OCR_SCAN_BTN:".btn-ocr-inline",SAVE_DIET:"save-diet",NOTES_BUTTON_ID:"notes-selected-service",NOTES_MODAL_ID:"notes-modal",NOTES_TITLE_ID:"notes-title",NOTES_TEXTAREA_ID:"notes-textarea",NOTES_SAVE_ID:"notes-save",NOTES_CANCEL_ID:"notes-cancel",NOTES_COUNTER_ID:"notes-char-counter",SETTINGS_BTN:"settings",SETTINGS_PANEL:"settings-panel",TOGGLE_BTN:"theme-toggle-btn",THEME_ICON:"theme-icon",THEME_TEXT:"theme-btn-text",SAVE_PILL:"save-pill",DONATION_LINK_ID:"openDonation",COOKIE_CONSENT_BANNER:"cookie-consent-banner",ACCEPT_COOKIES:"accept-cookies",DECLINE_COOKIES:"decline-cookies"},C={INPUT_ERROR:"input-error",ACTIVE_TAB:"active",ERROR_TAB:"error-tab",MODAL_OPEN:"modal-open",MODAL_VISIBLE:"visible",MODAL_OPEN_BODY:"modal-open",HIDDEN:"hidden",TOP_BAR_TAPS:3,FOOTER_TAPS:2,TIMEOUT:1e3,ANIMATION_DURATION:1e3,DEFAULT_DURATION:3e3,ALLOWED_TYPES:["info","success","error","warning"],MAX_QUEUE_SIZE:10,ANIMATION:{ENTER:"toast-enter",EXIT:"toast-exit"},UNDO_BTN_CLASS:"toast-undo-btn",DEFAULT_PRIORITY:1,SERVICE_HIDDEN:"hidden",BUTTON_ACTIVE:"active-square",CHIP_ACTIVE:"chip-active",PANEL_VISIBLE:"visible",BUTTON_OPEN:"open",DIET_ITEM:"diet-item",DIET_DATE:"diet-date",DIET_ICONS:"diet-icons",DIET_LOAD_BTN:"diet-load",DIET_DELETE_BTN:"diet-delete",LIST_ITEM_BTN:"list-item-btn",LIST_ITEM_BTN_LOAD:"list-item-btn--load",LIST_ITEM_BTN_DELETE:"list-item-btn--delete",DIET_ITEM_SWIPING:"swiping",DIET_DELETE_REVEAL:"delete-reveal",INPUT_ERROR_DOT:"input-error",IS_INSTALLED:"pwa_isInstalled",PROMPT_DISMISSED_COUNT:"pwa_promptDismissedCount",NEVER_SHOW_AGAIN:"pwa_neverShowAgain",ACTION_TRIGGER_COUNT:"pwa_actionTriggerCount",PROMPT_DISMISSED_LIMIT:2,ACTION_TRIGGER_LIMIT:10,DARK_THEME:"theme-dark",VISIBLE:"visible",HAS_CHANGES:"has-changes",SAVING:"saving",HAS_SAVED:"has-saved",ERROR:"error",SIGNED:"signed",MODAL_CLOSE_BTN:".close-modal, .close-modal-btn",MODAL_TRIGGER:'a[href^="#"]',FOCUSABLE_ELEMENTS:'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'},ve={SERVICE_PANEL:".service",SERVICE_BUTTON:".service-button",CHIP:".chip",FORM_GROUP:".form-group",PERSON_INPUT_GROUP:".input-with-icon",TEXT_SEL:".pill-text",SERVICE_CONTAINER_SELECTOR:".service",DOTACIO_INFO:".dotacio-info",LOAD_BTN:".dotacio-load",DELETE_BTN:".dotacio-delete",SERVICE_NUMBER_INPUT:".service-number"},Ft={serviceNumber:".service-number",origin:".origin",destination:".destination",originTime:".origin-time",destinationTime:".destination-time",endTime:".end-time",mode:".chip-active",notes:""},q={SERVICE_NUMBER_LENGTH:9,VEHICLE_MAX_LENGTH:6,PERSON_NAME_MAX_LENGTH:28,LOCATION_MAX_LENGTH:35,PERSON_NAME_ALLOWED_CHARS:/^[a-zA-Z\s'’áéíóúàèìòùäëïöüñçÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÑÇ]+$/u},kn={DEBOUNCE_TOAST:300,DEBOUNCE_AUTO_SAVE:1e3,DEBOUNCE_HANDLER:800};var We={LUNCH:"lunch",DINNER:"dinner"},Hn=ve.SERVICE_CONTAINER_SELECTOR,kt={SERVICE_NUMBER_DIGITS_ONLY:"Solo se permiten d\xEDgitos (0-9) en el n\xFAmero de servicio.",SAVE_ERROR_DIGITAL_ONLY:"El n\xFAmero de servicio debe contener solo d\xEDgitos.",VALIDATION_FAILED:"Validaci\xF3n fallida",OCR_PROCESS_RUNNING:"Proceso OCR ya en marcha.",INVALID_IMAGE:"Selecciona una imagen.",IMAGE_TOO_BIG:"La imagen es demasiado grande (m\xE1x. 10 MB).",OCR_ERROR:"Error de escaneo",IMAGE_PROCESS_ERROR:"Error al procesar la imagen.",OCR_COMPLETE:"An\xE1lisis completado.",SAVING:"Guardando\u2026",SAVED:"Guardado",SAVE_ERROR:"No se pudo guardar",DOWNLOAD_STARTED:"Descarga iniciada correctamente.",PDF_GENERATION_ERROR:"Error en la generaci\xF3n del PDF",DOTACIO_SAVED:"Dotaci\xF3n guardada.",DOTACIO_LOADED:"Dotaci\xF3n cargada.",DOTACIO_DELETED:"Dotaci\xF3n eliminada."};var $n={DOTACIIONS:"dotacions_v2",ANONYMOUS_USER:"anonymousUserId",COOKIE_CONSENT:"cookie_consent",THEME_PREFERENCE:"themePreference",USER_SELECTED_SERVICE_TYPE:"userSelectedServiceType",ONBOARDING_COMPLETED:"onboardingCompleted"};var O={CONTAINER_ID:"toast-container",TOAST_CLASS:"toast",DEFAULT_DURATION:3e3,DEFAULT_TYPE:"info",ALLOWED_TYPES:["info","success","error","warning"],MAX_QUEUE_SIZE:10,ANIMATION:{ENTER:"toast-enter",EXIT:"toast-exit"},UNDO_BTN_CLASS:"toast-undo-btn",DEFAULT_PRIORITY:1},h={queue:[],isVisible:!1,container:null,currentTimeout:null},Wi=e=>e&&typeof e=="string"?e.replace(/[<>&]/g,""):"";function Yi(e,t,n){if(!e||typeof e!="string"||!e.trim())throw new Error("El missatge del toast \xE9s obligatori i ha de ser una cadena no buida.");if(!O.ALLOWED_TYPES.includes(t))throw new Error(`Tipus de toast inv\xE0lid: ${t}. Ha de ser un de: ${O.ALLOWED_TYPES.join(", ")}`);if(!Number.isInteger(n)||n<0||n>6e4)throw new Error("La durada ha d'estar entre 0 i 60000\u202Fms.")}function zi(){return!h.container&&(h.container=document.getElementById(O.CONTAINER_ID),!h.container)?(console.error(`[Toast] Contenidor '#${O.CONTAINER_ID}' no trobat.`),null):h.container}function Ht(e){h.currentTimeout&&(clearTimeout(h.currentTimeout),h.currentTimeout=null),e&&(e.classList.add(O.ANIMATION.EXIT),e.addEventListener("transitionend",()=>e.remove(),{once:!0})),h.isVisible=!1,Xn()}function Ki({message:e,type:t,duration:n,options:o}){let i=zi();if(!i)return;let s=document.createElement("div");s.className=`${O.TOAST_CLASS} ${t}`,s.setAttribute("role","alert"),s.setAttribute("aria-live","polite"),s.setAttribute("aria-atomic","true"),s.textContent=Wi(e);let a=!0;if(o?.undoCallback instanceof Function){let r=document.createElement("button");r.type="button",r.className=O.UNDO_BTN_CLASS,r.textContent="Deshacer",r.setAttribute("aria-label","Deshacer la acci\xF3n"),r.addEventListener("click",()=>{a=!1;try{o.undoCallback()}finally{Ht(s)}}),s.appendChild(r)}i.appendChild(s),requestAnimationFrame(()=>{s.classList.add(O.ANIMATION.ENTER)}),h.currentTimeout=setTimeout(()=>{a&&o?.onExpire instanceof Function&&o.onExpire(),Ht(s)},n)}function Xn(){h.isVisible||h.queue.length===0||(h.isVisible=!0,h.queue.sort((e,t)=>t.priority-e.priority),Ki(h.queue.shift()))}function d(e,t=O.DEFAULT_TYPE,n=O.DEFAULT_DURATION,o={}){Yi(e,t,n);let i=o.priority??O.DEFAULT_PRIORITY,s={message:e,type:t,duration:n,priority:i,options:o};if(!(o.queueable!==!1)&&h.isVisible){if(h.container){let c=h.container.querySelector(`.${O.TOAST_CLASS}:not(.${O.ANIMATION.EXIT})`);c&&c.remove()}Ht()}h.queue.length>=O.MAX_QUEUE_SIZE&&h.queue.sort((c,l)=>c.priority-l.priority).shift();let r=h.queue.findIndex(c=>c.priority<i);r===-1?h.queue.push(s):h.queue.splice(r,0,s),Qi(),Xn()}function Qi(){let e="toast-undo-style";if(document.getElementById(e))return;let t=document.body.getAttribute("data-csp-nonce"),n=document.createElement("style");n.id=e,t&&n.setAttribute("nonce",t),n.textContent=`
    .${O.UNDO_BTN_CLASS} {
      margin-left: auto; 
      padding: 8px 12px; 
      background: none;
      border: none;
      border-radius: 4px; 
      cursor: pointer;     
      font-weight: 600;
      font-size: 0.875rem; 
      text-transform: uppercase; 
      letter-spacing: 0.08em; 
      color: inherit; 
      transition: background-color 0.2s ease;
    }
    .${O.UNDO_BTN_CLASS}:hover {
      background-color: rgba(255, 255, 255, 0.15); 
    }
  `,document.head.appendChild(n)}function ue(e){e?.classList.add(C.INPUT_ERROR)}function Ae(e){e?.classList.remove(C.INPUT_ERROR)}function qn(e){if(!e||e.length===0)return"";let t=e.map(n=>`S${n}`);return t.length===1?t[0]:t.length===2?t.join(" y "):`${t.slice(0,-1).join(", ")} y ${t[t.length-1]}`}function Ye(e){!e||e.dataset.errorListenerAttached||(e.addEventListener("input",()=>Ae(e),{once:!0}),e.dataset.errorListenerAttached="true")}function jn(e,t,n,o){if(!e)return!0;Ae(e);let i=e.value.trim(),s=!1;return i?/^\d+$/.test(i)?i.length!==q.SERVICE_NUMBER_LENGTH&&(o.digitLength.push(t),s=!0):(o.nonNumeric.push(t),s=!0):n&&(o.emptyRequiredS1=!0,s=!0),s?(ue(e),Ye(e),!1):!0}function Ji(e){let t=[];return e.nonNumeric.length>0&&t.push(`El n\xFAmero de servicio ${qn(e.nonNumeric)} debe contener solo d\xEDgitos.`),e.digitLength.length>0&&t.push(`El n\xFAmero de servicio ${qn(e.digitLength)} debe tener ${q.SERVICE_NUMBER_LENGTH} d\xEDgitos.`),t}function Tt(){let e=!0;return[document.getElementById(m.DATE_INPUT),document.getElementById(m.DIET_TYPE_SELECT)].filter(Boolean).forEach(n=>{Ae(n),n.value.trim()||(ue(n),Ye(n),e=!1)}),e}function ft(){let e={emptyRequiredS1:!1,nonNumeric:[],digitLength:[]},t=!0,n=document.getElementById(`${m.SERVICE_NUMBER_PREFIX}1`);if(!n)return console.error("Validation: No se ha encontrado el input para el servicio S1."),!1;t=jn(n,1,!0,e)&&t;for(let i=2;i<=4;i++){let s=document.getElementById(`${m.SERVICE_NUMBER_PREFIX}${i}`);s&&(t=jn(s,i,!1,e)&&t)}if(t)return!0;let o=Ji(e);return o.length>0&&d(o.join(`
`),"error"),!1}function A(e){return typeof e!="string"?"":e.trim().replace(/[<>&"'`]/g,"").trim()}function pt(e){return e?/^(?:2[0-3]|[01]?[0-9]):[0-5][0-9]$/.test(e):!0}function Wn(e,t,n,o){let i=e?.value.trim()||"";return i&&!q.PERSON_NAME_ALLOWED_CHARS.test(i)?(ue(t),!1):i.length>q.PERSON_NAME_MAX_LENGTH?(ue(t),o.push(`El nombre del ${n} no puede superar los ${q.PERSON_NAME_MAX_LENGTH} caracteres.`),!1):!0}function Yn(){let e=document.getElementById(m.VEHICLE_INPUT),t=document.getElementById(m.PERSON1_INPUT),n=document.getElementById(m.PERSON2_INPUT),o=t?.closest(ve.PERSON_INPUT_GROUP),i=n?.closest(ve.PERSON_INPUT_GROUP);Ae(e),Ae(o),Ae(i);let s=e?.value.trim()||"",a=t?.value.trim()||"",r=n?.value.trim()||"",c=!0,l=[];return s||(ue(e),l.push("El campo Veh\xEDculo es obligatorio."),c=!1),c=Wn(t,o,"Conductor",l)&&c,c=Wn(n,i,"Ayudante",l)&&c,!a&&!r&&(ue(o),ue(i),l.push("Debe indicar al menos un Conductor o Ayudante."),c=!1),c||(Ye(e),Ye(t),Ye(n),d(l.join(`
`),"error")),c}function zn(){let e=q.PERSON_NAME_ALLOWED_CHARS,t=/^[^\x00-\x1F\x7F<>&"'`]*$/u;function n(l){let u=l.target.value;e.test(u)||(l.target.value=u.replace(/[^a-zA-Z\s'’áéíóúàèìòùäëïöüñçÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÑÇ.]/g,""))}function o(l){let u=l.target.value;t.test(u)||(l.target.value=u.replace(/[<>&"'`]/g,"").trim())}function i(l){l.key==="Enter"||l.key==="Tab"||l.ctrlKey||l.metaKey||l.altKey||l.key.length>1||e.test(l.key)||l.preventDefault()}function s(l){l.key==="Enter"||l.key==="Tab"||l.ctrlKey||l.metaKey||l.altKey||l.key.length>1||t.test(l.key)||l.preventDefault()}[document.getElementById(m.PERSON1_INPUT),document.getElementById(m.PERSON2_INPUT)].filter(Boolean).forEach(l=>{l.addEventListener("input",n),l.addEventListener("keypress",i)}),document.querySelectorAll(".service .origin, .service .destination").forEach(l=>{l.addEventListener("input",o),l.addEventListener("keypress",s)});let c=document.getElementById(m.VEHICLE_INPUT);c&&c.addEventListener("input",l=>{l.target.value.length>q.VEHICLE_MAX_LENGTH&&(l.target.value=l.target.value.slice(0,q.VEHICLE_MAX_LENGTH))})}var Zi=["3.6","3.51","3.22","3.11"],Ne={CONTAINER:"services-container",BUTTONS_CONTAINER:"service-buttons-container",OPTIONS_MENU:"options-menu",OPTIONS_TOGGLE_BTN:"options-toggle",CLEAR_BTN:"clear-selected-service",CAMERA_BTN:"camera-in-dropdown",CHIP_GROUP:"service-mode-chips"},Qe={SERVICE_PANEL:".service",SERVICE_BUTTON:".service-button",CHIP:".chip",FORM_GROUP:".form-group"},I={SERVICE_HIDDEN:"hidden",BUTTON_ACTIVE:"active-square",SERVICE_COLORS:["service-1","service-2","service-3","service-4"],OPTIONS_MENU_HIDDEN:"hidden",CHIP_ACTIVE:"chip-active"},es=[".chip-group-title",".chip-group",".btn-ocr-inline",".section-divider"],ts=[".destination",".destination-time"],Kn=!1,De=0,D=[],Je=[],Qn=[],$t=null,ze=null,j=null,Ke=null,ns=null,os=[],ne=[],W=["","","",""];function is(){ze&&(ze.innerHTML="",Je=D.map((e,t)=>{let n=document.createElement("button");return n.className=`service-button ${I.SERVICE_COLORS[t]}`,n.textContent=`S${t+1}`,n.type="button",n.setAttribute("aria-label",`Mostrar servei ${t+1}`),n.addEventListener("click",()=>ls(t)),ze.appendChild(n),n}))}function ss(){!j||!Ke||(Ke.addEventListener("click",e=>{e.stopPropagation(),j.classList.toggle(I.OPTIONS_MENU_HIDDEN)}),document.addEventListener("click",e=>{!Ke?.contains(e.target)&&!j?.contains(e.target)&&j.classList.add(I.OPTIONS_MENU_HIDDEN)}),document.addEventListener("keydown",e=>{e.key==="Escape"&&j&&j.classList.add(I.OPTIONS_MENU_HIDDEN)}),j.addEventListener("click",e=>{e.target.closest("button")&&j.classList.add(I.OPTIONS_MENU_HIDDEN)}))}function rs(e,t){let n=e.querySelector(t);return n?n.closest(Qe.FORM_GROUP):null}function gt(e,t){if(!e)return;let n=t!=="3.6";ts.forEach(i=>{rs(e,i)?.classList.toggle(I.SERVICE_HIDDEN,n)});let o=e.querySelector(".origin");o&&(n?o.setAttribute("enterkeyhint","done"):o.removeAttribute("enterkeyhint"))}function as(e){ns&&os.forEach(t=>t.classList.toggle(I.CHIP_ACTIVE,t.dataset.mode===e))}function St(e,t){e.querySelectorAll(Qe.CHIP).forEach(o=>o.classList.toggle(I.CHIP_ACTIVE,o.dataset.mode===t))}function cs(){D.forEach((e,t)=>{e.querySelectorAll(Qe.CHIP).forEach(o=>{o.addEventListener("click",()=>{let i=o.dataset.mode;if(!Zi.includes(i)){console.error(`Intent de canviar a un mode inv\xE0lid: "${i}". Acci\xF3 bloquejada.`);return}if(ne[t]===i)return;ne[t]=i,St(e,i),gt(e,i);let s=e.querySelector(".chip-group");s&&(I.SERVICE_COLORS.forEach(a=>s.classList.remove(a)),s.classList.add(I.SERVICE_COLORS[t])),Y()})})})}function Xt(e){let t=I.SERVICE_COLORS[e],n=(o,i)=>{o&&(o.classList.remove(...I.SERVICE_COLORS),o.classList.add(i,t))};n(document.getElementById(Ne.CLEAR_BTN),"clear-selected-btn"),n(document.getElementById(Ne.CAMERA_BTN),"camera-btn"),n(document.getElementById("notes-selected-service"),"notes-btn"),n(Ke,"options-btn")}function Jn(){if(!Kn&&(Qn=document.querySelectorAll(Qe.SERVICE_PANEL),$t=document.getElementById(Ne.CONTAINER),ze=document.getElementById(Ne.BUTTONS_CONTAINER),j=document.getElementById(Ne.OPTIONS_MENU),Ke=document.getElementById(Ne.OPTIONS_TOGGLE_BTN),!(!$t||!ze)&&(D=Array.from($t.querySelectorAll(Qe.SERVICE_PANEL)),!!D.length))){if(ne=D.map(()=>"3.6"),is(),ss(),cs(),D.length>0&&Je.length>0){D.forEach((n,o)=>n.classList.toggle(I.SERVICE_HIDDEN,o!==0)),Je[0].classList.add(I.BUTTON_ACTIVE);let e=ne[0];gt(D[0],e),St(D[0],e);let t=D[0].querySelector(".chip-group");t&&t.classList.add(I.SERVICE_COLORS[0]),as(e),Xt(0)}Kn=!0}}function ls(e){if(e<0||e>=D.length||e===De)return;D[De].classList.add(I.SERVICE_HIDDEN),D[e].classList.remove(I.SERVICE_HIDDEN),Je[De].classList.remove(I.BUTTON_ACTIVE),Je[e].classList.add(I.BUTTON_ACTIVE),De=e;let t=ne[e];gt(D[e],t),St(D[e],t);let n=D[e].querySelector(".chip-group");n&&(I.SERVICE_COLORS.forEach(o=>n.classList.remove(o)),n.classList.add(I.SERVICE_COLORS[e])),Xt(e)}var Ee=()=>De,Zn=e=>{if(e>=0&&e<ne.length)return ne[e]};function eo(e){e&&e.querySelectorAll("input, select, textarea").forEach(t=>{t.type==="checkbox"||t.type==="radio"?t.checked=!1:t.type!=="button"&&t.type!=="submit"&&t.type!=="reset"&&(t.value=""),t.tagName==="SELECT"&&(t.selectedIndex=0)})}function qt(){Xt(De)}function to(e,t){if(e<0||e>=D.length)return;ne[e]=t;let n=D[e];n&&(St(n,t),gt(n,t),Y())}function Le(e){let t=e==="TSNU";Qn.forEach(n=>{es.forEach(o=>{n.querySelector(o)?.classList.toggle(I.SERVICE_HIDDEN,t)})})}function Ze(e){e&&e.querySelectorAll(".input-error").forEach(t=>t.classList.remove("input-error"))}function ds(){let e="dietSalt",t=(o=16)=>Array.from({length:o},()=>Math.floor(Math.random()*256).toString(16).padStart(2,"0")).join(""),n=localStorage.getItem(e);if(!n){if(window.crypto?.getRandomValues){let o=crypto.getRandomValues(new Uint8Array(16));n=Array.from(o).map(i=>i.toString(16).padStart(2,"0")).join("")}else console.warn("[pseudoId] crypto.getRandomValues no disponible; usant Math.random() (menys segur, nom\xE9s mode desenvolupament)."),n=t(16);localStorage.setItem(e,n)}return n}async function Oe(e){if(!window.crypto?.subtle)return console.warn("[pseudoId] WebCrypto no disponible (context no segur). S\u2019usar\xE0 l\u2019ID en clar nom\xE9s en aquesta sessi\xF3."),e;let n=new TextEncoder().encode(ds()+e),o=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(o)).map(i=>i.toString(16).padStart(2,"0")).join("")}var jt=new Intl.RelativeTimeFormat("es",{numeric:"auto"});function no(e){if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("La data proporcionada no \xE9s v\xE0lida.");let t=Date.now()-e.getTime();if(t<0)return"en el futuro";let n=Math.round(t/1e3);if(n<45)return"hace unos segundos";if(n<90)return"hace un minuto";let o=Math.round(n/60);if(o<60)return jt.format(-o,"minute");let i=Math.round(o/60);if(i<24)return jt.format(-i,"hour");let s=Math.round(i/24);return jt.format(-s,"day")}var us="DietasDB";var z="dietas",oo="dateIndex",x=null;function io(){return new Promise((e,t)=>{let n=indexedDB.open(us,1);n.onupgradeneeded=o=>{let i=o.target.result,s;i.objectStoreNames.contains(z)?s=o.target.transaction.objectStore(z):s=i.createObjectStore(z,{keyPath:"id"}),s.indexNames.contains(oo)||s.createIndex(oo,"date",{unique:!1})},n.onsuccess=o=>{x=o.target.result,x.onclose=()=>x=null,x.onerror=()=>x=null,x.onversionchange=()=>x.close(),e(x)},n.onerror=o=>t(o.target.error),n.onblocked=()=>t(new Error("IndexedDB bloquejat per una altra pestanya"))})}async function et(e="readonly"){return(x??(x=await io())).transaction(z,e)}function tt(e,t){return new Promise((n,o)=>{e.onsuccess=i=>n(i.target.result),e.onerror=i=>o(new Error(`${t}: ${i.target.error}`))})}function Wt(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onerror=()=>n(e.error),e.onabort=()=>n(e.error)})}async function Yt(e){try{let t=await et("readwrite");return tt(t.objectStore(z).add(e),"No s'ha pogut afegir"),await Wt(t),e.id}catch(t){throw t.name==="QuotaExceededError"||t.message?.includes("Quota")?new Error("No hi ha espai suficient a l'emmagatzematge local. Elimina antigues dietes per alliberar espai."):t}}async function so(e){try{let t=await et("readwrite");return tt(t.objectStore(z).put(e),"No s'ha pogut actualitzar"),await Wt(t),e.id}catch(t){throw t.name==="QuotaExceededError"||t.message?.includes("Quota")?new Error("No hi ha espai suficient a l'emmagatzematge local. Elimina antigues dietes per alliberar espai."):t}}async function oe(e){if(!e)return;let t=await et();return tt(t.objectStore(z).get(e),"Error obtenint dieta")}async function ht(){let e=await et();return tt(e.objectStore(z).getAll(),"Error llistant dietes")}async function ro(e){if(!e)return;let t=await et("readwrite");tt(t.objectStore(z).delete(e),"Error eliminant dieta"),await Wt(t)}async function ao(){return x??(x=await io())}var Es="save-pill",ms=".pill-text",K={VISIBLE:"visible",HAS_CHANGES:"has-changes",SAVING:"saving",HAS_SAVED:"has-saved",ERROR:"error"},co=2e3;var ie=null,zt=null,me=null,nt=null,Ts=0,Kt=!1;function lo(){if(!ie){if(ie=document.getElementById(Es),zt=ie?.querySelector(ms),!ie||!zt)throw new Error("Elements de la p\xEDndola no trobats al DOM.");ie.setAttribute("role","status"),ie.setAttribute("aria-live","polite")}return{pillEl:ie,textEl:zt}}function Qt(e,t){try{let{pillEl:n,textEl:o}=lo();n.classList.add(K.VISIBLE),n.classList.remove(K.HAS_CHANGES,K.SAVING,K.HAS_SAVED,K.ERROR),t&&n.classList.add(t),o.textContent=e.replace(/[<>&]/g,"")}catch(n){console.warn("[saveIndicator] Error mostrant p\xEDndola:",n)}}function It(e="Guardando\u2026"){clearTimeout(nt),Qt(e,K.SAVING)}function _t(){clearTimeout(nt),Kt=!1,Ts=Date.now(),Qt("Guardado",K.HAS_SAVED),clearTimeout(me),me=setTimeout(Jt,co)}function ot(e="No se pudo guardar"){clearTimeout(nt),Qt(e,K.ERROR),clearTimeout(me),me=setTimeout(Jt,co*2)}function Jt(e=!1){try{if(lo(),clearTimeout(me),Kt&&!e)return;ie?.classList.remove(K.VISIBLE),me=null}catch(t){console.warn("[saveIndicator] Error amagant p\xEDndola:",t)}}function ye(){Kt=!1,clearTimeout(nt),Jt(!0)}window.addEventListener("pagehide",()=>{clearTimeout(me),clearTimeout(nt)});var uo={[We.LUNCH]:"comida",[We.DINNER]:"cena",DEFAULT:"dieta"},Te={TOP_BAR:C.TOP_BAR_TAPS,FOOTER:C.FOOTER_TAPS,TIMEOUT:C.TIMEOUT,ANIMATION_DURATION:C.ANIMATION_DURATION};function Re(e){if(!e)return;let t=document.body;if(!t)return;let n=t.dataset?.cspNonce||t.getAttribute("data-csp-nonce")||"";n&&!e.getAttribute("nonce")&&e.setAttribute("nonce",n)}function Eo(){let e=document.getElementById(m.DATE_INPUT);if(!e){console.warn("Utils: Input de data no trobat.");return}try{e.valueAsDate=new Date}catch(t){console.error("Error establint la data d'avui:",t)}}function mo(e){return typeof e!="string"||!e?"":e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function be(e){return e?e.split(" ").map(t=>t.includes(".")?t.toUpperCase():t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):""}function Zt(){let e=new Date().getHours();return e>=6&&e<18?We.LUNCH:We.DINNER}function To(){let e=document.getElementById(m.DIET_TYPE_SELECT);if(!e){console.warn("Utils: Select de tipus de dieta no trobat.");return}e.value=Zt()}function en(e,t){let n="Data inv\xE0lida";if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e))try{let i=e.split("-"),s=i[0].slice(-2);n=`${i[2]}/${i[1]}/${s}`}catch(i){console.error("Error formatant data:",i)}let o=uo[t]||uo.DEFAULT;return{ddmmaa:n,franjaText:o}}var L={topBarTaps:0,footerTaps:0,tapTimeoutId:null};function Ce(){L.topBarTaps=0,L.footerTaps=0,L.tapTimeoutId&&(clearTimeout(L.tapTimeoutId),L.tapTimeoutId=null)}function fs(){if(document.querySelector(m.EASTER_EGG_OVERLAY))return;let e=document.createElement("div");e.className=m.EASTER_EGG_OVERLAY.substring(1);let t=document.createElement("div");t.className=m.EASTER_EGG_ICON.substring(1),t.innerHTML='<img src="assets/icons/egg.svg" alt="Easter Egg">',e.appendChild(t),document.body.appendChild(e);let n=o=>{o.stopPropagation(),t.classList.add("clicked"),setTimeout(()=>e.remove(),Te.ANIMATION_DURATION)};e.addEventListener("click",n)}function fo(){let e=document.querySelector(m.TOP_BAR),t=document.querySelector(m.FOOTER);if(!e||!t){console.warn("Easter Egg: No s'han trobat top bar o footer.");return}e.addEventListener("touchend",n=>{n.changedTouches.length===1?(L.topBarTaps++,L.tapTimeoutId&&clearTimeout(L.tapTimeoutId),L.tapTimeoutId=setTimeout(Ce,Te.TIMEOUT),L.topBarTaps>Te.TOP_BAR&&Ce()):Ce()}),t.addEventListener("touchend",n=>{L.topBarTaps===Te.TOP_BAR&&n.changedTouches.length===1&&(L.footerTaps++,L.tapTimeoutId&&clearTimeout(L.tapTimeoutId),L.tapTimeoutId=setTimeout(Ce,Te.TIMEOUT),L.footerTaps===Te.FOOTER?(fs(),Ce()):L.footerTaps>Te.FOOTER&&Ce())})}function it(e,t){let n,o=function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)};return o.cancel=()=>clearTimeout(n),o}var tn=Promise.resolve(),po=!1;async function ps(e,t,n){if(!e||!Array.isArray(t)||!n)throw new Error("Datos incompletos para construir la dieta.");if(!/^\d{9}$/.test(n))throw new Error("ID de dieta inv\xE1lido. Debe contener 9 d\xEDgitos.");for(let r of t)if(!pt(r.originTime)||!pt(r.destinationTime)||!pt(r.endTime))throw new Error("Formato de hora inv\xE1lido detectado. Use HH:mm.");let o=await Oe(n),i=await oe(o),s=i?i.timeStampDiet:new Date().toISOString(),a={id:o,date:A(e.date),dietType:A(e.dietType),vehicleNumber:A(e.vehicleNumber),person1:A(e.person1),person2:A(e.person2),signatureConductor:e.signatureConductor,signatureAjudant:e.signatureAjudant,services:t.map(r=>({serviceNumber:A(r.serviceNumber),origin:A(r.origin),destination:A(r.destination),originTime:r.originTime,destinationTime:r.destinationTime,endTime:r.endTime,mode:A(r.mode),notes:A(r.notes)||""})),serviceType:A(e.serviceType),timeStampDiet:s};return new Diet(a)}function gs(){let e=document.getElementById(m.DADES_TAB),t=document.getElementById(m.SERVEIS_TAB);e?.classList.remove(C.ERROR_TAB),t?.classList.remove(C.ERROR_TAB);let n=Tt(),o=ft();if(n&&o)return!0;let i="";return!n&&!o?(i="Completa los campos obligatorios en Datos y Servicios.",e?.classList.add(C.ERROR_TAB),t?.classList.add(C.ERROR_TAB)):n?(i="Completa los campos obligatorios en la pesta\xF1a Servicios.",t?.classList.add(C.ERROR_TAB)):(i="Completa los campos obligatorios en la pesta\xF1a Datos.",e?.classList.add(C.ERROR_TAB)),d(i,"error"),!1}function Ss(e){if(!e)return;let t=i=>document.getElementById(i);t(m.DATE_INPUT).value=e.date||"",t(m.DIET_TYPE_SELECT).value=e.dietType||"",t(m.VEHICLE_INPUT).value=e.vehicleNumber||"",t(m.PERSON1_INPUT).value=e.person1||"",t(m.PERSON2_INPUT).value=e.person2||"";let n=t(m.SERVICE_TYPE_SELECT);n&&(n.value=e.serviceType||"TSU",Le(n.value)),Nt(e.signatureConductor||""),Dt(e.signatureAjudant||"");let o=document.querySelectorAll(Hn);e.services.forEach((i,s)=>{let a=o[s];a&&(Object.entries(Ft).forEach(([r,c])=>{let l=a.querySelector(c);l&&(l.value=i[r]||"")}),to(s,i.mode||"3.6"),Ze(a),W[s]=i.notes||"")});for(let i=e.services.length;i<o.length;i++){let s=o[i];s&&(Object.values(Ft).forEach(a=>{let r=s.querySelector(a);r&&(r.value="")}),Ze(s),W[i]="")}}async function go(e){return tn=tn.then(async()=>{let{generalData:t,servicesData:n}=Lt(),o=n[0]?.serviceNumber?.slice(0,9)||"";if(!o||!/^\d{9}$/.test(o)){e&&d("El primer servicio debe tener un N.\xBA de servicio v\xE1lido.","error");return}let i=await Oe(o),s=await oe(i);e&&It(!s?"Guardando nueva dieta\u2026":"Guardando\u2026"),nn(!1);try{if(await new Promise(l=>setTimeout(l,500)),!gs()){e&&ot("Validaci\xF3n fallida");return}let c=await ps(t,n,o);s?await so(c):(await Yt(c),fe(),ye()),e&&d("Dieta guardada correctament.","success"),st=new Date,sn(),fe(),_t(),e&&await At()}catch(c){console.error("Error en performSave:",c),ot(c.message||"No se pudo guardar"),e&&d(`Error al guardar: ${c.message}`,"error")}finally{nn(!0),po&&(po=!1,setTimeout(()=>vt(),100))}}),tn}async function So(){vo(),await go(!0)}async function vt(){await go(!1)}async function ho(e){if(!e||typeof e!="string")throw new Error("ID inv\xE0lid");let t=e.length===64?await oe(e):await oe(await Oe(e));if(!t)throw new Error(`Dieta no trobada: ${e}`);Ss(t),fe(),t.timeStampDiet&&(st=new Date(t.timeStampDiet),sn()),d("Dieta cargada correctamente.","success"),rn()}async function on(e,t,n){if(e)try{let o=await oe(e);if(!o){d("Error: Dieta no trobada","error");return}let s=(await ht()).sort((a,r)=>new Date(r.timeStampDiet)-new Date(a.timeStampDiet));o.index=s.findIndex(a=>a.id===e),await ro(e),d("Dieta eliminada","success",5e3,{priority:2,queueable:!1,undoCallback:async()=>{await Yt(o),_o(o),d("Dieta restaurada","success",3e3,{priority:0})},onExpire:()=>{Io(e)}}),fe(),ye()}catch(o){console.error("Error en deleteDietHandler:",o),d("Error al eliminar la dieta","error")}}var st=null;function sn(){let e=document.getElementById("last-saved");e&&(e.textContent=st?no(st):"")}setInterval(()=>{st&&sn()},6e4);var w={IS_INSTALLED:"pwa_isInstalled",PROMPT_DISMISSED_COUNT:"pwa_promptDismissedCount",NEVER_SHOW_AGAIN:"pwa_neverShowAgain",ACTION_TRIGGER_COUNT:"pwa_actionTriggerCount"},Do=2,Ao=10,pe=null,an=null,cn=null,ge=null,No=!1,ln=(e,t=0)=>parseInt(localStorage.getItem(e)||String(t),10),dn=e=>localStorage.getItem(e)==="true",Se=(e,t)=>localStorage.setItem(e,String(t));function Lo(){let e=window.matchMedia("(display-mode: standalone)").matches,t=window.navigator.standalone===!0;return e||t||dn(w.IS_INSTALLED)}function hs(e=!1){if(console.log("[PWA] Intentant mostrar el b\xE0ner d'instal\xB7laci\xF3..."),Lo()){console.log("[PWA] Bloquejat: L'app ja est\xE0 instal\xB7lada.");return}if(dn(w.NEVER_SHOW_AGAIN)){console.log("[PWA] Bloquejat: L'usuari ha demanat no tornar a mostrar.");return}if(!pe){console.log("[PWA] Bloquejat: No hi ha cap event d'instal\xB7laci\xF3 guardat.");return}if(!ge){console.log("[PWA] Bloquejat: L'element HTML del b\xE0ner no s'ha trobat.");return}console.log("%c[PWA] Mostrant el b\xE0ner!","color: green; font-weight: bold;"),ge.classList.add("visible"),ge.classList.remove("hidden")}function Oo(){console.log("[PWA] Amagant el b\xE0ner."),ge?.classList.remove("visible"),ge?.classList.add("hidden")}function Is(){console.log("[PWA] L'usuari ha descartat el b\xE0ner."),Oo();let e=ln(w.PROMPT_DISMISSED_COUNT);e++,Se(w.PROMPT_DISMISSED_COUNT,e),console.log(`[PWA] Comptador de descartats actualitzat a: ${e}`),e>=Do&&(Se(w.NEVER_SHOW_AGAIN,!0),console.log("%c[PWA] S'ha assolit el l\xEDmit de descartats. No es tornar\xE0 a mostrar.","color: orange;"))}async function _s(){if(console.log("[PWA] L'usuari ha fet clic a 'Instal\xB7lar'."),!pe){console.warn("[PWA] El bot\xF3 d'instal\xB7lar s'ha premut, per\xF2 no hi havia cap event guardat.");return}Oo();try{pe.prompt();let{outcome:e}=await pe.userChoice;console.log(`[PWA] Resultat de la decisi\xF3 de l'usuari: ${e}`),e==="accepted"?(Se(w.IS_INSTALLED,!0),Se(w.NEVER_SHOW_AGAIN,!0),console.log("%c[PWA] L'usuari ha acceptat la instal\xB7laci\xF3! :)","color: green; font-weight: bold;")):console.log("[PWA] L'usuari ha rebutjat la instal\xB7laci\xF3 des del di\xE0leg del navegador.")}catch(e){console.error("[PWA] Error durant el proc\xE9s de prompt d'instal\xB7laci\xF3:",e)}finally{pe=null}}function vs(e){e.preventDefault(),pe=e,console.log("%c[PWA] Event 'beforeinstallprompt' capturat i guardat.","color: blue;")}function yo(){No||(console.log("[PWA] Inicialitzant el gestor d'instal\xB7laci\xF3..."),ge=document.getElementById("install-prompt"),an=document.getElementById("install-button"),cn=document.getElementById("dismiss-button"),ge&&an&&cn?(an.addEventListener("click",_s),cn.addEventListener("click",Is),console.log("[PWA] Botons del b\xE0ner d'instal\xB7laci\xF3 configurats.")):console.warn("[PWA] No s'han trobat tots els elements del b\xE0ner d'instal\xB7laci\xF3."),window.addEventListener("beforeinstallprompt",vs),window.matchMedia("(display-mode: standalone)").addEventListener("change",e=>{e.matches&&(console.log("[PWA] Detectat canvi a mode 'standalone'. Marcat com instal\xB7lat."),Se(w.IS_INSTALLED,!0),Se(w.NEVER_SHOW_AGAIN,!0))}),No=!0,console.log("[PWA] Gestor d'instal\xB7laci\xF3 inicialitzat correctament."))}function Co(){if(console.log("------------------------------------------"),console.log("[PWA] Comprovant si s'ha de mostrar el b\xE0ner despr\xE9s d'una acci\xF3..."),Lo()){console.log("[PWA Check] No es mostra: L'app ja est\xE0 instal\xB7lada.");return}if(dn(w.NEVER_SHOW_AGAIN)){console.log("[PWA Check] No es mostra: L'usuari ha demanat no tornar a veure'l.");return}if(!pe){console.log("[PWA Check] No es mostra: El navegador no ha ofert la possibilitat d'instal\xB7lar (deferredPrompt \xE9s nul).");return}let e=ln(w.ACTION_TRIGGER_COUNT);e++,Se(w.ACTION_TRIGGER_COUNT,e),console.log(`[PWA] Comptador d'accions incrementat a: ${e}`);let t=ln(w.PROMPT_DISMISSED_COUNT);console.log(`[PWA] Vegades que s'ha descartat el b\xE0ner: ${t}`);let n=e===1&&t===0||e>=Ao&&t<Do;console.log(`[PWA] Es compleixen les condicions per mostrar? ${n}`),n?(setTimeout(()=>hs(),1500),e>=Ao):console.log("[PWA] No es mostra el b\xE0ner aquesta vegada."),console.log("------------------------------------------")}var Ro=!1;async function bo(){if(Ro)return;let e=document.createElement("script");return Re(e),e.src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js",new Promise((t,n)=>{e.onload=()=>{Ro=!0,t()},e.onerror=n,document.head.appendChild(e)})}var Be={OUTER_MARGIN:55,INNER_PADDING:10},Ot={DADES_TAB:"tab-dades",SERVEIS_TAB:"tab-serveis"},se={ERROR_TAB:"error-tab"},Q={TEMPLATE_URLS:{DEFAULT:"./dieta.pdf"},SERVICE_Y_OFFSET:82,SIGNATURE_WIDTH:100,SIGNATURE_HEIGHT:50,WATERMARK_TEXT:"misdietas.com",DEFAULT_FILENAME:"dieta.pdf",SERVICE_NUMBER_COLOR:"#004aad",MODE_PREFIX_TEXT_COLOR:"#8B0000",MAX_SIGNATURE_NAME_LENGTH:31},E={general:{date:{x:155,y:732,size:16,color:"#000000"},vehicleNumber:{x:441,y:732,size:16,color:"#000000"},person1:{x:65,y:368,size:16,color:"#000000"},person2:{x:310,y:368,size:16,color:"#000000"}},service:{serviceNumber:{x:130,y:715,size:16,color:"#000000"},origin:{x:232,y:698,size:16,color:"#000000"},originTime:{x:441,y:698,size:16,color:"#000000"},destination:{x:232,y:683,size:16,color:"#000000"},destinationTime:{x:441,y:681,size:16,color:"#000000"},endTimeNormal:{x:441,y:665,size:16,color:"#000000"},endTimeModeText:{x:390,y:665,size:16,color:Q.MODE_PREFIX_TEXT_COLOR},endTimeValueWhenPrefixed:{x:441,y:665,size:16,color:"#000000"}},signature:{conductor:{x:125,y:295,width:100,height:50},ayudante:{x:380,y:295,width:100,height:50}},notesSection:{title:{x:65,y:250,size:16,color:"#000000"},lineHeight:18,maxWidth:465,start:{x:65,y:230,size:16,color:"#333333"}},fixedText:{website:{x:250,y:20,size:6,color:"#EEEEEE"}}};function As(e){return!e||typeof e!="string"||e.trim()===""?"":e.split(/\s+/).filter(Boolean).map(t=>t.includes("-")?t.split("-").map(n=>n?n.charAt(0).toUpperCase()+n.slice(1).toLowerCase():"").join("-"):t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")}function Ns(e){if(!e||typeof e!="string")return{r:0,g:0,b:0};let t=e.replace("#","");if(t.length!==6)return{r:0,g:0,b:0};let n=parseInt(t,16);return isNaN(n)?{r:0,g:0,b:0}:{r:n>>16&255,g:n>>8&255,b:n&255}}function un(e){if(!e||!/^\d{4}-\d{2}-\d{2}$/.test(e))return"";let[t,n,o]=e.split("-");return`${o}/${n}/${t}`}function Ds(){return Q.TEMPLATE_URLS.DEFAULT}function Ls(e,t){let n=document.getElementById(Ot.DADES_TAB),o=document.getElementById(Ot.SERVEIS_TAB);n?.classList.remove(se.ERROR_TAB),o?.classList.remove(se.ERROR_TAB);let i="";!e&&!t?(i="Completa els camps obligatoris a Dades i Serveis.",n?.classList.add(se.ERROR_TAB),o?.classList.add(se.ERROR_TAB)):e?(i="Completa els camps obligatoris a Serveis.",o?.classList.add(se.ERROR_TAB)):(i="Completa els camps obligatoris a Dades.",n?.classList.add(se.ERROR_TAB)),i&&d(i,"error")}function Bo(e,t){let n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(n),500)}async function Po(e,t){if(!e||!Array.isArray(t))throw new Error("Dades inv\xE0lides.");if(!window.PDFLib)throw new Error("PDFLib no carregada.");let{PDFDocument:n,StandardFonts:o,rgb:i}=window.PDFLib,s=Ds(),a=await fetch(s).then(T=>T.arrayBuffer()),r=await n.load(a),c=await r.embedFont(o.Helvetica),l=r.getPages()[0],u=T=>{let{r:X,g:f,b:B}=Ns(T);return i(X/255,f/255,B/255)};Object.entries(E.general).forEach(([T,X])=>{let f=e[T]||"";T==="date"&&(f=un(f)),T==="vehicleNumber"&&(f=f.toUpperCase()),(T==="person1"||T==="person2")&&(f=As(f),f.length>Q.MAX_SIGNATURE_NAME_LENGTH&&(f=f.slice(0,Q.MAX_SIGNATURE_NAME_LENGTH-3)+"...")),l.drawText(f,{...X,font:c,color:u(X.color)})}),t.forEach((T,X)=>{let f=X*Q.SERVICE_Y_OFFSET,B=T.mode||"3.6";l.drawText(T.serviceNumber||"",{...E.service.serviceNumber,y:E.service.serviceNumber.y-f,font:c,color:u(Q.SERVICE_NUMBER_COLOR)}),l.drawText(T.origin||"",{...E.service.origin,y:E.service.origin.y-f,font:c,color:u(E.service.origin.color)}),l.drawText(T.originTime||"",{...E.service.originTime,y:E.service.originTime.y-f,font:c,color:u(E.service.originTime.color)}),B==="3.6"&&(l.drawText(T.destination||"",{...E.service.destination,y:E.service.destination.y-f,font:c,color:u(E.service.destination.color)}),l.drawText(T.destinationTime||"",{...E.service.destinationTime,y:E.service.destinationTime.y-f,font:c,color:u(E.service.destinationTime.color)}));let _e=(T.endTime||"").trim();B!=="3.6"&&_e?(l.drawText(B,{...E.service.endTimeModeText,y:E.service.endTimeModeText.y-f,font:c,color:u(E.service.endTimeModeText.color)}),l.drawText(_e,{...E.service.endTimeValueWhenPrefixed,y:E.service.endTimeValueWhenPrefixed.y-f,font:c,color:u(E.service.endTimeValueWhenPrefixed.color)})):l.drawText(_e,{...E.service.endTimeNormal,y:E.service.endTimeNormal.y-f,font:c,color:u(E.service.endTimeNormal.color)})});let p=async(T,X)=>{if(typeof T=="string"&&T.startsWith("data:image/png;base64,")&&T.length>22)try{let B=await r.embedPng(T);l.drawImage(B,{...X})}catch(B){console.warn(`No s'ha pogut incrustar una signatura. Error: ${B.message}`)}};await Promise.all([p(e.signatureConductor,E.signature.conductor),p(e.signatureAjudant,E.signature.ayudante)]);let v=l.getWidth(),P=Be.OUTER_MARGIN+Be.INNER_PADDING,Vi=v-(Be.OUTER_MARGIN+Be.INNER_PADDING),Ut=t.map(T=>({num:T.serviceNumber||"",text:(T.notes||"").trim()})).filter(T=>T.num&&T.text);if(Ut.length){l.drawLine({start:{x:Be.OUTER_MARGIN,y:275},end:{x:v-Be.OUTER_MARGIN,y:275},thickness:.5,color:i(.8,.8,.8)});let X=Ut.length===1?"Observaci\xF3":"Observacions";l.drawText(X,{...E.notesSection.title,font:c,color:u(E.notesSection.title.color)});let f=E.notesSection.start.y,B=E.notesSection.start.size,_e=E.notesSection.lineHeight,$i=u(E.notesSection.start.color);Ut.forEach(({num:Xi,text:qi})=>{if(f<40)return;let Vn=`Servei ${Xi}: `;l.drawText(Vn,{x:P,y:f,font:c,size:B,color:u(Q.SERVICE_NUMBER_COLOR)});let ji=c.widthOfTextAtSize(Vn,B),mt=P+ji;qi.split(" ").forEach(Vt=>{if(!Vt)return;let Fn=c.widthOfTextAtSize(Vt+" ",B);mt+Fn>Vi&&(f-=_e,mt=P),l.drawText(Vt+" ",{x:mt,y:f,font:c,size:B,color:$i}),mt+=Fn}),f-=_e*1.5})}let Un=Q.WATERMARK_TEXT,Gn=E.fixedText.website.size,Fi=c.widthOfTextAtSize(Un,Gn);l.drawText(Un,{x:(l.getWidth()-Fi)/2,y:E.fixedText.website.y,size:Gn,font:c,color:u(E.fixedText.website.color)});let ki=un(e.date)||"Dieta",Hi=`Dieta ${e.dietType==="lunch"?"Comida":e.dietType==="dinner"?"Cena":""} ${ki}`.trim().replace(/ +/g," ");r.setTitle(Hi),r.setAuthor("misdietas.com"),r.setSubject("Justificante de dieta de transporte sanitario"),r.setCreator("MisDietas"),r.setKeywords(["dieta","justificante","transporte sanitario","tsu","tsnu"]);let Gt=new Date(e.date);return isNaN(Gt.getTime())||(r.setCreationDate(Gt),r.setModificationDate(Gt)),await r.save({permissions:{modifying:!1,copying:!1}})}function wo(e,t){let n=un(e).replace(/\//g,"_")||"";return n?`${t==="lunch"?"dieta_comida":t==="dinner"?"dieta_cena":"dieta"}_${n}.pdf`:Q.DEFAULT_FILENAME}async function Mo(){let e=Tt(),t=ft();if(!e||!t){Ls(e,t);return}document.getElementById(Ot.DADES_TAB)?.classList.remove(se.ERROR_TAB),document.getElementById(Ot.SERVEIS_TAB)?.classList.remove(se.ERROR_TAB);try{let{generalData:n,servicesData:o}=Lt();if(!n||!o)throw new Error("Dades no recollides.");await bo();let i=await Po(n,o),s=wo(n.date,n.dietType);Bo(new Blob([i],{type:"application/pdf"}),s),typeof gtag=="function"&&gtag("event","download_pdf",{event_category:"PDF Generation",event_label:"Download from main form"}),d("Desc\xE0rrega iniciada correctament.","success"),Co()}catch(n){d(`Error en la generaci\xF3 del PDF: ${n.message||"Desconegut"}`,"error")}}async function xo(e){if(!e){d("ID de dieta inv\xE1lido.","error");return}try{let t=e.length===64?e:await Oe(e),n=await oe(t);if(!n)throw new Error("Dieta no encontrada.");let o={date:n.date||"",dietType:n.dietType||"",vehicleNumber:n.vehicleNumber||"",person1:n.person1||"",person2:n.person2||"",serviceType:n.serviceType||"TSU",signatureConductor:n.signatureConductor||"",signatureAjudant:n.signatureAjudant||""},i=n.services.map(r=>({serviceNumber:r.serviceNumber||"",origin:r.origin||"",originTime:r.originTime||"",destination:r.destination||"",destinationTime:r.destinationTime||"",endTime:r.endTime||"",mode:r.mode||"3.6",notes:r.notes||""}));await bo();let s=await Po(o,i),a=wo(o.date,o.dietType);Bo(new Blob([s],{type:"application/pdf"}),a),typeof gtag=="function"&&gtag("event","download_pdf",{event_category:"PDF Generation",event_label:"Download from saved list"}),d("Descarga iniciada correctamente.","success")}catch(t){console.error("Error en downloadDietPDF:",t),d(`Error en la generaci\xF3n del PDF: ${t.message||"Desconocido"}`,"error")}}var Uo="dotacions_v2",N={MODAL:"dotacio-modal",OPTIONS_CONTAINER:"dotacio-options",TEMPLATE:"dotacio-template",NO_DOTACIO_TEXT:"no-dotacio-text",ADD_BTN:"add-dotacio",OPEN_MODAL_BTN:"open-dotacio-modal",CLOSE_MODAL_BTN:"close-dotacio-modal",VEHICLE_INPUT:"vehicle-number",PERSON1_INPUT:"person1",PERSON2_INPUT:"person2"},F={MODAL_OPEN:"modal-open",INPUT_ERROR:"input-error",HIDDEN:"hidden"},Pe={PERSON_INPUT_GROUP:".input-with-icon",DOTACIO_INFO:".dotacio-info",LOAD_BTN:".dotacio-load",DELETE_BTN:".dotacio-delete"},Go={INDEX:"data-index"},Os=180,En=class{constructor(){this.savedDotacions=[],this.dotacioModalElement=null,this.optionsContainerElement=null,this.dotacioTemplateElement=null,this.noDotacioTextElement=null,this.isInitialized=!1}init(){if(this.isInitialized)return;this.dotacioModalElement=document.getElementById(N.MODAL),this.optionsContainerElement=document.getElementById(N.OPTIONS_CONTAINER),this.dotacioTemplateElement=document.getElementById(N.TEMPLATE),this.noDotacioTextElement=document.getElementById(N.NO_DOTACIO_TEXT);let t=document.getElementById(N.ADD_BTN),n=document.getElementById(N.OPEN_MODAL_BTN),o=document.getElementById(N.CLOSE_MODAL_BTN);if(!this.dotacioModalElement||!this.optionsContainerElement||!this.dotacioTemplateElement||!t||!n||!o)return;this.loadDotacionsFromStorage(),t.addEventListener("click",this.addDotacioFromMainForm.bind(this)),n.addEventListener("click",this.openDotacioModal.bind(this)),o.addEventListener("click",this.closeDotacioModal.bind(this)),this.dotacioModalElement.addEventListener("click",s=>{s.target===this.dotacioModalElement&&this.closeDotacioModal()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.dotacioModalElement.style.display==="block"&&this.closeDotacioModal()}),this.optionsContainerElement.addEventListener("click",this.handleOptionsClick.bind(this)),[N.VEHICLE_INPUT,N.PERSON1_INPUT,N.PERSON2_INPUT].forEach(s=>{let a=document.getElementById(s);a?.addEventListener("input",()=>{let r=a.closest(Pe.PERSON_INPUT_GROUP);r?r.classList.remove(F.INPUT_ERROR):a.classList.remove(F.INPUT_ERROR)})}),this.isInitialized=!0}loadDotacionsFromStorage(){try{let t=localStorage.getItem(Uo);this.savedDotacions=t?JSON.parse(t):[],Array.isArray(this.savedDotacions)||(this.savedDotacions=[])}catch{this.savedDotacions=[]}}saveDotacionsToStorage(){try{localStorage.setItem(Uo,JSON.stringify(this.savedDotacions))}catch{d("No se han podido guardar las dotaciones.","error")}}openDotacioModal(){this.dotacioModalElement&&(this.dotacioModalElement.style.display="block",document.body.classList.add(F.MODAL_OPEN),this.displayDotacioOptions())}closeDotacioModal(){this.dotacioModalElement&&(this.dotacioModalElement.style.display="none",document.body.classList.remove(F.MODAL_OPEN),document.getElementById(N.OPEN_MODAL_BTN)?.focus())}displayDotacioOptions(){!this.optionsContainerElement||!this.dotacioTemplateElement||(this.optionsContainerElement.innerHTML="",this.savedDotacions.length===0?(this.noDotacioTextElement?.classList.remove(F.HIDDEN),this.optionsContainerElement.classList.add(F.HIDDEN)):(this.noDotacioTextElement?.classList.add(F.HIDDEN),this.optionsContainerElement.classList.remove(F.HIDDEN),this.savedDotacions.forEach((t,n)=>{let o=this.dotacioTemplateElement.content.cloneNode(!0),i=o.querySelector(Pe.DOTACIO_INFO),s=o.querySelector(Pe.LOAD_BTN),a=o.firstElementChild,r=`${t.numero}-${t.conductor}-${t.ajudant}`.replace(/\s/g,"");a.setAttribute("data-dotacio-id",r),i&&(i.textContent=this.formatDotacioListText(t)),s&&s.setAttribute(Go.INDEX,n),this.optionsContainerElement.appendChild(o),Tn(a,r),mn(a,r)})))}formatDotacioListText(t){let n=t.numero||"S/N",o=be(t.conductor||""),i=be(t.ajudant||""),s=`${o} / ${i}`;o||i?s=` - ${s}`:s="";let a=`${n}${s}`;if(this.measureTextWidth(a)>Os){let c=t.conductor?this.shortenPersonName(t.conductor):"",l=t.ajudant?this.shortenPersonName(t.ajudant):"",u=`${c} / ${l}`;c||l?u=` - ${u}`:u="",a=`${n}${u}`}return a}shortenPersonName(t){if(!t||typeof t!="string")return"";let n=t.trim().split(/\s+/).filter(r=>r.length>0);if(n.length===0)return"";if(n.length===1)return be(n[0]);let o=new Set(["de","la","del","el","los","las","von","van","d'","es","da","dels","i","y"]),i=n.filter(r=>!o.has(r.toLowerCase()));if(i.length===0)return be(n[0]);let s=be(i[0]),a=i.slice(1).map(r=>r.charAt(0).toUpperCase()+".").join(" ");return`${s} ${a}`}measureTextWidth(t){let n=document.createElement("span");n.style.visibility="hidden",n.style.whiteSpace="nowrap",n.style.fontSize=getComputedStyle(document.body).fontSize,n.style.fontFamily=getComputedStyle(document.body).fontFamily,n.textContent=t,document.body.appendChild(n);let o=n.offsetWidth;return document.body.removeChild(n),o}loadDotacionByIndex(t){if(t<0||t>=this.savedDotacions.length)return;let n=this.savedDotacions[t];this.clearDotacionInputErrors(),document.getElementById(N.VEHICLE_INPUT).value=n.numero||"",document.getElementById(N.PERSON1_INPUT).value=n.conductor||"",document.getElementById(N.PERSON2_INPUT).value=n.ajudant||"",Nt(n.firmaConductor||""),Dt(n.firmaAjudant||""),d(`Dotaci\xF3n ${n.numero} cargada.`,"success"),this.closeDotacioModal()}async handleDeleteById(t){let n=this.savedDotacions.findIndex(s=>`${s.numero}-${s.conductor}-${s.ajudant}`.replace(/\s/g,"")===t);if(n===-1){console.warn("Se intent\xF3 eliminar una dotaci\xF3n que ya no existe:",t);return}let i={...this.savedDotacions[n],originalIndex:n};this.savedDotacions.splice(n,1),this.saveDotacionsToStorage(),rt(),d("Dotaci\xF3n eliminada.","success",5e3,{queueable:!1,undoCallback:()=>{this.savedDotacions.splice(i.originalIndex,0,i),this.saveDotacionsToStorage(),Vo(i),d("Dotaci\xF3n restaurada.","success")}})}handleOptionsClick(t){let o=t.target.closest(Pe.LOAD_BTN);if(o){t.stopPropagation();let i=parseInt(o.getAttribute(Go.INDEX),10);isNaN(i)||this.loadDotacionByIndex(i)}}getDotacionInputValues(){let t=document.getElementById(N.VEHICLE_INPUT),n=document.getElementById(N.PERSON1_INPUT),o=document.getElementById(N.PERSON2_INPUT);return{vehiculo:t?.value.trim()||"",conductor:n?.value.trim()||"",ayudante:o?.value.trim()||""}}findExistingDotacionIndex(t,n,o){let i=t.toLowerCase(),s=n.toLowerCase(),a=o.toLowerCase();return this.savedDotacions.findIndex(r=>r.numero.toLowerCase()===i&&r.conductor.toLowerCase()===s&&r.ajudant.toLowerCase()===a)}addDotacioFromMainForm(){if(!Yn())return;let{vehiculo:t,conductor:n,ayudante:o}=this.getDotacionInputValues(),i=yt(),s=Ct(),a=this.findExistingDotacionIndex(t,n,o),r={numero:t,conductor:n,ajudant:o,firmaConductor:i,firmaAjudant:s};a!==-1?(this.savedDotacions[a]=r,d(`Dotaci\xF3n ${t} actualizada.`,"success")):(this.savedDotacions.push(r),d(`Dotaci\xF3n ${t} creada.`,"success")),this.saveDotacionsToStorage()}clearDotacionInputErrors(){let t=document.getElementById(N.VEHICLE_INPUT),n=document.getElementById(N.PERSON1_INPUT),o=document.getElementById(N.PERSON2_INPUT),i=n?.closest(Pe.PERSON_INPUT_GROUP),s=o?.closest(Pe.PERSON_INPUT_GROUP);t?.classList.remove(F.INPUT_ERROR),i?.classList.remove(F.INPUT_ERROR),s?.classList.remove(F.INPUT_ERROR)}},we=new En;var g={MODAL_VISIBLE:"visible",MODAL_OPEN_BODY:"modal-open",HIDDEN:"hidden",DIET_ITEM:"diet-item",DIET_DATE:"diet-date",DIET_ICONS:"diet-icons",DIET_DELETE_BTN:"diet-delete",DIET_LOAD_BTN:"diet-load",LIST_ITEM_BTN:"list-item-btn",LIST_ITEM_BTN_LOAD:"list-item-btn--load",LIST_ITEM_BTN_DELETE:"list-item-btn--delete",DIET_ITEM_SWIPING:"swiping",DIET_DELETE_REVEAL:"delete-reveal"},M={DIET_MODAL:"diet-modal",DIET_OPTIONS_LIST:"diet-options",NO_DIETS_TEXT:"no-diets-text",CONFIRM_MODAL:"confirm-modal",CONFIRM_MESSAGE:"confirm-message",CONFIRM_TITLE:".modal-title",CONFIRM_YES_BTN:"confirm-yes",CONFIRM_NO_BTN:"confirm-no",ABOUT_MODAL:"about-modal",SIGNATURE_MODAL:"signature-modal",DOTACIO_MODAL:"dotacio-modal",CAMERA_GALLERY_MODAL:"camera-gallery-modal"},Rt={MODAL:".modal",MODAL_CLOSE_BTN:".close-modal, .close-modal-btn",MODAL_TRIGGER:'a[href^="#"]',FOCUSABLE_ELEMENTS:'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'},re={DIET_ID:"data-diet-id",DIET_DATE:"data-diet-date",DIET_TYPE:"data-diet-type"},xe=null,S=null,U=null,fn=null,ys=null,Cs=null,Rs=null,bs=null;var Me=null,Ue=null,Ge=null,y=null;function Fo(e){if(!e||y&&y.id!==e.id&&e.id!==M.CONFIRM_MODAL)return;y||(Me=document.activeElement),y=e,e.style.display="block",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100vh",e.style.background="rgba(0,0,0,0.5)",document.body.classList.add(g.MODAL_OPEN_BODY),Xo(),Ve(!1),document.body.style.setProperty("pointer-events","none"),e.style.setProperty("pointer-events","auto"),e.addEventListener("touchstart",n=>{n.target===e&&(n.preventDefault(),n.stopPropagation())},{passive:!1}),Ue||(Ue=n=>{n.target===y&&(y.id===M.CONFIRM_MODAL?_handleConfirmNo():bt())},document.addEventListener("click",Ue,!0)),Ge||(Ge=n=>{n.key==="Escape"&&y&&(y.id===M.CONFIRM_MODAL?_handleConfirmNo():bt())},document.addEventListener("keydown",Ge,!0)),e.querySelector(Rt.FOCUSABLE_ELEMENTS)?.focus()}function bt(){if(!y)return;Ue&&(document.removeEventListener("click",Ue,!0),Ue=null),Ge&&(document.removeEventListener("keydown",Ge,!0),Ge=null),y.style.display="none";let e=y.id===M.CONFIRM_MODAL;y=null;let t=document.querySelector('.modal[style*="display: block"]');t||(document.body.classList.remove(g.MODAL_OPEN_BODY),Ve(!0),qo(),document.body.style.removeProperty("pointer-events")),!e&&Me?(Me.focus(),Me=null):t||(Me?.focus(),Me=null)}function Bs(e){if(!e)return"";let t=new Date(e);if(isNaN(t.getTime()))return"";let n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}:${o}`}function ko(e){let t=e.services&&e.services.length>0?e.services[0].serviceNumber:"?????????",{ddmmaa:n,franjaText:o}=en(e.date,e.dietType),i=Bs(e.timeStampDiet),s=document.createElement("div");s.className=g.DIET_ITEM;let a=document.createElement("div");a.className="diet-item-content";let r=document.createElement("span");r.className=g.DIET_DATE;let c=n;i&&(c+=` [${i}]`),c+=` - ${mo(o)}`,r.textContent=c;let l=document.createElement("div");l.className=g.DIET_ICONS;let u=document.createElement("div");u.className="delete-reveal",u.innerHTML='<img src="assets/icons/delete.svg" alt="Eliminar" class="icon">';let p=document.createElement("button");p.className=`${g.LIST_ITEM_BTN} ${g.LIST_ITEM_BTN_LOAD} ${g.DIET_LOAD_BTN}`,p.setAttribute("aria-label",`Editar dieta ${n}`),p.innerHTML='<img src="assets/icons/ic_edit.svg" alt="" class="icon"><span class="btn-text visually-hidden">Editar</span>',p.setAttribute(re.DIET_ID,t),p.setAttribute(re.DIET_DATE,e.date),p.setAttribute(re.DIET_TYPE,e.dietType);let v=document.createElement("button");return v.className=`${g.LIST_ITEM_BTN} diet-download`,v.setAttribute("aria-label",`Descarregar PDF de la dieta ${n}`),v.innerHTML='<img src="assets/icons/download_blue.svg" alt="" class="icon"><span class="btn-text visually-hidden">PDF</span>',v.setAttribute(re.DIET_ID,t),l.appendChild(p),l.appendChild(v),a.appendChild(r),a.appendChild(l),s.appendChild(a),s.appendChild(u),s}async function Ps(e){let t=e.target,n=t.closest(`.${g.DIET_LOAD_BTN}`),o=t.closest(".diet-download");if(n){e.stopPropagation();let i=n.getAttribute(re.DIET_ID),s=n.getAttribute(re.DIET_DATE),a=n.getAttribute(re.DIET_TYPE);if(!i||!s||!a)return;let{ddmmaa:r,franjaText:c}=en(s,a);try{await ho(i)}catch(l){console.error("Error en carregar la dieta:",l)}}else if(o){e.stopPropagation();let i=o.getAttribute(re.DIET_ID);i&&xo(i)}}function Io(e){if(!S)return;let t=S.querySelector(`[data-diet-id="${e}"]`)?.closest(".diet-item");if(!t)return;let n=S.scrollHeight+"px";S.style.height=n,t.remove(),requestAnimationFrame(()=>{S.style.height=S.scrollHeight+"px"}),Bt()}function Ho(){fn=document.getElementById(M.CONFIRM_MODAL),fn&&(ys=document.getElementById(M.CONFIRM_MESSAGE),Cs=fn.querySelector(M.CONFIRM_TITLE),Rs=document.getElementById(M.CONFIRM_YES_BTN),bs=document.getElementById(M.CONFIRM_NO_BTN)),document.querySelectorAll(Rt.MODAL_TRIGGER).forEach(t=>{let n=t.getAttribute("href")?.substring(1);if(!n)return;let o=document.getElementById(n);o&&o.matches(Rt.MODAL)&&(t.addEventListener("click",s=>{s.preventDefault(),Fo(o)}),o.querySelectorAll(Rt.MODAL_CLOSE_BTN).forEach(s=>{s.addEventListener("click",()=>bt())}))})}function pn(){if(!xe){xe=document.getElementById(M.DIET_MODAL),S=document.getElementById(M.DIET_OPTIONS_LIST),U=document.getElementById(M.NO_DIETS_TEXT);let e=document.getElementById("close-diet-modal");e&&e.addEventListener("click",rn),S&&S.addEventListener("click",Ps)}xe&&(Fo(xe),At())}function rn(){y&&y.id===M.DIET_MODAL&&bt()}async function At(){if(!(!S||!U)){S.innerHTML="";try{let e=await ht();e.length===0?(S.classList.add(g.HIDDEN),U.classList.remove(g.HIDDEN),U.textContent="No hay dietas guardadas."):(S.classList.remove(g.HIDDEN),U.classList.add(g.HIDDEN),e.sort((t,n)=>new Date(n.timeStampDiet)-new Date(t.timeStampDiet)),e.forEach((t,n)=>{let o=ko(t);o.setAttribute("data-index",n),S.appendChild(o),$o(o,t.id,t.date,t.dietType)}))}catch{S.classList.add(g.HIDDEN),U.classList.remove(g.HIDDEN),U.textContent="Error al cargar las dietas."}}}function Bt(){console.log("Actualitzant visibilitat: children.length =",S.children.length),S.children.length===0?(S.classList.add(g.HIDDEN),U.classList.remove(g.HIDDEN),U.textContent="No hay dietas guardadas."):(S.classList.remove(g.HIDDEN),U.classList.add(g.HIDDEN))}function ws(e,t,n,o){let i=0,s=0,a=!1;e.addEventListener("mousedown",r=>{r.target.closest("button")||r.target.closest(".diet-icons")||(i=r.clientX,s=i,a=!1)}),document.addEventListener("mousemove",r=>{s=r.clientX;let c=i-s;c>10&&!a&&(a=!0,e.classList.add(g.DIET_ITEM_SWIPING)),a&&c>10&&(e.style.transform=`translateX(-${Math.min(c,80)}px)`,r.preventDefault())}),document.addEventListener("mouseup",async r=>{if(!a)return;a=!1;let c=i-s;e.classList.remove(g.DIET_ITEM_SWIPING),e.style.transition="transform 0.3s ease, opacity 0.3s ease",c>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{e.remove(),Bt(),await on(t,n,o)},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300)})}function $o(e,t,n,o){let i=0,s=0,a=!1;e.addEventListener("touchstart",r=>{r.target.closest("button")||r.target.closest(".diet-icons")||(i=r.touches[0].clientX,s=i,a=!1,r.stopPropagation())},{passive:!1}),e.addEventListener("touchmove",r=>{s=r.touches[0].clientX;let c=i-s;c>10&&!a&&(a=!0,e.classList.add(g.DIET_ITEM_SWIPING),xe.style.overflow="hidden"),a&&c>10&&(e.style.transform=`translateX(-${Math.min(c,80)}px)`,r.preventDefault(),r.stopPropagation())},{passive:!1}),e.addEventListener("touchend",async r=>{if(!a)return;a=!1;let c=i-s;e.classList.remove(g.DIET_ITEM_SWIPING),e.style.transition="transform 0.3s ease, opacity 0.3s ease",c>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{e.remove(),Bt(),await on(t,n,o)},300)):(e.style.transform="translateX(0)",e.style.opacity="1",xe.style.overflow=""),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300),r.stopPropagation()}),ws(e,t,n,o)}function mn(e,t){let n=0,o=0,i=!1;e.addEventListener("mousedown",s=>{s.target.closest("button")||s.target.closest(".button-container")||(n=s.clientX,o=n,i=!1)}),document.addEventListener("mousemove",s=>{o=s.clientX;let a=n-o;a>10&&!i&&(i=!0,e.classList.add("swiping")),i&&a>10&&(e.style.transform=`translateX(-${Math.min(a,80)}px)`,s.preventDefault())}),document.addEventListener("mouseup",async s=>{if(!i)return;i=!1;let a=n-o;e.classList.remove("swiping"),e.style.transition="transform 0.3s ease, opacity 0.3s ease",a>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{await we.handleDeleteById(t),e.remove(),rt()},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300)})}function Tn(e,t){let n=0,o=0,i=!1;e.addEventListener("touchstart",s=>{s.target.closest("button")||(n=s.touches[0].clientX,o=n,i=!1,s.stopPropagation())},{passive:!1}),e.addEventListener("touchmove",s=>{o=s.touches[0].clientX;let a=n-o;a>10&&!i&&(i=!0,e.classList.add("swiping")),i&&a>10&&(e.style.transform=`translateX(-${Math.min(a,80)}px)`,s.preventDefault(),s.stopPropagation())},{passive:!1}),e.addEventListener("touchend",async s=>{if(!i)return;i=!1;let a=n-o;e.classList.remove("swiping"),e.style.transition="transform 0.3s ease, opacity 0.3s ease",a>50?(e.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(async()=>{await we.handleDeleteById(t),e.remove(),rt()},300)):(e.style.transform="translateX(0)",e.style.opacity="1"),setTimeout(()=>{e.style.transition="",e.style.opacity=""},300),s.stopPropagation()})}function _o(e){if(!S||!U){At();return}let t=e.index||0,n=ko(e);n.style.opacity="0",n.style.transform="translateX(-100%)";let o=S.children[t];o?S.insertBefore(n,o):S.appendChild(n),requestAnimationFrame(()=>{n.style.transition="opacity 0.5s ease, transform 0.5s ease",n.style.opacity="1",n.style.transform="translateX(0)",$o(n,e.id,e.date,e.dietType)}),Bt(),S.classList.remove(g.HIDDEN),U.classList.add(g.HIDDEN)}function rt(){let e=document.getElementById("dotacio-options"),t=document.getElementById("no-dotacio-text");e.children.length===0?(e.classList.add("hidden"),t.classList.remove("hidden"),t.innerHTML='No hay dotaciones, guarde antes: <img src="assets/icons/save_green.svg" alt="Guardar" class="save-icon" />'):(e.classList.remove("hidden"),t.classList.add("hidden"))}function Ms(e,t){let n=document.getElementById("dotacio-template");if(!n)return null;let o=n.content.cloneNode(!0),i=o.firstElementChild,s=`${e.numero}-${e.conductor}-${e.ajudant}`.replace(/\s/g,"");i.setAttribute("data-dotacio-id",s);let a=o.querySelector(".dotacio-info"),r=o.querySelector(".dotacio-load");if(a){let c=[e.conductor,e.ajudant].filter(Boolean).join(" / ");a.textContent=c?`${e.numero} - ${c}`:e.numero}return r&&r.setAttribute("data-index",String(t)),i}function Vo(e){let t=document.getElementById("dotacio-options");if(!t){we.displayDotacioOptions();return}let n=e.originalIndex,o=Ms(e,n);if(!o)return;o.style.opacity="0",o.style.transform="translateX(-100%)";let i=t.children[n];i?t.insertBefore(o,i):t.appendChild(o),requestAnimationFrame(()=>{o.style.transition="opacity 0.5s ease, transform 0.5s ease",o.style.opacity="1",o.style.transform="translateX(0)";let s=`${e.numero}-${e.conductor}-${e.ajudant}`.replace(/\s/g,"");Tn(o,s),mn(o,s)}),rt()}var R={DADES:"dades",SERVEIS:"serveis"},J={TAB_DADES:`tab-${R.DADES}`,TAB_SERVEIS:`tab-${R.SERVEIS}`,CONTENT_DADES:`${R.DADES}-tab-content`,CONTENT_SERVEIS:`${R.SERVEIS}-tab-content`,MAIN_CONTENT_AREA:"main-content"},Fe={ACTIVE_TAB:"active",ERROR_TAB:"error-tab"},jo={MIN_DISTANCE:60,MAX_VERTICAL_RATIO:.5},ke=R.DADES,Pt=0,gn=0,Sn=!0,ae=null,he=null;function Wo(){let e=document.getElementById(J.TAB_DADES),t=document.getElementById(J.TAB_SERVEIS);!e||!t||(e.addEventListener("click",()=>at(R.DADES)),t.addEventListener("click",()=>at(R.SERVEIS)),xs(),at(ke))}function Ve(e){Sn=!!e}function at(e){if(ke===e&&document.scrollingElement.scrollTop!==0){window.scrollTo({top:0,behavior:"smooth"});return}if(ke===e||e!==R.DADES&&e!==R.SERVEIS)return;window.scrollTo({top:0,behavior:"auto"}),ke=e;let t=document.getElementById(J.TAB_DADES),n=document.getElementById(J.TAB_SERVEIS),o=document.getElementById(J.CONTENT_DADES),i=document.getElementById(J.CONTENT_SERVEIS);if(!t||!n||!o||!i)return;t.classList.remove(Fe.ERROR_TAB),n.classList.remove(Fe.ERROR_TAB);let s=e===R.DADES;t.classList.toggle(Fe.ACTIVE_TAB,s),n.classList.toggle(Fe.ACTIVE_TAB,!s),o.classList.toggle(Fe.ACTIVE_TAB,s),i.classList.toggle(Fe.ACTIVE_TAB,!s),t.setAttribute("aria-selected",s?"true":"false"),n.setAttribute("aria-selected",s?"false":"true"),e===R.SERVEIS&&typeof qt=="function"&&qt()}function xs(){let e=document.getElementById(J.MAIN_CONTENT_AREA);e&&(ae=Yo,he=zo,e.addEventListener("touchstart",ae,{passive:!0}),e.addEventListener("touchend",he,{passive:!0}))}function Xo(){let e=document.getElementById(J.MAIN_CONTENT_AREA);!e||!ae||!he||(e.removeEventListener("touchstart",ae,{passive:!0}),e.removeEventListener("touchend",he,{passive:!0}),ae=null,he=null)}function qo(){let e=document.getElementById(J.MAIN_CONTENT_AREA);e&&(ae||(ae=Yo,he=zo,e.addEventListener("touchstart",ae,{passive:!0}),e.addEventListener("touchend",he,{passive:!0})))}function Yo(e){if(!Sn||y)return;let t=e.touches[0];Pt=t.clientX,gn=t.clientY}function zo(e){if(!Sn||Pt===0||!e.changedTouches||e.changedTouches.length===0)return;let t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY,o=t-Pt,i=n-gn;Pt=0,gn=0,!(Math.abs(i)>Math.abs(o)*jo.MAX_VERTICAL_RATIO)&&Math.abs(o)>jo.MIN_DISTANCE&&(o>0?ke===R.SERVEIS&&at(R.DADES):ke===R.DADES&&at(R.SERVEIS))}var ce={MODAL:"signature-modal",CANVAS:"signature-canvas",CANCEL_BTN:"signature-cancel",ACCEPT_BTN:"signature-accept",SIGN_PERSON1_BTN:"sign-person1",SIGN_PERSON2_BTN:"sign-person2",TITLE:"signature-title"},hn={MODAL_OPEN:"modal-open",SIGNED:"signed"},le={LINE_WIDTH:2,LINE_CAP:"round",STROKE_STYLE:"#000000",IMAGE_FORMAT:"image/png",DOUBLE_CLICK_TIMEOUT:300,DOUBLE_TAP_TIMEOUT:300,DOUBLE_TAP_MAX_DIST:20},Ko={SIGNATURE_PENDING:"assets/icons/signature.svg",SIGNATURE_OK:"assets/icons/signature_ok.svg"},Qo={PERSON1:"Firma del conductor",PERSON2:"Firma del ayudante"},In=class{constructor(){this.signatureConductor="",this.signatureAjudant="",this.currentSignatureTarget=null,this.isDrawing=!1,this.canvasContext=null,this.signatureCanvasElement=null,this.signatureModalElement=null,this.signPerson1Button=null,this.signPerson2Button=null,this.hasUserDrawn=!1,this.lastTouchTime=0,this.lastTouchX=0,this.lastTouchY=0,this.clickCount=0,this.clickTimer=null}init(){this.signatureModalElement=document.getElementById(ce.MODAL),this.signatureCanvasElement=document.getElementById(ce.CANVAS);let t=document.getElementById(ce.CANCEL_BTN),n=document.getElementById(ce.ACCEPT_BTN);this.signPerson1Button=document.getElementById(ce.SIGN_PERSON1_BTN),this.signPerson2Button=document.getElementById(ce.SIGN_PERSON2_BTN),!(!this.signatureModalElement||!this.signatureCanvasElement||!t||!n||!this.signPerson1Button||!this.signPerson2Button)&&(this.resizeCanvas(),this.initCanvasEvents(),t.addEventListener("click",this.closeSignatureModal.bind(this)),n.addEventListener("click",this.acceptSignature.bind(this)),this.signPerson1Button.addEventListener("click",()=>this.openSignatureModal("person1")),this.signPerson2Button.addEventListener("click",()=>this.openSignatureModal("person2")),this.signatureModalElement.addEventListener("click",o=>{o.target===this.signatureModalElement&&this.closeSignatureModal()}),window.addEventListener("resize",this.debounce(this.resizeCanvas.bind(this),150)),document.addEventListener("keydown",o=>{o.key==="Escape"&&this.signatureModalElement.style.display==="block"&&this.closeSignatureModal()}),this.updateSignatureIcons())}debounce(t,n){let o;return(...i)=>{clearTimeout(o),o=setTimeout(()=>t.apply(this,i),n)}}resizeCanvas(){if(!this.signatureCanvasElement||!this.signatureCanvasElement.parentElement)return;let t=this.signatureCanvasElement.parentElement;this.canvasContext||(this.canvasContext=this.signatureCanvasElement.getContext("2d",{willReadFrequently:!0})),this.canvasContext&&(this.signatureCanvasElement.width=t.offsetWidth,this.signatureCanvasElement.height=t.offsetHeight,this.canvasContext.lineWidth=le.LINE_WIDTH,this.canvasContext.lineCap=le.LINE_CAP,this.canvasContext.strokeStyle=le.STROKE_STYLE)}clearCanvas(){!this.canvasContext||!this.signatureCanvasElement||(this.canvasContext.clearRect(0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height),this.hasUserDrawn=!1)}getEventCoordinates(t){if(!this.signatureCanvasElement)return{x:0,y:0};let n=this.signatureCanvasElement.getBoundingClientRect(),o,i;return t.touches&&t.touches.length>0?(o=t.touches[0].clientX,i=t.touches[0].clientY):(o=t.clientX,i=t.clientY),{x:o-n.left,y:i-n.top}}startDrawing(t){if(!this.canvasContext)return;this.isDrawing=!0,this.hasUserDrawn=!0,this.canvasContext.beginPath();let{x:n,y:o}=this.getEventCoordinates(t);this.canvasContext.moveTo(n,o)}draw(t){if(!this.isDrawing||!this.canvasContext)return;t.preventDefault();let{x:n,y:o}=this.getEventCoordinates(t);this.canvasContext.lineTo(n,o),this.canvasContext.stroke()}stopDrawing(){!this.isDrawing||!this.canvasContext||(this.isDrawing=!1)}handleCanvasClick(t){this.clickCount++,this.clickCount===1?this.clickTimer=setTimeout(()=>this.clickCount=0,le.DOUBLE_CLICK_TIMEOUT):this.clickCount===2&&(clearTimeout(this.clickTimer),this.clickCount=0,t.preventDefault(),this.clearCanvas())}handleCanvasTouchEnd(t){if(t.touches.length>0)return;let n=Date.now(),o=t.changedTouches[0];if(!o)return;let{x:i,y:s}=this.getEventCoordinates({clientX:o.clientX,clientY:o.clientY}),a=n-this.lastTouchTime,r=Math.abs(i-this.lastTouchX),c=Math.abs(s-this.lastTouchY);a<le.DOUBLE_TAP_TIMEOUT&&r<le.DOUBLE_TAP_MAX_DIST&&c<le.DOUBLE_TAP_MAX_DIST?(t.preventDefault(),this.clearCanvas(),this.lastTouchTime=0):(this.lastTouchTime=n,this.lastTouchX=i,this.lastTouchY=s)}initCanvasEvents(){this.signatureCanvasElement&&(this.signatureCanvasElement.addEventListener("mousedown",this.startDrawing.bind(this)),this.signatureCanvasElement.addEventListener("mousemove",this.draw.bind(this)),this.signatureCanvasElement.addEventListener("mouseup",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("mouseout",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("click",this.handleCanvasClick.bind(this)),this.signatureCanvasElement.addEventListener("touchstart",this.startDrawing.bind(this),{passive:!1}),this.signatureCanvasElement.addEventListener("touchmove",this.draw.bind(this),{passive:!1}),this.signatureCanvasElement.addEventListener("touchend",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("touchcancel",this.stopDrawing.bind(this)),this.signatureCanvasElement.addEventListener("touchend",this.handleCanvasTouchEnd.bind(this),{passive:!1}))}openSignatureModal(t){if(!this.signatureModalElement||!this.canvasContext)return;Ve(!1),this.currentSignatureTarget=t;let n=document.getElementById(ce.TITLE);n&&(n.textContent=t==="person1"?Qo.PERSON1:Qo.PERSON2),this.signatureModalElement.style.display="block",document.body.classList.add(hn.MODAL_OPEN),this.resizeCanvas(),this.clearCanvas();let o=t==="person1"?this.signatureConductor:this.signatureAjudant;o&&this.drawSignatureFromDataUrl(o),document.getElementById(ce.ACCEPT_BTN)?.focus()}closeSignatureModal(){this.signatureModalElement&&(Ve(!0),this.signatureModalElement.style.display="none",document.body.classList.remove(hn.MODAL_OPEN),this.currentSignatureTarget=null,(this.currentSignatureTarget==="person1"?this.signPerson1Button:this.signPerson2Button)?.focus())}isCanvasEmpty(){if(!this.canvasContext||!this.signatureCanvasElement)return!0;try{return!new Uint32Array(this.canvasContext.getImageData(0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height).data.buffer).some(n=>n!==0)}catch{return!1}}acceptSignature(){if(!this.canvasContext||!this.signatureCanvasElement||!this.currentSignatureTarget)return;let t=this.isCanvasEmpty(),n=t?"":this.signatureCanvasElement.toDataURL(le.IMAGE_FORMAT),o=null;this.currentSignatureTarget==="person1"?(this.signatureConductor=n,o=this.signPerson1Button):this.currentSignatureTarget==="person2"&&(this.signatureAjudant=n,o=this.signPerson2Button),this.updateSignatureUI(o,!t),this.closeSignatureModal(),Y()}drawSignatureFromDataUrl(t){if(!this.canvasContext||!t)return;let n=new Image;n.onload=()=>this.canvasContext.drawImage(n,0,0,this.signatureCanvasElement.width,this.signatureCanvasElement.height),n.onerror=()=>{},n.src=t}updateSignatureUI(t,n){if(!t)return;let o=t.querySelector(".icon");o&&(t.classList.toggle(hn.SIGNED,n),o.src=n?Ko.SIGNATURE_OK:Ko.SIGNATURE_PENDING)}updateSignatureIcons(){this.updateSignatureUI(this.signPerson1Button,!!this.signatureConductor),this.updateSignatureUI(this.signPerson2Button,!!this.signatureAjudant)}getSignatureConductor(){return this.signatureConductor}getSignatureAjudant(){return this.signatureAjudant}setSignatureConductor(t){this.signatureConductor=t||"",this.updateSignatureUI(this.signPerson1Button,!!this.signatureConductor)}setSignatureAjudant(t){this.signatureAjudant=t||"",this.updateSignatureUI(this.signPerson2Button,!!this.signatureAjudant)}},ct=new In,Jo=()=>ct.init(),yt=()=>ct.getSignatureConductor(),Ct=()=>ct.getSignatureAjudant(),Nt=e=>ct.setSignatureConductor(e),Dt=e=>ct.setSignatureAjudant(e);var Us=".service",Zo="main-content",k={DATE:"date",DIET_TYPE:"diet-type",VEHICLE:"vehicle-number",P1:"person1",P2:"person2",SERVICE_TYPE:"service-type",SAVE_BTN:"save-diet"},Gs="userSelectedServiceType",Vs={serviceNumber:".service-number",origin:".origin",originTime:".origin-time",destination:".destination",destinationTime:".destination-time",endTime:".end-time"},Fs="chip-active",ks=800,Hs=1e3,$s=300,_n=class{constructor(){this.initialFormDataStr="",this.saveStart=0,this.debouncedAutoSave=it(this.triggerAutoSave.bind(this),Hs),this.debouncedHandler=it(this.handleInputChange.bind(this),ks)}isFormReadyForSave(){try{let t=!!document.getElementById(k.DATE)?.value.trim(),n=!!document.getElementById(k.DIET_TYPE)?.value.trim(),o=document.getElementById("service-number-1")?.value.trim(),i=/^\d{9}$/.test(o);return t&&n&&i}catch(t){return console.warn("[FormService] Error validant formulari:",t),!1}}hasPendingChanges(){return JSON.stringify(this.getFormDataObject()||{})!==this.initialFormDataStr}getFormDataObject(){try{let t={date:A(document.getElementById(k.DATE)?.value),dietType:A(document.getElementById(k.DIET_TYPE)?.value||Zt()),vehicleNumber:A(document.getElementById(k.VEHICLE)?.value),person1:A(document.getElementById(k.P1)?.value),person2:A(document.getElementById(k.P2)?.value),serviceType:A(document.getElementById(k.SERVICE_TYPE)?.value||"TSU"),signatureConductor:yt(),signatureAjudant:Ct()},n=Array.from(document.querySelectorAll(Us)).map((o,i)=>{let s={};for(let[r,c]of Object.entries(Vs))s[r]=A(o.querySelector(c)?.value);let a=o.querySelector(`.chip.${Fs}`);return s.mode=a?.dataset.mode||"3.6",s.notes=W[i]||"",s});return{generalData:t,servicesData:n}}catch(t){return console.error("[FormService] Error recollint dades:",t),null}}async triggerAutoSave(){if(!(!this.isFormReadyForSave()||!this.hasPendingChanges()))try{this.saveStart=Date.now(),It(),await vt();let t=Date.now()-this.saveStart;setTimeout(_t,Math.max(0,$s-t)),this.initialFormDataStr=JSON.stringify(this.getFormDataObject()||{})}catch(t){console.warn("[Autosave skipped]",t?.message||"Error desconegut"),ot("Revisa dades de Serveis")}}captureInitialFormState(){this.initialFormDataStr=JSON.stringify(this.getFormDataObject()||{}),this.handleFormChange()}setSaveButtonState(t){let n=document.getElementById(k.SAVE_BTN);n&&(n.disabled=!t,n.setAttribute("aria-disabled",t?"false":"true"),n.classList.toggle("is-disabled",!t))}handleFormChange(){if(this.debouncedAutoSave.cancel(),!this.hasPendingChanges()){this.setSaveButtonState(!1),ye();return}this.isFormReadyForSave()?(this.setSaveButtonState(!0),this.debouncedAutoSave()):(this.setSaveButtonState(!1),ye())}handleInputChange(){this.handleFormChange()}addInputListeners(){let t=document.getElementById(Zo);if(!t)return;t.addEventListener("input",this.debouncedHandler),t.addEventListener("change",this.debouncedHandler),t.addEventListener("blur",o=>{o.target.matches("input, select, textarea")&&(this.handleFormChange(),this.isFormReadyForSave()&&this.hasPendingChanges()&&(this.debouncedAutoSave.cancel(),this.triggerAutoSave()))},!0);let n=document.getElementById(k.DATE);n?.addEventListener("change",()=>{n.blur(),this.debouncedHandler()}),window.addEventListener("beforeunload",()=>{this.debouncedAutoSave.cancel(),this.isFormReadyForSave()&&vt()})}addServiceTypeListener(){let t=document.getElementById(k.SERVICE_TYPE);t&&t.addEventListener("change",n=>{let o=n.target.value.trim();Le(o);try{localStorage.setItem(Gs,o)}catch(i){console.error("No s\u2019ha pogut desar tipus servei",i)}})}cancelPendingAutoSave(){this.debouncedAutoSave.cancel()}addDoneBehavior(){document.getElementById(Zo)?.addEventListener("keydown",n=>{n.key==="Enter"&&n.target.matches('input[enterkeyhint="done"]')&&(n.preventDefault(),n.target.blur())})}gatherAllData(){return this.getFormDataObject()}getInitialFormDataStr(){return this.initialFormDataStr}},de=new _n,fe=()=>de.captureInitialFormState(),nn=e=>de.setSaveButtonState(e),Y=()=>de.handleFormChange(),ei=()=>de.addInputListeners(),ti=()=>de.addServiceTypeListener(),vo=()=>de.cancelPendingAutoSave(),ni=()=>de.addDoneBehavior(),Lt=()=>de.gatherAllData();var oi="onboardingCompleted";function ii(){let e=document.getElementById("onboarding-container");if(!e)return;if(!JSON.parse(localStorage.getItem(oi)||"false"))e.classList.remove("hidden");else return;window.addEventListener("load",()=>{e.classList.add("onboarding-loaded")});let n=document.querySelectorAll(".onboarding-slide"),o=document.querySelectorAll(".nav-dot"),i=document.getElementById("onboarding-finish-btn"),s=document.getElementById("onboarding-skip-btn"),a=0;function r(p){n.forEach((v,P)=>{v.classList.toggle("active",P===p)}),o.forEach((v,P)=>{v.classList.toggle("active",P===p)})}function c(){a<n.length-1&&(a++,r(a),navigator.vibrate&&navigator.vibrate(10))}function l(){e.classList.add("hidden"),localStorage.setItem(oi,JSON.stringify(!0)),navigator.vibrate&&navigator.vibrate([50,50,50])}e.addEventListener("click",p=>{p.target.closest("button, a, .nav-dot")||c()});let u=0;e.addEventListener("touchstart",p=>{u=p.changedTouches[0].screenX},{passive:!0}),e.addEventListener("touchend",p=>{p.changedTouches[0].screenX<u-50&&c()}),i.addEventListener("click",l),s.addEventListener("click",l)}var vn={TOGGLE_BTN:"theme-toggle-btn",THEME_ICON:"theme-icon",THEME_TEXT:"theme-btn-text"},si={DARK_THEME:"theme-dark"},An="themePreference",G={LIGHT:"light",DARK:"dark"},ri={LIGHT:"assets/icons/moon.svg",DARK:"assets/icons/sun.svg"},ai={LIGHT:"#004aad",DARK:"#343a40"},Nn=class{constructor(){this.themeToggleButton=null,this.themeIconElement=null,this.themeTextElement=null,this.bodyElement=null,this.systemDarkMatcher=null}init(){if(this.themeToggleButton=document.getElementById(vn.TOGGLE_BTN),this.themeIconElement=document.getElementById(vn.THEME_ICON),this.themeTextElement=document.getElementById(vn.THEME_TEXT),this.bodyElement=document.body,!this.themeToggleButton||!this.themeIconElement||!this.themeTextElement||!this.bodyElement){console.warn("Faltan elementos del DOM para el gestor de temas.");return}let t,n=localStorage.getItem(An);n&&(n===G.LIGHT||n===G.DARK)?t=n:(this.systemDarkMatcher=window.matchMedia("(prefers-color-scheme: dark)"),t=this.systemDarkMatcher.matches?G.DARK:G.LIGHT,this.systemDarkMatcher.addEventListener("change",this._handleSystemThemeChange.bind(this))),this._applyTheme(t,!1),this.themeToggleButton.addEventListener("click",this._handleThemeToggle.bind(this))}_updateThemeColorMeta(t){let n=document.querySelector('meta[name="theme-color"]');n&&(n.content=t)}_applyTheme(t,n=!1){let o=t===G.DARK;this.bodyElement.classList.toggle(si.DARK_THEME,o),this.themeIconElement.src=o?ri.DARK:ri.LIGHT,this.themeTextElement.textContent=o?"Claro":"Oscuro",this.themeIconElement.alt=o?"Cambiar a tema claro":"Cambiar a tema oscuro",this._updateThemeColorMeta(o?ai.DARK:ai.LIGHT),n&&localStorage.setItem(An,t)}_handleThemeToggle(){let n=(this.bodyElement.classList.contains(si.DARK_THEME)?G.DARK:G.LIGHT)===G.DARK?G.LIGHT:G.DARK;this._applyTheme(n,!0)}_handleSystemThemeChange(t){if(!localStorage.getItem(An)){let n=t.matches?G.DARK:G.LIGHT;this._applyTheme(n,!1)}}},qs=new Nn,ci=()=>qs.init();var Dn={GENERATE_PDF:".generate-pdf",SAVE_DIET:"#save-diet",MANAGE_DIETS:"#manage-diets"};function li(){let e=document.querySelector(Dn.GENERATE_PDF);e&&e.addEventListener("click",Mo);let t=document.getElementById(Dn.SAVE_DIET.substring(1));t&&t.addEventListener("click",So);let n=document.getElementById(Dn.MANAGE_DIETS.substring(1));n&&typeof pn=="function"&&n.addEventListener("click",pn)}var di="clear-selected-service",js=".service";function ui(){let e=document.getElementById(di);if(!e){console.warn(`Clear Service: Bot\xF3 amb ID '${di}' no trobat.`);return}e.addEventListener("click",()=>{let t=Ee(),n=document.querySelectorAll(js);if(t>=0&&t<n.length){let o=n[t],i=o.querySelectorAll('input:not([type="button"]):not([type="submit"]), select, textarea');i.forEach(s=>{s.value!==""&&s.classList.add("field-clearing")}),setTimeout(()=>{eo(o),Ze(o),Y(),i.forEach(s=>{s.classList.remove("field-clearing")}),console.log(`Servei ${t+1} netejat amb efecte visual.`)},600)}else console.warn(`Clear Service: \xCDndex de servei inv\xE0lid (${t}) o element no trobat.`)}),console.log("Funcionalitat 'Netejar Servei Seleccionat' configurada.")}function Ei(){document.querySelectorAll('input[type="date"]').forEach(t=>{t.dataset.pickerSetup!=="true"&&(t.dataset.pickerSetup="true",typeof t.showPicker=="function"&&t.addEventListener("click",()=>{try{t.showPicker()}catch{}}))})}function mi(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.dataset.pickerSetup!=="true"&&(t.dataset.pickerSetup="true",typeof t.showPicker=="function"&&t.addEventListener("click",()=>{try{t.showPicker()}catch{}}))})}var Ti=it(d,kn.DEBOUNCE_TOAST);function Ws(e){return/^\d*$/.test(e)}function fi(){let e=document.querySelectorAll(ve.SERVICE_NUMBER_INPUT);if(!e.length){console.warn("Restrictions: No se han encontrado inputs '.service-number'.");return}e.forEach(t=>{t.dataset.restrictionsSetup!=="true"&&(t.dataset.restrictionsSetup="true",t.addEventListener("keypress",n=>{n.key==="Enter"||n.key==="Tab"||n.ctrlKey||n.metaKey||n.altKey||n.key.length>1||/\d/.test(n.key)||(n.preventDefault(),Ti(kt.SERVICE_NUMBER_DIGITS_ONLY,"warning"))}),t.addEventListener("paste",n=>{try{let o=(n.clipboardData||window.clipboardData)?.getData("text")||"";Ws(o)||(n.preventDefault(),Ti(kt.SERVICE_NUMBER_DIGITS_ONLY,"warning"))}catch(o){console.error("Error procesando 'paste':",o),n.preventDefault()}}))})}var pi={SETTINGS_BTN:"settings",SETTINGS_PANEL:"settings-panel"},He={PANEL_VISIBLE:"visible",BUTTON_OPEN:"open"},Z=null,ee=null,gi=!1;function Ys(e){e.stopPropagation();let t=ee.classList.toggle(He.PANEL_VISIBLE);Z.classList.toggle(He.BUTTON_OPEN,t),Z.setAttribute("aria-expanded",t),t&&ee.querySelector("button")?.focus()}function zs(e){ee.classList.contains(He.PANEL_VISIBLE)&&!ee.contains(e.target)&&!Z.contains(e.target)&&Ln()}function Ks(e){e.key==="Escape"&&ee.classList.contains(He.PANEL_VISIBLE)&&(Ln(),Z.focus())}function Ln(){ee.classList.remove(He.PANEL_VISIBLE),Z.classList.remove(He.BUTTON_OPEN),Z.setAttribute("aria-expanded","false")}function Si(){gi||(Z=document.getElementById(pi.SETTINGS_BTN),ee=document.getElementById(pi.SETTINGS_PANEL),!(!Z||!ee)&&(Z.addEventListener("click",Ys),document.addEventListener("click",zs),document.addEventListener("keydown",Ks),ee.querySelectorAll("button").forEach(e=>{e.addEventListener("click",Ln)}),gi=!0))}var Qs={SERVICE_BUTTONS:".service-button:not(.active-square)",OPTIONS_BTN:"#options-toggle",TABS:".tab:not(.active)"},Js="disabled-control";function On(e=!0){document.querySelectorAll(Object.values(Qs).join(", ")).forEach(n=>{n&&(n.classList.toggle(Js,e),n.setAttribute("aria-disabled",e?"true":"false"),n.disabled=e)})}var Zs="spa",er=1,tr="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ:/-\xC0\xC9\xCD\xD3\xDA\xC8\xD2\xC0\xDC\xCF\xC7\xD1",yn=1500,Ni=.95,Di="image/png",hi=10,nr=300,or=1e3;var ir={tessedit_char_whitelist:tr,tessedit_pageseg_mode:6,load_system_dawg:!1,load_freq_dawg:!1},te={CAMERA_BTN:"camera-in-dropdown",CAMERA_MODAL:"camera-gallery-modal",MODAL_CONTENT:".modal-bottom-content",OPTION_CAMERA:"option-camera",OPTION_GALLERY:"option-gallery",CAMERA_INPUT:"camera-input",OCR_PROGRESS_CONTAINER:".ocr-progress-container",OCR_PROGRESS_TEXT:".ocr-progress-text",OCR_SCAN_BTN:".btn-ocr-inline"},H={VISIBLE:"visible",HIDDEN:"hidden",SERVICE_COLORS:["service-1","service-2","service-3","service-4"]},sr={ORIGIN_TIME:{id:"originTime",label:"Hora movilizaci\xF3n",fieldIdSuffix:"origin-time",lineKeywordRegex:/movilizaci|ltat|desplaza/i},DESTINATION_TIME:{id:"destinationTime",label:"Hora de llegada hospital",fieldIdSuffix:"destination-time",lineKeywordRegex:/arribada|hospital|aaah/i},END_TIME:{id:"endTime",label:"Hora Final",fieldIdSuffix:"end-time",valueRegex:/\d{2}\s*\/?\s*\d{2}\s*\/?\s*\d{2}\s+(\d{1,2}:\d{2}(?::\d{2})?)/i}},$=null,lt=null,wt=null,Cn=null,b=null,Rn=!1,Ii=!1,_i=!1,vi=0;function rr(e){if(!e)return"";let t=e.replace(/[^\d:\-]/g,"");t=t.replace(/-/g,":");let n=t.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);if(n){let o=parseInt(n[1],10),i=parseInt(n[2],10);if(o>=0&&o<=23&&i>=0&&i<=59)return`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`}return""}function ar(){if(Date.now()-vi<500||(vi=Date.now(),!$||!lt))return;document.body.classList.add("modal-open");let e=Ee(),t=H.SERVICE_COLORS[e]||"";lt.classList.remove(...H.SERVICE_COLORS),t&&lt.classList.add(t),$.classList.remove(H.HIDDEN),requestAnimationFrame(()=>$.classList.add(H.VISIBLE)),wt?.focus()}function Mt(){$&&(document.body.classList.remove("modal-open"),$.classList.remove(H.VISIBLE),setTimeout(()=>$.classList.add(H.HIDDEN),nr))}function cr(e){$?.classList.contains(H.VISIBLE)&&!lt?.contains(e.target)&&Mt()}function lr(){b&&(b.setAttribute("capture","environment"),b.click(),Mt())}function dr(){b&&(b.removeAttribute("capture"),b.click(),Mt())}function Li(){return document.querySelector(".service:not(.hidden)")}function V(e,t){let o=Li()?.querySelector(te.OCR_PROGRESS_CONTAINER);if(!o)return;o.classList.contains(H.HIDDEN)&&o.classList.remove(H.HIDDEN);let i=o.querySelector(te.OCR_PROGRESS_TEXT);i&&(i.textContent=t)}function ur(){let t=Li()?.querySelector(te.OCR_PROGRESS_CONTAINER);t&&setTimeout(()=>t.classList.add(H.HIDDEN),or)}async function Er(e){try{let t=await createImageBitmap(e),{width:n,height:o}=t;if(Math.max(n,o)<=yn)return t.close(),e;let i=Math.min(yn/n,yn/o),s=Math.round(n*i),a=Math.round(o*i),r=document.createElement("canvas");r.width=s,r.height=a;let c=r.getContext("2d");if(!c)throw new Error("No contexto 2D.");return c.drawImage(t,0,0,s,a),t.close(),new Promise(l=>r.toBlob(l,Di,Ni))}catch(t){throw d("Error al procesar la imagen.","error"),t}}async function mr(e){try{let t=await createImageBitmap(e),n=document.createElement("canvas");n.width=t.width,n.height=t.height;let o=n.getContext("2d");if(!o)throw new Error("No contexto 2D.");try{o.drawImage(t,0,0,t.width,t.height)}catch(i){throw i.message&&i.message.includes("detached")?new Error("Error al procesar la imagen. Int\xE9ntalo de nuevo."):i}t.close(),o.filter="grayscale(100%) contrast(180%) brightness(110%)";try{o.drawImage(n,0,0)}catch(i){console.warn("OCR: Fallback sense filtres:",i)}return new Promise(i=>n.toBlob(i,Di,Ni))}catch(t){throw t.message.includes("procesar la imagen")?d(t.message,"error"):t.message.includes("detached")?d("La imagen no se puede procesar. Int\xE9ntalo con otra foto.","error"):d("Error al procesar la imagen. Int\xE9ntalo de nuevo.","error"),t}}function Ai(e,t,n){let o=document.getElementById(e);if(o){o.value=t;let i=new Event("input",{bubbles:!0,cancelable:!0});o.dispatchEvent(i)}}function Tr(e){if(!e||!e.trim()){d("No se reconoci\xF3 texto.","warning");return}let t=Ee(),n=Zn(t)||"3.6",o=`-${t+1}`,i={},s=e.split(`
`),a=e.toLowerCase().replace(/ +/g," ");if(Object.values(sr).forEach(c=>{if((n==="3.11"||n==="3.22")&&c.id==="destinationTime")return;let l=null;if(c.lineKeywordRegex){for(let u of s)if(c.lineKeywordRegex.test(u.toLowerCase())){let p=u.replace(/\D/g,"");if(p.length>=6){let v=p.slice(-6);l=[null,`${v.slice(0,2)}:${v.slice(2,4)}:${v.slice(4,6)}`];break}}}else c.valueRegex&&(l=a.match(c.valueRegex));if(l&&l[1]){let u=rr(l[1].trim());if(u&&!i[c.id]){let p=`${c.fieldIdSuffix}${o}`;Ai(p,u,c.label),i[c.id]=c}}}),!i.endTime&&(i.originTime||i.destinationTime)){let c=new Date,l=String(c.getHours()).padStart(2,"0"),u=String(c.getMinutes()).padStart(2,"0"),p=`${l}:${u}`,v=`end-time${o}`;Ai(v,p,"Hora Final (Actual)");let P=document.getElementById(v);P&&(P.classList.add("input-warning"),P.addEventListener("focus",()=>P.classList.remove("input-warning"),{once:!0}))}if(Object.keys(i).length>0){let c=Object.values(i).map(l=>l.label);d(`Campos actualizados: ${c.join(", ")}.`,"success")}else d("No se encontraron horas relevantes.","info")}function Oi(){if(Ii||($=document.getElementById(te.CAMERA_MODAL),lt=$?.querySelector(te.MODAL_CONTENT),wt=document.getElementById(te.OPTION_CAMERA),Cn=document.getElementById(te.OPTION_GALLERY),b=document.getElementById(te.CAMERA_INPUT),!$||!wt||!Cn||!b))return;document.querySelectorAll(te.OCR_SCAN_BTN).forEach(t=>t.addEventListener("click",ar)),wt.addEventListener("click",lr),Cn.addEventListener("click",dr),b.addEventListener("change",pr),document.addEventListener("click",cr),document.addEventListener("keydown",t=>{t.key==="Escape"&&$?.classList.contains(H.VISIBLE)&&Mt()}),Ii=!0}function fr(){window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}async function pr(e){if(Rn){d("Proceso OCR ya en marcha.","warning");return}let t=e.target.files?.[0];if(!t)return;if(!t.type.startsWith("image/")){d("Selecciona una imagen.","error"),b&&(b.value="");return}let n=hi*1024*1024;if(t.size>n){d(`La imagen es demasiado grande (m\xE1x. ${hi} MB).`,"error"),b&&(b.value="");return}Rn=!0,On(!0),V(0,"Preparando imagen..."),fr();let o=null;try{V(2,"Analizando imagen...");let i=await Er(t);V(15,"Eliminando metadades..."),i=await mr(i),V(30,"Mejorando la imagen..."),await new Promise(a=>setTimeout(a,100)),V(40,"Cargando motor OCR..."),_i||await new Promise((a,r)=>{let c=document.createElement("script");Re(c),c.src="https://cdn.jsdelivr.net/npm/tesseract.js@6/dist/tesseract.min.js",c.onload=()=>{_i=!0,a()},c.onerror=r,document.head.appendChild(c)}),V(60,"Cargando modelo de idioma..."),o=await Tesseract.createWorker(Zs,er,{logger:a=>{if(a.status==="recognizing text"){let r=Math.max(70,Math.floor(a.progress*100*.3+70));V(r,`Reconociendo texto ${Math.floor(a.progress*100)}%...`)}else a.status==="loading language model"&&V(70,"Cargando modelo de idioma...")}}),V(80,"Configurando OCR..."),await o.setParameters(ir),V(85,"Iniciando reconocimiento...");let{data:{text:s}}=await o.recognize(i);V(100,"An\xE1lisis completado."),Tr(s)}catch(i){let s="Error al escanear. Int\xE9ntalo de nuevo.";i.message&&i.message.includes("detached")?s="Error al procesar la imagen. Int\xE9ntalo con otra foto.":i.message&&i.message.includes("recognition")&&(s="No se pudo leer el texto. Aseg\xFArate de que la imagen sea clara."),d(s,"error"),V(0,"Error en el escaneo.")}finally{o&&await o.terminate(),b&&(b.value=""),ur(),On(!1),Rn=!1}}var yi="anonymousUserId";function Ci(){try{let e=localStorage.getItem(yi);return e||(e=`user-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,localStorage.setItem(yi,e)),e}catch{return`temp-user-${Date.now()}`}}var Ri=document.getElementById("save-pill"),Xe=document.querySelector(".tab-content-container"),$e=0,bi=!1,gr=10,Sr=150,hr=Xe&&parseInt(window.getComputedStyle(Xe).paddingBottom,10)||60;function bn(e=$e){bi=e>Sr,bi?(Ri.style.bottom=`calc(${e}px + ${gr}px + env(safe-area-inset-bottom, 0px))`,Xe&&(Xe.style.paddingBottom=`${e+50}px`)):(Ri.style.bottom="calc(20px + env(safe-area-inset-bottom, 0px))",Xe&&(Xe.style.paddingBottom=`${hr}px`))}if("virtualKeyboard"in navigator)navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",e=>{$e=e.target.boundingRect.height,bn($e)});else{let e=window.innerHeight;window.addEventListener("resize",()=>{window.innerHeight<e?($e=e-window.innerHeight,bn($e)):($e=0,bn(0))})}var Ir=document.querySelectorAll('input:not([type="checkbox"]), select, textarea');function _r(e){let t=e.target;t.closest(".modal")||setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"center"})},250)}Ir.forEach(e=>{e.addEventListener("focus",_r)});var Bi="notes-selected-service",vr="notes-modal",Ar="notes-title",Nr="notes-textarea",Dr="notes-save",Lr="notes-cancel",Or="notes-char-counter",qe,Pn,_,xt,Bn,Ie,dt=null,ut=null,Et=null;function Pi(){let e=document.getElementById(Bi);if(!e){console.warn(`Notes Service: Bot\xF3 amb ID '${Bi}' no trobat.`);return}if(qe=document.getElementById(vr),Pn=document.getElementById(Ar),_=document.getElementById(Nr),xt=document.getElementById(Dr),Bn=document.getElementById(Lr),Ie=document.getElementById(Or),!qe||!Pn||!_||!xt||!Bn||!Ie){console.error("Notes Service: Un o m\xE9s elements del modal de notes no s'han trobat.");return}e.addEventListener("click",()=>{let t=Ee();yr(t)}),Bn.addEventListener("click",wn),console.log("Funcionalitat 'Afegir Notes' configurada.")}function yr(e){if(!qe)return;Pn.textContent=`S${e+1}: Observaciones`,_.value=W[e]||"";let t=_.maxLength,n=()=>{let o=_.value.length;Ie.textContent=`${o} / ${t}`,Ie.classList.remove("warning","limit"),_.classList.remove("input-warning","input-error"),o>=t?(Ie.classList.add("limit"),_.classList.add("input-error")):o>t*.8&&(Ie.classList.add("warning"),_.classList.add("input-warning"))};n(),ut=()=>{_.value.length>t&&(_.value=_.value.slice(0,t)),n()},_.addEventListener("input",ut),Et=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),_.blur())},_.addEventListener("keydown",Et),dt=()=>{let o=_.value.trim(),i=W[e]||"";if(o===i){wn();return}W[e]=o,o?d("Observaci\xF3n guardada.","success"):d("Observaci\xF3n eliminada.","info"),wn(),Y()},xt.addEventListener("click",dt),qe.style.display="block",document.body.classList.add("modal-open"),setTimeout(()=>{_.focus({preventScroll:!0}),_.setSelectionRange(_.value.length,_.value.length)},0)}function wn(){qe&&(dt&&(xt.removeEventListener("click",dt),dt=null),ut&&(_.removeEventListener("input",ut),ut=null),Et&&(_.removeEventListener("keydown",Et),Et=null),Ie.classList.remove("warning","limit"),_.classList.remove("input-warning","input-error"),qe.style.display="none",document.body.classList.remove("modal-open"))}var Cr=e=>{let n=`; ${document.cookie}`.split(`; ${e}=`);if(n.length===2)return n.pop()?.split(";").shift()},wi=(e,t,n)=>{let o=new Date;o.setTime(o.getTime()+n*24*60*60*1e3);let i=`expires=${o.toUTCString()}`;document.cookie=`${e}=${t};${i};path=/;SameSite=Lax;Secure`},je,Mn,xn;function Rr(){let e=document.createElement("script");Re(e),e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-23SXKMLR75",document.head.appendChild(e),e.onload=()=>{window.gtag("js",new Date),window.gtag("config","G-23SXKMLR75")}}function br(){Rr(),wi("cookie_consent","granted",365),Mi()}function Br(){typeof window.gtag=="function"&&window.gtag("consent","update",{analytics_storage:"denied"}),wi("cookie_consent","denied",365),Mi()}function Pr(){je&&je.classList.remove("hidden")}function Mi(){je&&je.classList.add("hidden")}function xi(){if(je=document.getElementById("cookie-consent-banner"),Mn=document.getElementById("accept-cookies"),xn=document.getElementById("decline-cookies"),!je||!Mn||!xn){console.warn("Elements del b\xE0ner de cookies no trobats.");return}Cr("cookie_consent")||(Pr(),Mn.addEventListener("click",br),xn.addEventListener("click",Br))}function wr(){let e=document.getElementById(m.DONATION_LINK_ID);if(!e)return console.warn("No s'ha trobat l'enlla\xE7 de donaci\xF3.");let t=Ci();try{let n=new URL(e.href);n.searchParams.set("custom",t),e.href=n.toString(),console.log("Enlla\xE7 de donaci\xF3 actualitzat amb ID an\xF2nim.")}catch(n){console.error("Error modificant l'URL de donaci\xF3:",n)}}function Mr(){let e=document.getElementById("offline-indicator");if(!e)return;let t=()=>{e.hidden=!navigator.onLine};t(),window.addEventListener("online",t),window.addEventListener("offline",t)}async function Ui(){try{console.log("initializeApp() iniciant..."),Eo(),To(),await ao(),Jn(),Jo(),we.init(),Oi(),ii(),Wo(),li(),ui(),Pi(),Ho(),Ei(),mi(),Si(),ci(),wr(),fi(),zn(),ei(),ti(),ni();let e=document.getElementById("service-type");if(e){let t=localStorage.getItem($n.USER_SELECTED_SERVICE_TYPE);(t==="TSU"||t==="TSNU")&&(e.value=t,console.log(`[LocalStorage] Carregat tipus de servei: ${t}`)),Le(e.value)}fe(),fo(),xi(),Mr(),console.log("initializeApp() completada.")}catch(e){console.error("Error en la inicialitzaci\xF3 de l'app:",e)}}async function Gi(){try{document.body.classList.add("app-ready"),document.body.classList.remove("no-js"),await Ui(),yo()}catch(e){console.error("Critical error during app startup:",e)}}function xr(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Gi,{once:!0}):Gi()}xr();})();
